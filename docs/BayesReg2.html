<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Session 7 Bayesian Regression II | HAD5314H - Applied Bayesian Methods in Clinical Epidemiology and Health Care Research</title>
  <meta name="description" content="Course notes for HAD5314H Winter 2022" />
  <meta name="generator" content="bookdown 0.25 and GitBook 2.6.7" />

  <meta property="og:title" content="Session 7 Bayesian Regression II | HAD5314H - Applied Bayesian Methods in Clinical Epidemiology and Health Care Research" />
  <meta property="og:type" content="book" />
  
  <meta property="og:description" content="Course notes for HAD5314H Winter 2022" />
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Session 7 Bayesian Regression II | HAD5314H - Applied Bayesian Methods in Clinical Epidemiology and Health Care Research" />
  
  <meta name="twitter:description" content="Course notes for HAD5314H Winter 2022" />
  

<meta name="author" content="Kuan Liu   Institute of Health Policy, Management and Evaluation   University of Toronto" />


<meta name="date" content="2022-03-29" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="BayesReg1.html"/>
<link rel="next" href="BayesMeta.html"/>
<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />








<link href="libs/anchor-sections-1.1.0/anchor-sections.css" rel="stylesheet" />
<link href="libs/anchor-sections-1.1.0/anchor-sections-hash.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.1.0/anchor-sections.js"></script>
<script src="libs/htmlwidgets-1.5.4/htmlwidgets.js"></script>
<link href="libs/datatables-css-0.0.0/datatables-crosstalk.css" rel="stylesheet" />
<script src="libs/datatables-binding-0.22/datatables.js"></script>
<link href="libs/dt-core-1.11.3/css/jquery.dataTables.min.css" rel="stylesheet" />
<link href="libs/dt-core-1.11.3/css/jquery.dataTables.extra.css" rel="stylesheet" />
<script src="libs/dt-core-1.11.3/js/jquery.dataTables.min.js"></script>
<link href="libs/crosstalk-1.2.0/css/crosstalk.min.css" rel="stylesheet" />
<script src="libs/crosstalk-1.2.0/js/crosstalk.min.js"></script>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<style type="text/css">
/* Used with Pandoc 2.11+ new --citeproc when CSL is used */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
}
.hanging div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}
</style>

<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">HAD5314H - Winter 2022 </a></li>

<li class="divider"></li>
<li><a href="index.html#university-of-toronto-statement-of-acknowledgment-of-traditional-land">University of Toronto Statement of Acknowledgment of Traditional Land<span></span></a></li>
<li><a href="course-syllabus.html#course-syllabus">Course Syllabus<span></span></a>
<ul>
<li><a href="course-syllabus.html#course-info">Course Info<span></span></a></li>
<li><a href="course-syllabus.html#course-description">Course Description<span></span></a></li>
<li><a href="course-syllabus.html#course-textbook-and-structure">Course Textbook and Structure<span></span></a></li>
<li><a href="course-syllabus.html#calendar-and-outline">Calendar and Outline<span></span></a></li>
<li><a href="course-syllabus.html#accessibility-and-accommodations">Accessibility and Accommodations<span></span></a></li>
<li><a href="course-syllabus.html#academic-integrity">Academic Integrity<span></span></a></li>
<li><a href="course-syllabus.html#key-resources-and-supports-for-dslph-graduate-students">Key Resources and Supports for DSLPH Graduate Students<span></span></a></li>
<li><a href="course-syllabus.html#license">License<span></span></a></li>
</ul></li>
<li class="chapter" data-level="1" data-path="into.html"><a href="into.html"><i class="fa fa-check"></i><b>1</b> Introduction to the course<span></span></a>
<ul>
<li class="chapter" data-level="1.1" data-path="into.html"><a href="into.html#about-me"><i class="fa fa-check"></i><b>1.1</b> About me<span></span></a></li>
<li class="chapter" data-level="1.2" data-path="into.html"><a href="into.html#syllabus"><i class="fa fa-check"></i><b>1.2</b> Syllabus<span></span></a></li>
<li class="chapter" data-level="1.3" data-path="into.html"><a href="into.html#some-history"><i class="fa fa-check"></i><b>1.3</b> Some history<span></span></a>
<ul>
<li class="chapter" data-level="1.3.1" data-path="into.html"><a href="into.html#bayesian-history"><i class="fa fa-check"></i><b>1.3.1</b> Bayesian history<span></span></a></li>
<li class="chapter" data-level="1.3.2" data-path="into.html"><a href="into.html#history-of-this-course"><i class="fa fa-check"></i><b>1.3.2</b> History of this course<span></span></a></li>
</ul></li>
<li class="chapter" data-level="1.4" data-path="into.html"><a href="into.html#thinking-like-a-bayesian-using-the-concept-of-probability"><i class="fa fa-check"></i><b>1.4</b> Thinking like a Bayesian using the concept of probability<span></span></a>
<ul>
<li class="chapter" data-level="1.4.1" data-path="into.html"><a href="into.html#probability-is-not-unitary"><i class="fa fa-check"></i><b>1.4.1</b> Probability is not unitary<span></span></a></li>
<li class="chapter" data-level="1.4.2" data-path="into.html"><a href="into.html#bayes-rule"><i class="fa fa-check"></i><b>1.4.2</b> Bayes’ Rule<span></span></a></li>
<li class="chapter" data-level="1.4.3" data-path="into.html"><a href="into.html#the-scientific-method-in-steps"><i class="fa fa-check"></i><b>1.4.3</b> The Scientific Method in steps<span></span></a></li>
</ul></li>
</ul></li>
<li><a href="lab1-getting-started-with-r-rstudio.html#lab1-getting-started-with-r-rstudio">Lab1 Getting started with R &amp; RStudio<span></span></a>
<ul>
<li class="chapter" data-level="1.5" data-path="lab1-getting-started-with-r-rstudio.html"><a href="lab1-getting-started-with-r-rstudio.html"><i class="fa fa-check"></i><b>1.5</b> R and RStudio Installation<span></span></a>
<ul>
<li class="chapter" data-level="1.5.1" data-path="lab1-getting-started-with-r-rstudio.html"><a href="lab1-getting-started-with-r-rstudio.html#windows-operating-system"><i class="fa fa-check"></i><b>1.5.1</b> Windows operating system<span></span></a></li>
<li class="chapter" data-level="1.5.2" data-path="lab1-getting-started-with-r-rstudio.html"><a href="lab1-getting-started-with-r-rstudio.html#macos-operating-system"><i class="fa fa-check"></i><b>1.5.2</b> macOS operating system<span></span></a></li>
</ul></li>
<li class="chapter" data-level="1.6" data-path="lab1-getting-started-with-r-rstudio.html"><a href="lab1-getting-started-with-r-rstudio.html#r-packages"><i class="fa fa-check"></i><b>1.6</b> R Packages<span></span></a>
<ul>
<li class="chapter" data-level="1.6.1" data-path="lab1-getting-started-with-r-rstudio.html"><a href="lab1-getting-started-with-r-rstudio.html#bayesian-analysis-in-r-using-brms-package"><i class="fa fa-check"></i><b>1.6.1</b> Bayesian Analysis in R using brms package<span></span></a></li>
</ul></li>
<li class="chapter" data-level="1.7" data-path="lab1-getting-started-with-r-rstudio.html"><a href="lab1-getting-started-with-r-rstudio.html#working-in-rstudio"><i class="fa fa-check"></i><b>1.7</b> Working in RStudio<span></span></a>
<ul>
<li class="chapter" data-level="1.7.1" data-path="lab1-getting-started-with-r-rstudio.html"><a href="lab1-getting-started-with-r-rstudio.html#rstudio-layout"><i class="fa fa-check"></i><b>1.7.1</b> RStudio layout<span></span></a></li>
<li class="chapter" data-level="1.7.2" data-path="lab1-getting-started-with-r-rstudio.html"><a href="lab1-getting-started-with-r-rstudio.html#customization"><i class="fa fa-check"></i><b>1.7.2</b> Customization<span></span></a></li>
<li class="chapter" data-level="1.7.3" data-path="lab1-getting-started-with-r-rstudio.html"><a href="lab1-getting-started-with-r-rstudio.html#working-directory"><i class="fa fa-check"></i><b>1.7.3</b> Working directory<span></span></a></li>
<li class="chapter" data-level="1.7.4" data-path="lab1-getting-started-with-r-rstudio.html"><a href="lab1-getting-started-with-r-rstudio.html#getting-help-with-r"><i class="fa fa-check"></i><b>1.7.4</b> Getting help with R<span></span></a></li>
</ul></li>
<li class="chapter" data-level="1.8" data-path="lab1-getting-started-with-r-rstudio.html"><a href="lab1-getting-started-with-r-rstudio.html#basic-r-a-crash-introduction"><i class="fa fa-check"></i><b>1.8</b> Basic R (a crash introduction)<span></span></a>
<ul>
<li class="chapter" data-level="1.8.1" data-path="lab1-getting-started-with-r-rstudio.html"><a href="lab1-getting-started-with-r-rstudio.html#arithmetic"><i class="fa fa-check"></i><b>1.8.1</b> Arithmetic<span></span></a></li>
<li class="chapter" data-level="1.8.2" data-path="lab1-getting-started-with-r-rstudio.html"><a href="lab1-getting-started-with-r-rstudio.html#vectors"><i class="fa fa-check"></i><b>1.8.2</b> Vectors<span></span></a></li>
<li class="chapter" data-level="1.8.3" data-path="lab1-getting-started-with-r-rstudio.html"><a href="lab1-getting-started-with-r-rstudio.html#data-frame---the-titanic-dataset"><i class="fa fa-check"></i><b>1.8.3</b> Data frame - The Titanic dataset<span></span></a></li>
<li class="chapter" data-level="1.8.4" data-path="lab1-getting-started-with-r-rstudio.html"><a href="lab1-getting-started-with-r-rstudio.html#simple-plots"><i class="fa fa-check"></i><b>1.8.4</b> Simple plots<span></span></a></li>
<li><a href="lab1-getting-started-with-r-rstudio.html#r-session-information">R Session information<span></span></a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="2" data-path="prob.html"><a href="prob.html"><i class="fa fa-check"></i><b>2</b> Probability, random variables and distributions<span></span></a>
<ul>
<li class="chapter" data-level="2.1" data-path="prob.html"><a href="prob.html#probability"><i class="fa fa-check"></i><b>2.1</b> Probability<span></span></a>
<ul>
<li class="chapter" data-level="2.1.1" data-path="prob.html"><a href="prob.html#venn-diagrams"><i class="fa fa-check"></i><b>2.1.1</b> Venn Diagrams<span></span></a></li>
<li class="chapter" data-level="2.1.2" data-path="prob.html"><a href="prob.html#probability-rules"><i class="fa fa-check"></i><b>2.1.2</b> Probability Rules<span></span></a></li>
<li class="chapter" data-level="2.1.3" data-path="prob.html"><a href="prob.html#how-to-define-and-assign-probabilities-in-general"><i class="fa fa-check"></i><b>2.1.3</b> How to define and assign probabilities in general?<span></span></a></li>
</ul></li>
<li class="chapter" data-level="2.2" data-path="prob.html"><a href="prob.html#probability-distributions"><i class="fa fa-check"></i><b>2.2</b> Probability Distributions<span></span></a>
<ul>
<li class="chapter" data-level="2.2.1" data-path="prob.html"><a href="prob.html#probability-density-functions"><i class="fa fa-check"></i><b>2.2.1</b> Probability density functions<span></span></a></li>
<li class="chapter" data-level="2.2.2" data-path="prob.html"><a href="prob.html#discrete-distributions"><i class="fa fa-check"></i><b>2.2.2</b> Discrete Distributions<span></span></a></li>
<li class="chapter" data-level="2.2.3" data-path="prob.html"><a href="prob.html#continous-distributions"><i class="fa fa-check"></i><b>2.2.3</b> Continous Distributions<span></span></a></li>
<li><a href="prob.html#r-session-information-1">R Session information<span></span></a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="3" data-path="bayes.html"><a href="bayes.html"><i class="fa fa-check"></i><b>3</b> Introduction to Bayesian inference<span></span></a>
<ul>
<li class="chapter" data-level="3.1" data-path="bayes.html"><a href="bayes.html#classical-frequentist-approach"><i class="fa fa-check"></i><b>3.1</b> Classical frequentist approach<span></span></a></li>
<li class="chapter" data-level="3.2" data-path="bayes.html"><a href="bayes.html#introduction-to-bayesian-approach"><i class="fa fa-check"></i><b>3.2</b> Introduction to Bayesian approach<span></span></a>
<ul>
<li class="chapter" data-level="3.2.1" data-path="bayes.html"><a href="bayes.html#review-from-session-1"><i class="fa fa-check"></i><b>3.2.1</b> Review from session 1<span></span></a></li>
<li class="chapter" data-level="3.2.2" data-path="bayes.html"><a href="bayes.html#the-beta-binomial-model"><i class="fa fa-check"></i><b>3.2.2</b> The Beta-binomial model<span></span></a></li>
<li class="chapter" data-level="3.2.3" data-path="bayes.html"><a href="bayes.html#the-normal-normal-model"><i class="fa fa-check"></i><b>3.2.3</b> The Normal-normal model<span></span></a></li>
</ul></li>
<li class="chapter" data-level="3.3" data-path="bayes.html"><a href="bayes.html#summary-of-conjugate-priors-models"><i class="fa fa-check"></i><b>3.3</b> Summary of Conjugate priors &amp; models<span></span></a></li>
<li class="chapter" data-level="3.4" data-path="bayes.html"><a href="bayes.html#why-bayesian-statistical-estimation-revisit"><i class="fa fa-check"></i><b>3.4</b> Why Bayesian: Statistical Estimation Revisit<span></span></a>
<ul>
<li class="chapter" data-level="3.4.1" data-path="bayes.html"><a href="bayes.html#classic-frequentist-inference"><i class="fa fa-check"></i><b>3.4.1</b> Classic Frequentist Inference<span></span></a></li>
<li class="chapter" data-level="3.4.2" data-path="bayes.html"><a href="bayes.html#bayesian-inference"><i class="fa fa-check"></i><b>3.4.2</b> Bayesian Inference<span></span></a></li>
<li><a href="bayes.html#r-session-information-2">R Session information<span></span></a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="4" data-path="Prior.html"><a href="Prior.html"><i class="fa fa-check"></i><b>4</b> Prior Distributions<span></span></a>
<ul>
<li class="chapter" data-level="4.1" data-path="Prior.html"><a href="Prior.html#choosing-priors"><i class="fa fa-check"></i><b>4.1</b> Choosing priors<span></span></a>
<ul>
<li class="chapter" data-level="4.1.1" data-path="Prior.html"><a href="Prior.html#eliciting-priors-from-experts"><i class="fa fa-check"></i><b>4.1.1</b> Eliciting priors from experts<span></span></a></li>
</ul></li>
<li class="chapter" data-level="4.2" data-path="Prior.html"><a href="Prior.html#default-clincial-priors"><i class="fa fa-check"></i><b>4.2</b> Default clincial priors<span></span></a>
<ul>
<li class="chapter" data-level="4.2.1" data-path="Prior.html"><a href="Prior.html#non-informative-or-reference-priors"><i class="fa fa-check"></i><b>4.2.1</b> “Non-informative” or “reference” priors<span></span></a></li>
<li class="chapter" data-level="4.2.2" data-path="Prior.html"><a href="Prior.html#minimally-informative-prior"><i class="fa fa-check"></i><b>4.2.2</b> Minimally informative prior<span></span></a></li>
<li class="chapter" data-level="4.2.3" data-path="Prior.html"><a href="Prior.html#skeptical-prior"><i class="fa fa-check"></i><b>4.2.3</b> Skeptical Prior<span></span></a></li>
<li class="chapter" data-level="4.2.4" data-path="Prior.html"><a href="Prior.html#optimisticenthusiastic-prior"><i class="fa fa-check"></i><b>4.2.4</b> Optimistic/enthusiastic Prior<span></span></a></li>
<li class="chapter" data-level="4.2.5" data-path="Prior.html"><a href="Prior.html#evaluating-priors"><i class="fa fa-check"></i><b>4.2.5</b> Evaluating Priors?<span></span></a></li>
</ul></li>
<li class="chapter" data-level="4.3" data-path="Prior.html"><a href="Prior.html#historical-data-meta-analysis"><i class="fa fa-check"></i><b>4.3</b> Historical data (meta-analysis)<span></span></a></li>
<li class="chapter" data-level="4.4" data-path="Prior.html"><a href="Prior.html#hierarchical-priors-and-shrinkage-priors"><i class="fa fa-check"></i><b>4.4</b> Hierarchical priors and shrinkage priors<span></span></a>
<ul>
<li><a href="Prior.html#r-session-information-3">R Session information<span></span></a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="5" data-path="BayesMCMC.html"><a href="BayesMCMC.html"><i class="fa fa-check"></i><b>5</b> Bayesian estimation with MCMC<span></span></a>
<ul>
<li class="chapter" data-level="5.1" data-path="BayesMCMC.html"><a href="BayesMCMC.html#introduction-to-markov-chain-monte-carlo-methods"><i class="fa fa-check"></i><b>5.1</b> Introduction to Markov Chain Monte Carlo Methods<span></span></a>
<ul>
<li class="chapter" data-level="5.1.1" data-path="BayesMCMC.html"><a href="BayesMCMC.html#gibbs-sampling"><i class="fa fa-check"></i><b>5.1.1</b> Gibbs sampling<span></span></a></li>
<li class="chapter" data-level="5.1.2" data-path="BayesMCMC.html"><a href="BayesMCMC.html#metropolis-algorithm"><i class="fa fa-check"></i><b>5.1.2</b> Metropolis algorithm<span></span></a></li>
</ul></li>
<li class="chapter" data-level="5.2" data-path="BayesMCMC.html"><a href="BayesMCMC.html#mcmc-diganostics---assess-convergence"><i class="fa fa-check"></i><b>5.2</b> MCMC diganostics - assess convergence<span></span></a>
<ul>
<li class="chapter" data-level="5.2.1" data-path="BayesMCMC.html"><a href="BayesMCMC.html#acceptance-rate"><i class="fa fa-check"></i><b>5.2.1</b> Acceptance Rate<span></span></a></li>
<li class="chapter" data-level="5.2.2" data-path="BayesMCMC.html"><a href="BayesMCMC.html#diagnostics-using-multiple-chains"><i class="fa fa-check"></i><b>5.2.2</b> Diagnostics Using Multiple Chains<span></span></a></li>
</ul></li>
<li class="chapter" data-level="5.3" data-path="BayesMCMC.html"><a href="BayesMCMC.html#example-bayesian-modelling-with-brms"><i class="fa fa-check"></i><b>5.3</b> Example Bayesian modelling with brms<span></span></a>
<ul>
<li class="chapter" data-level="5.3.1" data-path="BayesMCMC.html"><a href="BayesMCMC.html#example-bayesian-logistic-regression-model"><i class="fa fa-check"></i><b>5.3.1</b> Example Bayesian logistic regression model<span></span></a></li>
<li><a href="BayesMCMC.html#r-session-information-4">R Session information<span></span></a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="6" data-path="BayesReg1.html"><a href="BayesReg1.html"><i class="fa fa-check"></i><b>6</b> Bayesian Regression I<span></span></a>
<ul>
<li class="chapter" data-level="6.1" data-path="BayesReg1.html"><a href="BayesReg1.html#normal-models-and-linear-regression"><i class="fa fa-check"></i><b>6.1</b> Normal Models and Linear Regression<span></span></a>
<ul>
<li class="chapter" data-level="6.1.1" data-path="BayesReg1.html"><a href="BayesReg1.html#one-sample-and-two-sample-normal-regression"><i class="fa fa-check"></i><b>6.1.1</b> One-sample and two-sample normal regression<span></span></a></li>
<li class="chapter" data-level="6.1.2" data-path="BayesReg1.html"><a href="BayesReg1.html#linear-regression"><i class="fa fa-check"></i><b>6.1.2</b> Linear regression<span></span></a></li>
<li class="chapter" data-level="6.1.3" data-path="BayesReg1.html"><a href="BayesReg1.html#model-diagnostics"><i class="fa fa-check"></i><b>6.1.3</b> Model diagnostics<span></span></a></li>
<li class="chapter" data-level="6.1.4" data-path="BayesReg1.html"><a href="BayesReg1.html#model-comparision"><i class="fa fa-check"></i><b>6.1.4</b> Model comparision<span></span></a></li>
</ul></li>
<li class="chapter" data-level="6.2" data-path="BayesReg1.html"><a href="BayesReg1.html#hierarchical-models"><i class="fa fa-check"></i><b>6.2</b> Hierarchical models<span></span></a>
<ul>
<li class="chapter" data-level="6.2.1" data-path="BayesReg1.html"><a href="BayesReg1.html#clustered-data-multi-level"><i class="fa fa-check"></i><b>6.2.1</b> Clustered data (Multi-level)<span></span></a></li>
</ul></li>
<li class="chapter" data-level="6.3" data-path="BayesReg1.html"><a href="BayesReg1.html#regression-regularization"><i class="fa fa-check"></i><b>6.3</b> Regression regularization<span></span></a>
<ul>
<li class="chapter" data-level="6.3.1" data-path="BayesReg1.html"><a href="BayesReg1.html#shrinkage-priors-in-action"><i class="fa fa-check"></i><b>6.3.1</b> Shrinkage Priors in action<span></span></a></li>
<li class="chapter" data-level="6.3.2" data-path="BayesReg1.html"><a href="BayesReg1.html#bayesian-logistic-regression-model-cope-example-revisit"><i class="fa fa-check"></i><b>6.3.2</b> Bayesian logistic regression model (COPE example revisit)<span></span></a></li>
<li><a href="BayesReg1.html#r-session-information-5">R Session information<span></span></a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="7" data-path="BayesReg2.html"><a href="BayesReg2.html"><i class="fa fa-check"></i><b>7</b> Bayesian Regression II<span></span></a>
<ul>
<li class="chapter" data-level="7.1" data-path="BayesReg2.html"><a href="BayesReg2.html#models-for-binary-data"><i class="fa fa-check"></i><b>7.1</b> Models for Binary Data<span></span></a>
<ul>
<li class="chapter" data-level="7.1.1" data-path="BayesReg2.html"><a href="BayesReg2.html#logistic-regression-with-predictor"><i class="fa fa-check"></i><b>7.1.1</b> Logistic regression with predictor<span></span></a></li>
<li class="chapter" data-level="7.1.2" data-path="BayesReg2.html"><a href="BayesReg2.html#centring-continous-variable"><i class="fa fa-check"></i><b>7.1.2</b> Centring continous variable<span></span></a></li>
<li class="chapter" data-level="7.1.3" data-path="BayesReg2.html"><a href="BayesReg2.html#hierarchical-model-revisit"><i class="fa fa-check"></i><b>7.1.3</b> hierarchical model revisit<span></span></a></li>
</ul></li>
<li class="chapter" data-level="7.2" data-path="BayesReg2.html"><a href="BayesReg2.html#models-for-count-data"><i class="fa fa-check"></i><b>7.2</b> Models for Count Data<span></span></a>
<ul>
<li class="chapter" data-level="7.2.1" data-path="BayesReg2.html"><a href="BayesReg2.html#modelling-rates"><i class="fa fa-check"></i><b>7.2.1</b> Modelling Rates<span></span></a></li>
<li class="chapter" data-level="7.2.2" data-path="BayesReg2.html"><a href="BayesReg2.html#expanding-the-poisson-model"><i class="fa fa-check"></i><b>7.2.2</b> Expanding the Poisson Model<span></span></a></li>
<li class="chapter" data-level="7.2.3" data-path="BayesReg2.html"><a href="BayesReg2.html#checking-and-comparing-models"><i class="fa fa-check"></i><b>7.2.3</b> Checking and comparing models<span></span></a></li>
<li><a href="BayesReg2.html#r-session-information-6">R Session information<span></span></a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="8" data-path="BayesMeta.html"><a href="BayesMeta.html"><i class="fa fa-check"></i><b>8</b> Bayesian Meta-Analysis<span></span></a>
<ul>
<li class="chapter" data-level="8.1" data-path="BayesMeta.html"><a href="BayesMeta.html#introduction"><i class="fa fa-check"></i><b>8.1</b> Introduction<span></span></a></li>
<li class="chapter" data-level="8.2" data-path="BayesMeta.html"><a href="BayesMeta.html#bayesian-inference-1"><i class="fa fa-check"></i><b>8.2</b> Bayesian inference<span></span></a></li>
<li class="chapter" data-level="8.3" data-path="BayesMeta.html"><a href="BayesMeta.html#continuous-data"><i class="fa fa-check"></i><b>8.3</b> Continuous data<span></span></a>
<ul>
<li class="chapter" data-level="8.3.1" data-path="BayesMeta.html"><a href="BayesMeta.html#fitting-a-ma-with-brms"><i class="fa fa-check"></i><b>8.3.1</b> Fitting a MA with brms<span></span></a></li>
<li class="chapter" data-level="8.3.2" data-path="BayesMeta.html"><a href="BayesMeta.html#meta-regression"><i class="fa fa-check"></i><b>8.3.2</b> Meta-regression<span></span></a></li>
</ul></li>
<li class="chapter" data-level="8.4" data-path="BayesMeta.html"><a href="BayesMeta.html#other-types-of-data"><i class="fa fa-check"></i><b>8.4</b> Other types of data<span></span></a>
<ul>
<li><a href="BayesMeta.html#r-session-information-7">R Session information<span></span></a></li>
</ul></li>
</ul></li>
<li><a href="references.html#references">References<span></span></a></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">Published with bookdown</a> <a href="https://www.kuan-liu.com/" target="blank">Developed by Kuan Liu</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">HAD5314H - Applied Bayesian Methods in Clinical Epidemiology and Health Care Research</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="BayesReg2" class="section level1 hasAnchor" number="7">
<h1><span class="header-section-number">Session 7</span> Bayesian Regression II<a href="BayesReg2.html#BayesReg2" class="anchor-section" aria-label="Anchor link to header"></a></h1>
<div class="chapterintro">
<ul>
<li>Learn how to fit and interpret Bayesian logistic regression</li>
<li>Learn how to fit and interpret Bayesian poisson and negative binomial regression</li>
<li>Reviewing hierarchical model: generalized mixed-effect models</li>
</ul>
</div>
<script src="hideOutput.js"></script>
<p></br></p>
<div id="models-for-binary-data" class="section level2 hasAnchor" number="7.1">
<h2><span class="header-section-number">7.1</span> Models for Binary Data<a href="BayesReg2.html#models-for-binary-data" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<ul>
<li>For binary outcome Y, we are interested to model the probability of <span class="math inline">\(\pi_i = P(Y_i=1)\)</span>, <span class="math inline">\(i=1, \ldots, n\)</span></li>
</ul>
<p><span class="math display">\[Y_i \mid \pi_i \sim Bern(\pi_i)\]</span>
<span class="math display">\[ E(Y_i \mid \pi_i) = \pi_i\]</span>
<span class="math display">\[logit( \pi_i) = \beta_0 + \beta_1 X_{i1}\]</span></p>
<ul>
<li><p><strong>logistic regression model</strong> featuring logit link that connects binary outcome to a conventional linear regression format, is part of the broader class of <strong>generalized linear models</strong></p></li>
<li><p>Logit link convert probabilities to log odds.</p></li>
</ul>
<p><span class="math display">\[\log(\frac{\pi_i}{1-\pi_i}) = \log(\frac{P(Y_i=1)}{1- P(Y_i=1)})\]</span></p>
<p><span class="math display">\[\log(\frac{\pi_i}{1-\pi_i}) = \beta_0 + \beta_1 X_{i1}\]</span></p>
<p><img src="bayes_bookdown_files/figure-html/unnamed-chunk-145-1.png" width="672" style="display: block; margin: auto;" /></p>
<div class="important">
<p><strong>Logistic regression model</strong></p>
<ul>
<li>Consider the logistic regression model <span class="math inline">\(Y\)</span> with covariates <span class="math inline">\(X_i, \ldots, X_p\)</span>:</li>
</ul>
<p><span class="math display">\[ \log(\frac{\pi_i}{1-\pi_i}) =  \beta_0 + \beta_1 X_{i1} + \ldots + \beta_p X_{ip} \]</span></p>
<ul>
<li><p>logistic regression coefficients is interpreted as log odds ratio!</p></li>
<li><p>Furthermore, we can recalculate probability using the inverse logit function (aka, expit function)</p></li>
</ul>
<p><span class="math display">\[\pi_i = \frac{\exp(\beta_0 + \beta_1 X_{i1} + \ldots + \beta_1 X_{ip})}{1+\exp(\beta_0 + \beta_1 X_{i1} + \ldots + \beta_p X_{ip})}\]</span></p>
<ul>
<li>Assumptions of logistic regression models
<ol style="list-style-type: decimal">
<li><strong>Independent observations</strong>. This assumption can be modified if working with clustered data.</li>
<li><strong>Linear relationship between continous covariates and log-odds</strong> We can check this assumption by examining marginal plots comparing the model predicted relationship between outcome (log-odds or logit-probability) and each continuous covariates.</li>
<li><strong>Multicollinearity</strong> Multicollinearity is the phenomenon when a number of the explanatory variables are strongly correlated.</li>
<li><strong>Correctly specified regression model</strong> This means that all relevant predictors for the response variable have been included in the model. This is often difficult to verify, but we can use posterior predictive distribution to check for regression fit. We can also use WAIC and LOO to compare different models.</li>
</ol></li>
<li>Comparing to linear regression model we no-longer require the residuals to be normally distributed and homoscedasticity.</li>
</ul>
</div>
<p><strong>Diagnostic Sensitivity Example</strong></p>
<ul>
<li><p>10 studies taken from <span class="citation">(<a href="#ref-bastos2020diagnostic" role="doc-biblioref">Bastos et al. 2020</a>)</span> on <a href="https://www.bmj.com/content/370/bmj.m2516">Diagnostic accuracy of serological tests for covid-19: systematic review and meta-analysis. BMJ. 2020</a></p></li>
<li><p>Each study reports observed positive chemiluminescent immunoassa (CLIA, <span class="math inline">\(r_i\)</span>) and number having positive reference standard reverse transcriptase polymerase chain reaction (RT-PCR, <span class="math inline">\(n_i\)</span>)</p></li>
<li><p>Interest lies in summarizing this collection of values</p></li>
</ul>
<div id="htmlwidget-1a4a822a431715cae238" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-1a4a822a431715cae238">{"x":{"filter":"none","vertical":false,"data":[["1","2","3","4","5","6","7","8","9","10"],["Lin","Ma","Cai","Infantino","Zhong","Jin","Xie","Yangchun","Qian","Lou"],[65,209,158,44,46,13,15,144,432,69],[79,216,276,61,47,27,16,205,503,80],[69,74,49,62,71,63,80,64,74,58]],"container":"<table class=\"compact\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>Study<\/th>\n      <th>r<\/th>\n      <th>n<\/th>\n      <th>age<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"dom":"t","ordering":false,"paging":false,"searching":false,"columnDefs":[{"className":"dt-center","targets":[0,1,2,3]},{"className":"dt-right","targets":4},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
<p><strong>Unpooled</strong></p>
<ul>
<li>recall from last week, We can assume a binomial likelihood for each study (unpooled),</li>
</ul>
<p><span class="math display">\[r_i \sim Bin(p_i, n_i)  \]</span></p>
<ul>
<li><p>we can assume that the 10 true sensitivities <span class="math inline">\(p_i\)</span> are independent by fitting different prior to each one:
<span class="math display">\[p_i \sim Beta(1,1)\]</span></p></li>
<li><p>we will obtain 10 separate posteriors <span class="math inline">\(P(p_i \mid r_i, n_i)\)</span></p>
<ul>
<li>For example, we do not assume that <span class="math inline">\(p_1\)</span> tells us anything about the value of <span class="math inline">\(p_2\)</span></li>
</ul></li>
</ul>
<p><strong>Pooled</strong></p>
<ul>
<li>Suppose we wanted to estimate the overall sensitivity of the CLIA test
<ul>
<li>We do not want 10 separate estimates but a single estimate</li>
</ul></li>
<li>If we thought that the studies all had the same true sensitivity p0, we could fit a model like this:</li>
</ul>
<ol style="list-style-type: decimal">
<li>Assume a binomial likelihood for each study</li>
</ol>
<p><span class="math display">\[r_i \sim Bin(p_i, n_i) \]</span></p>
<ol start="2" style="list-style-type: decimal">
<li><p>Assume that all studies have the same true sensitivity, <span class="math inline">\(p_0\)</span>:
<span class="math display">\[ p_i = p_0\]</span></p></li>
<li><p>Put a prior on <span class="math inline">\(p_0\)</span>: <span class="math inline">\(p_0 \sim Beta(1,1)\)</span></p></li>
</ol>
<p><strong>Different prior on <span class="math inline">\(p_0\)</span></strong></p>
<ul>
<li><p>The beta prior is useful for models with little additional structure</p>
<ul>
<li>e.g., estimating a single proportion; estimating a collection of proportions</li>
</ul></li>
<li><p>It is difficult to use it to a model, where we want to include predictors of <span class="math inline">\(p_i\)</span></p></li>
<li><p>For most modelling approaches to binary data, we will use</p>
<ul>
<li>the logit transformation of <span class="math inline">\(p_i\)</span></li>
<li>normal priors for parameters on this logit scale (e.g., normal prior for log-odds)</li>
</ul></li>
</ul>
<p><strong>Logistic models</strong></p>
<ul>
<li><p>We still have the same likelihood <span class="math inline">\(r_i \sim Bin(p_i, n_i)\)</span></p></li>
<li><p>We define a new parameter using the logit transformation function:</p></li>
</ul>
<p><span class="math display">\[logit(p_i) = log(\frac{p_i}{1-p_i}) = \alpha_i\]</span>
<span class="math display">\[p_i = \frac{\exp(\alpha_i)}{1+\exp(\alpha_i)}\]</span></p>
<ul>
<li><p><span class="math inline">\(0&lt;p_i&lt;1 \Rightarrow -\infty &lt; \alpha_i &lt; \infty\)</span></p></li>
<li><p>Thus, it’s quite reasonable to use normal prior to characterize <span class="math inline">\(\alpha_i\)</span></p></li>
</ul>
<div class="guidedexercise">
<p><strong>1. Pooled model with non-informative prior</strong></p>
<p><span class="math display">\[r_i \mid p_i, n_i \sim Bin(p_i, n_i)\]</span>
<span class="math display">\[log(\frac{p_i}{1-p_i}) = \alpha\]</span>
<span class="math display">\[\alpha \sim N(0, \sigma = 5)\]</span></p>
<div class="sourceCode" id="cb178"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb178-1"><a href="BayesReg2.html#cb178-1" aria-hidden="true" tabindex="-1"></a>fit1 <span class="ot">&lt;-</span> <span class="fu">brm</span>(r <span class="sc">|</span> <span class="fu">trials</span>(n) <span class="sc">~</span> <span class="dv">1</span>,</span>
<span id="cb178-2"><a href="BayesReg2.html#cb178-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> dat,</span>
<span id="cb178-3"><a href="BayesReg2.html#cb178-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">prior =</span> <span class="fu">prior</span>(<span class="fu">normal</span>(<span class="dv">0</span>,<span class="dv">5</span>), <span class="at">class=</span>Intercept),</span>
<span id="cb178-4"><a href="BayesReg2.html#cb178-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">family =</span> binomial,</span>
<span id="cb178-5"><a href="BayesReg2.html#cb178-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">seed =</span> <span class="dv">123</span>)</span></code></pre></div>
<p><strong>2. Unpooled model with non-informative prior</strong></p>
<p><span class="math display">\[r_i \mid p_i, n_i \sim Bin(p_i, n_i)\]</span>
<span class="math display">\[log(\frac{p_i}{1-p_i}) = \alpha + \beta_i \ \text{Study}_i\]</span>
<span class="math display">\[\alpha \sim N(0, \sigma = 5)\]</span>
<span class="math display">\[\beta_i \sim N(0, \sigma = 5)\]</span></p>
<div class="sourceCode" id="cb179"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb179-1"><a href="BayesReg2.html#cb179-1" aria-hidden="true" tabindex="-1"></a>fit2 <span class="ot">&lt;-</span> <span class="fu">brm</span>(r <span class="sc">|</span> <span class="fu">trials</span>(n) <span class="sc">~</span> Study,</span>
<span id="cb179-2"><a href="BayesReg2.html#cb179-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> dat,</span>
<span id="cb179-3"><a href="BayesReg2.html#cb179-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">prior =</span>  <span class="fu">c</span>(<span class="fu">prior</span>(<span class="fu">normal</span>(<span class="dv">0</span>, <span class="dv">5</span>), <span class="at">class =</span> Intercept),</span>
<span id="cb179-4"><a href="BayesReg2.html#cb179-4" aria-hidden="true" tabindex="-1"></a>             <span class="fu">prior</span>(<span class="fu">normal</span>(<span class="dv">0</span>, <span class="dv">5</span>), <span class="at">class =</span> b)),</span>
<span id="cb179-5"><a href="BayesReg2.html#cb179-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">family =</span> binomial,</span>
<span id="cb179-6"><a href="BayesReg2.html#cb179-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">seed =</span> <span class="dv">123</span>)</span></code></pre></div>
</div>
<p><strong>Generalized linear models</strong></p>
<p>We can specify the type of model by two features
- Family: type of outcome (binomial, normal, Poisson, gamma)
- Link: relationship between mean parameter and predictor (identity, logic, log)</p>
<ul>
<li>we have models in the form</li>
</ul>
<p><span class="math display">\[ Y_i \sim Dist(\mu_i, \tau)\]</span>
<span class="math display">\[g(\mu_i) = \beta_0 + \beta_1 X_{i1} + \ldots + \beta_1 X_{ip}\]</span></p>
<ul>
<li><p><span class="math inline">\(g()\)</span> is called the link function</p></li>
<li><p>Distributions family (<a href="https://en.wikipedia.org/wiki/Exponential_family">exponential family</a>) can be specified as Normal, Poisson, Binomial, Bernoulli, etc.</p></li>
<li><p>Usually, we use the logit for binary data and gets odds ratios (logistic model)</p>
<ul>
<li>If we use the log link, we can estimate relative risks</li>
</ul></li>
</ul>
<div class="workedexample">
<p><strong>Sample from priors in brms</strong></p>
<ul>
<li><p>We can specify in brms to generate samples from our specified prior as part of the output</p></li>
<li><p>we can use these prior samples</p>
<ol style="list-style-type: decimal">
<li>to compare with the posteriors to see how much the prior is updated by the data</li>
<li>to check what information is in the prior</li>
</ol></li>
<li><p>using the pooled model as an example</p></li>
</ul>
<p><span class="math display">\[r_i \mid p_i, n_i \sim Bin(p_i, n_i)\]</span>
<span class="math display">\[log(\frac{p_i}{1-p_i}) = \alpha\]</span>
<span class="math display">\[\alpha \sim  N(0, \sigma = 5)\]</span></p>
<div class="sourceCode" id="cb180"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb180-1"><a href="BayesReg2.html#cb180-1" aria-hidden="true" tabindex="-1"></a>fit1 <span class="ot">&lt;-</span> <span class="fu">brm</span>(r <span class="sc">|</span> <span class="fu">trials</span>(n) <span class="sc">~</span> <span class="dv">1</span>,</span>
<span id="cb180-2"><a href="BayesReg2.html#cb180-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> dat,</span>
<span id="cb180-3"><a href="BayesReg2.html#cb180-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">prior =</span> <span class="fu">prior</span>(<span class="fu">normal</span>(<span class="dv">0</span>,<span class="dv">5</span>), <span class="at">class=</span>Intercept),</span>
<span id="cb180-4"><a href="BayesReg2.html#cb180-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">family =</span> binomial,</span>
<span id="cb180-5"><a href="BayesReg2.html#cb180-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">sample_prior =</span> T, <span class="co">#asking brms to generate prior sample!</span></span>
<span id="cb180-6"><a href="BayesReg2.html#cb180-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">seed =</span> <span class="dv">123</span>)</span>
<span id="cb180-7"><a href="BayesReg2.html#cb180-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb180-8"><a href="BayesReg2.html#cb180-8" aria-hidden="true" tabindex="-1"></a><span class="co"># saveRDS(fit1, &quot;data/chap8_binary_1&quot;)</span></span></code></pre></div>
<ul>
<li>checking posterior results
<ul>
<li>computing posterior predicted probability of event (in this case the sensitivity of the CLIA test)</li>
</ul></li>
</ul>
<div class="sourceCode" id="cb181"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb181-1"><a href="BayesReg2.html#cb181-1" aria-hidden="true" tabindex="-1"></a>fit1 <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">&quot;data/chap8_binary_1&quot;</span>)</span>
<span id="cb181-2"><a href="BayesReg2.html#cb181-2" aria-hidden="true" tabindex="-1"></a><span class="co">#posterior draws of log-odds estimate - the intercept;</span></span>
<span id="cb181-3"><a href="BayesReg2.html#cb181-3" aria-hidden="true" tabindex="-1"></a>posterior <span class="ot">&lt;-</span> <span class="fu">posterior_samples</span>(fit1)</span>
<span id="cb181-4"><a href="BayesReg2.html#cb181-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb181-5"><a href="BayesReg2.html#cb181-5" aria-hidden="true" tabindex="-1"></a><span class="co">#posterior predicted probability of event;</span></span>
<span id="cb181-6"><a href="BayesReg2.html#cb181-6" aria-hidden="true" tabindex="-1"></a>prob.pooled <span class="ot">&lt;-</span> <span class="fu">exp</span>(posterior<span class="sc">$</span>b_Intercept)<span class="sc">/</span>(<span class="dv">1</span><span class="sc">+</span><span class="fu">exp</span>(posterior<span class="sc">$</span>b_Intercept))</span>
<span id="cb181-7"><a href="BayesReg2.html#cb181-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb181-8"><a href="BayesReg2.html#cb181-8" aria-hidden="true" tabindex="-1"></a><span class="fu">mean</span>(prob.pooled)</span></code></pre></div>
<pre><code>## [1] 0.7910868</code></pre>
<div class="sourceCode" id="cb183"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb183-1"><a href="BayesReg2.html#cb183-1" aria-hidden="true" tabindex="-1"></a><span class="fu">quantile</span>(prob.pooled, <span class="fu">c</span>(<span class="fl">0.025</span>, <span class="fl">0.975</span>))</span></code></pre></div>
<pre><code>##      2.5%     97.5% 
## 0.7708342 0.8111113</code></pre>
<ul>
<li>what does the posterior output look like?</li>
</ul>
<div id="htmlwidget-9a142a643e106a10c99e" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-9a142a643e106a10c99e">{"x":{"filter":"none","vertical":false,"data":[["1","2","3","4","5","6"],[1.34592609678414,1.28454906948583,1.34415950074388,1.39184540935794,1.39689495329276,1.32974744854582],[0.391327893705283,-7.03789425274545,-6.81959053190196,-3.49244487623223,4.67425712259199,-0.535442413567366],[-115.626854644715,-115.903290862193,-115.621618507106,-116.031592675718,-116.107345998752,-115.60785718242]],"container":"<table class=\"compact\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>b_Intercept<\/th>\n      <th>prior_Intercept<\/th>\n      <th>lp__<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"dom":"t","ordering":false,"paging":false,"searching":false,"columnDefs":[{"className":"dt-center","targets":[0,1,2]},{"className":"dt-right","targets":3},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
<ul>
<li>comparing prior and posterior distribution visually</li>
</ul>
<div class="sourceCode" id="cb185"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb185-1"><a href="BayesReg2.html#cb185-1" aria-hidden="true" tabindex="-1"></a><span class="fu">data.frame</span>(<span class="at">Probability =</span> <span class="fu">c</span>(<span class="fu">inv_logit_scaled</span>(posterior[,<span class="st">&quot;b_Intercept&quot;</span>]),</span>
<span id="cb185-2"><a href="BayesReg2.html#cb185-2" aria-hidden="true" tabindex="-1"></a>                <span class="fu">inv_logit_scaled</span>(posterior[,<span class="st">&quot;prior_Intercept&quot;</span>])),</span>
<span id="cb185-3"><a href="BayesReg2.html#cb185-3" aria-hidden="true" tabindex="-1"></a>           <span class="at">Type=</span><span class="fu">rep</span>(<span class="fu">c</span>(<span class="st">&quot;Posterior&quot;</span>,<span class="st">&quot;Prior&quot;</span>),<span class="at">each=</span><span class="fu">nrow</span>(posterior))) <span class="sc">%&gt;%</span></span>
<span id="cb185-4"><a href="BayesReg2.html#cb185-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x=</span>Probability,<span class="at">fill=</span>Type))<span class="sc">+</span></span>
<span id="cb185-5"><a href="BayesReg2.html#cb185-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_density</span>(<span class="at">size=</span><span class="dv">1</span>,<span class="at">alpha=</span><span class="fl">0.5</span>)<span class="sc">+</span></span>
<span id="cb185-6"><a href="BayesReg2.html#cb185-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title=</span><span class="st">&quot;Prior: alpha ~ N(0,5); probability = exp(alpha)/(1+exp(alpha))&quot;</span>)<span class="sc">+</span></span>
<span id="cb185-7"><a href="BayesReg2.html#cb185-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>()<span class="sc">+</span></span>
<span id="cb185-8"><a href="BayesReg2.html#cb185-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values=</span><span class="fu">c</span>(<span class="st">&quot;goldenrod&quot;</span>,<span class="st">&quot;steelblue&quot;</span>))</span></code></pre></div>
<p><img src="bayes_bookdown_files/figure-html/unnamed-chunk-152-1.png" width="672" style="display: block; margin: auto;" /></p>
</div>
<div id="logistic-regression-with-predictor" class="section level3 hasAnchor" number="7.1.1">
<h3><span class="header-section-number">7.1.1</span> Logistic regression with predictor<a href="BayesReg2.html#logistic-regression-with-predictor" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<ul>
<li><p>Adding one predictor, age, for each study in modelling CLIA sensitivity</p></li>
<li><p>We have the following Bayesian model</p></li>
</ul>
<p><span class="math display">\[r_i \mid p_i, n_i \sim Bin(p_i, n_i)\]</span>
<span class="math display">\[log(\frac{p_i}{1-p_i}) = \alpha + \beta \ age_i\]</span>
<span class="math display">\[\alpha \sim  N(0, \sigma = 5)\]</span>
<span class="math display">\[\beta \sim  N(0, \sigma = 5)\]</span></p>
<ul>
<li><span class="math inline">\(\beta\)</span> is interpreted as the changes on the log-OR associate 1 unit increase in age.</li>
</ul>
<div class="sourceCode" id="cb186"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb186-1"><a href="BayesReg2.html#cb186-1" aria-hidden="true" tabindex="-1"></a>fit3 <span class="ot">&lt;-</span> <span class="fu">brm</span>(r <span class="sc">|</span> <span class="fu">trials</span>(n) <span class="sc">~</span> age,</span>
<span id="cb186-2"><a href="BayesReg2.html#cb186-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> dat,</span>
<span id="cb186-3"><a href="BayesReg2.html#cb186-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">prior =</span> <span class="fu">c</span>(<span class="fu">prior</span>(<span class="fu">normal</span>(<span class="dv">0</span>, <span class="dv">5</span>), <span class="at">class =</span> Intercept),</span>
<span id="cb186-4"><a href="BayesReg2.html#cb186-4" aria-hidden="true" tabindex="-1"></a>             <span class="fu">prior</span>(<span class="fu">normal</span>(<span class="dv">0</span>, <span class="dv">5</span>), <span class="at">class =</span> b)),</span>
<span id="cb186-5"><a href="BayesReg2.html#cb186-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">family =</span> binomial,</span>
<span id="cb186-6"><a href="BayesReg2.html#cb186-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">iter =</span> <span class="dv">10000</span>,</span>
<span id="cb186-7"><a href="BayesReg2.html#cb186-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">warmup =</span> <span class="dv">8000</span>,</span>
<span id="cb186-8"><a href="BayesReg2.html#cb186-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">cores =</span> <span class="dv">4</span>,</span>
<span id="cb186-9"><a href="BayesReg2.html#cb186-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">seed =</span> <span class="dv">123</span>)</span>
<span id="cb186-10"><a href="BayesReg2.html#cb186-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb186-11"><a href="BayesReg2.html#cb186-11" aria-hidden="true" tabindex="-1"></a><span class="co"># saveRDS(fit3, &quot;data/chap8_binary_3&quot;)</span></span></code></pre></div>
<ul>
<li>checking posterior results
<ul>
<li>computing posterior predicted probability of event (in this case the sensitivity of the CLIA test)</li>
</ul></li>
</ul>
<div class="sourceCode" id="cb187"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb187-1"><a href="BayesReg2.html#cb187-1" aria-hidden="true" tabindex="-1"></a>fit3 <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">&quot;data/chap8_binary_3&quot;</span>)</span>
<span id="cb187-2"><a href="BayesReg2.html#cb187-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb187-3"><a href="BayesReg2.html#cb187-3" aria-hidden="true" tabindex="-1"></a><span class="co">#posterior draws of log-odds estimate - the intercept;</span></span>
<span id="cb187-4"><a href="BayesReg2.html#cb187-4" aria-hidden="true" tabindex="-1"></a>posterior <span class="ot">&lt;-</span> <span class="fu">posterior_samples</span>(fit3)</span>
<span id="cb187-5"><a href="BayesReg2.html#cb187-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb187-6"><a href="BayesReg2.html#cb187-6" aria-hidden="true" tabindex="-1"></a><span class="co"># beta posterior summary</span></span>
<span id="cb187-7"><a href="BayesReg2.html#cb187-7" aria-hidden="true" tabindex="-1"></a><span class="fu">exp</span>(<span class="fu">mean</span>(posterior<span class="sc">$</span>b_age))</span></code></pre></div>
<pre><code>## [1] 1.045665</code></pre>
<div class="sourceCode" id="cb189"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb189-1"><a href="BayesReg2.html#cb189-1" aria-hidden="true" tabindex="-1"></a><span class="fu">exp</span>(<span class="fu">quantile</span>(posterior<span class="sc">$</span>b_age, <span class="fu">c</span>(<span class="fl">0.025</span>, <span class="fl">0.975</span>)))</span></code></pre></div>
<pre><code>##     2.5%    97.5% 
## 1.035435 1.056317</code></pre>
<div class="sourceCode" id="cb191"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb191-1"><a href="BayesReg2.html#cb191-1" aria-hidden="true" tabindex="-1"></a><span class="co">#posterior predicted probability testing positive for each study;</span></span>
<span id="cb191-2"><a href="BayesReg2.html#cb191-2" aria-hidden="true" tabindex="-1"></a>pp<span class="ot">&lt;-</span><span class="fu">posterior_predict</span>(fit3)</span>
<span id="cb191-3"><a href="BayesReg2.html#cb191-3" aria-hidden="true" tabindex="-1"></a>mean.pp<span class="ot">&lt;-</span><span class="fu">colMeans</span>(pp)<span class="sc">/</span>dat<span class="sc">$</span>n</span>
<span id="cb191-4"><a href="BayesReg2.html#cb191-4" aria-hidden="true" tabindex="-1"></a>lci.pp<span class="ot">&lt;-</span> <span class="fu">apply</span>(pp, <span class="dv">2</span>, <span class="cf">function</span>(x) <span class="fu">quantile</span>(x, <span class="fl">0.025</span>))<span class="sc">/</span>dat<span class="sc">$</span>n</span>
<span id="cb191-5"><a href="BayesReg2.html#cb191-5" aria-hidden="true" tabindex="-1"></a>uci.pp<span class="ot">&lt;-</span> <span class="fu">apply</span>(pp, <span class="dv">2</span>, <span class="cf">function</span>(x) <span class="fu">quantile</span>(x, <span class="fl">0.975</span>))<span class="sc">/</span>dat<span class="sc">$</span>n</span>
<span id="cb191-6"><a href="BayesReg2.html#cb191-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-7"><a href="BayesReg2.html#cb191-7" aria-hidden="true" tabindex="-1"></a>pp.table <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">Study =</span> dat<span class="sc">$</span>Study, </span>
<span id="cb191-8"><a href="BayesReg2.html#cb191-8" aria-hidden="true" tabindex="-1"></a>                       <span class="at">r =</span> dat<span class="sc">$</span>r, </span>
<span id="cb191-9"><a href="BayesReg2.html#cb191-9" aria-hidden="true" tabindex="-1"></a>                       <span class="at">n =</span> dat<span class="sc">$</span>n,</span>
<span id="cb191-10"><a href="BayesReg2.html#cb191-10" aria-hidden="true" tabindex="-1"></a>                       <span class="at">Prob_obs =</span> <span class="fu">round</span>(dat<span class="sc">$</span>r<span class="sc">/</span>dat<span class="sc">$</span>n,<span class="dv">2</span>),</span>
<span id="cb191-11"><a href="BayesReg2.html#cb191-11" aria-hidden="true" tabindex="-1"></a>                       <span class="at">Prob_post =</span> <span class="fu">round</span>(mean.pp,<span class="dv">2</span>),</span>
<span id="cb191-12"><a href="BayesReg2.html#cb191-12" aria-hidden="true" tabindex="-1"></a>                       <span class="at">CI_post =</span> <span class="fu">paste0</span>(<span class="st">&quot;(&quot;</span>,<span class="fu">round</span>(lci.pp,<span class="dv">2</span>),<span class="st">&quot;,&quot;</span>,<span class="fu">round</span>(uci.pp,<span class="dv">2</span>),<span class="st">&quot;)&quot;</span>))</span>
<span id="cb191-13"><a href="BayesReg2.html#cb191-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-14"><a href="BayesReg2.html#cb191-14" aria-hidden="true" tabindex="-1"></a>pp.table <span class="sc">%&gt;%</span> </span>
<span id="cb191-15"><a href="BayesReg2.html#cb191-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">datatable</span>(</span>
<span id="cb191-16"><a href="BayesReg2.html#cb191-16" aria-hidden="true" tabindex="-1"></a>  <span class="at">rownames =</span> F,</span>
<span id="cb191-17"><a href="BayesReg2.html#cb191-17" aria-hidden="true" tabindex="-1"></a>  <span class="at">class =</span> <span class="st">&quot;compact&quot;</span>,</span>
<span id="cb191-18"><a href="BayesReg2.html#cb191-18" aria-hidden="true" tabindex="-1"></a>  <span class="at">options =</span> <span class="fu">list</span>(</span>
<span id="cb191-19"><a href="BayesReg2.html#cb191-19" aria-hidden="true" tabindex="-1"></a>    <span class="at">dom =</span> <span class="st">&#39;t&#39;</span>,</span>
<span id="cb191-20"><a href="BayesReg2.html#cb191-20" aria-hidden="true" tabindex="-1"></a>    <span class="at">ordering =</span> <span class="cn">FALSE</span>,</span>
<span id="cb191-21"><a href="BayesReg2.html#cb191-21" aria-hidden="true" tabindex="-1"></a>    <span class="at">paging =</span> <span class="cn">FALSE</span>,</span>
<span id="cb191-22"><a href="BayesReg2.html#cb191-22" aria-hidden="true" tabindex="-1"></a>    <span class="at">searching =</span> <span class="cn">FALSE</span>,</span>
<span id="cb191-23"><a href="BayesReg2.html#cb191-23" aria-hidden="true" tabindex="-1"></a>    <span class="at">columnDefs =</span> <span class="fu">list</span>(<span class="fu">list</span>(<span class="at">className =</span> <span class="st">&#39;dt-center&#39;</span>, </span>
<span id="cb191-24"><a href="BayesReg2.html#cb191-24" aria-hidden="true" tabindex="-1"></a>                      <span class="at">targets =</span> <span class="dv">0</span><span class="sc">:</span><span class="dv">5</span>))))</span></code></pre></div>
<div id="htmlwidget-d8c7a4f21cda58d5fae3" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-d8c7a4f21cda58d5fae3">{"x":{"filter":"none","vertical":false,"data":[["Lin","Ma","Cai","Infantino","Zhong","Jin","Xie","Yangchun","Qian","Lou"],[65,209,158,44,46,13,15,144,432,69],[79,216,276,61,47,27,16,205,503,80],[0.82,0.97,0.57,0.72,0.98,0.48,0.94,0.7,0.86,0.86],[0.84,0.78,0.62,0.75,0.78,0.68,0.82,0.78,0.88,0.91],["(0.76,0.92)","(0.72,0.83)","(0.54,0.7)","(0.64,0.85)","(0.64,0.89)","(0.48,0.85)","(0.62,1)","(0.72,0.83)","(0.84,0.92)","(0.84,0.96)"]],"container":"<table class=\"compact\">\n  <thead>\n    <tr>\n      <th>Study<\/th>\n      <th>r<\/th>\n      <th>n<\/th>\n      <th>Prob_obs<\/th>\n      <th>Prob_post<\/th>\n      <th>CI_post<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"dom":"t","ordering":false,"paging":false,"searching":false,"columnDefs":[{"className":"dt-center","targets":[0,1,2,3,4,5]}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
</div>
<div id="centring-continous-variable" class="section level3 hasAnchor" number="7.1.2">
<h3><span class="header-section-number">7.1.2</span> Centring continous variable<a href="BayesReg2.html#centring-continous-variable" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<ul>
<li>our model says that sensitivity is different across studies according to the average age</li>
</ul>
<p><span class="math display">\[P(\text{test positive}) = \frac{\exp(\alpha + \beta \ age)}{1+ \exp(\alpha + \beta \ age)}\]</span></p>
<ul>
<li>We could obtain a prediction at the average of the ages <code>mean(dat$age)</code> across the studies</li>
</ul>
<p><span class="math display">\[P(\text{test positive}) = \frac{\exp(\alpha + \beta \times mean( age))}{1+ \exp(\alpha + \beta \times mean( age))}\]</span></p>
<ul>
<li>We could “centre” age at its average so that the intercept refers to the probability at the average age</li>
</ul>
<p><span class="math display">\[r_i \mid p_i, n_i \sim Bin(p_i, n_i)\]</span>
<span class="math display">\[log(\frac{p_i}{1-p_i}) = \alpha + \beta (\ age_i - mean(age))\]</span>
<span class="math display">\[\alpha \sim  N(0, \sigma = 5)\]</span>
<span class="math display">\[\beta \sim  N(0, \sigma = 5)\]</span></p>
<ul>
<li>Using a centred predictor also reduces correlation between intercept and slope. <strong>This can speed up MCMC convergence in some models (computationally more efficient).</strong></li>
</ul>
<div class="sourceCode" id="cb192"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb192-1"><a href="BayesReg2.html#cb192-1" aria-hidden="true" tabindex="-1"></a><span class="co">#centring variable age;</span></span>
<span id="cb192-2"><a href="BayesReg2.html#cb192-2" aria-hidden="true" tabindex="-1"></a>dat<span class="sc">$</span>age.c <span class="ot">&lt;-</span> dat<span class="sc">$</span>age <span class="sc">-</span> <span class="fu">mean</span>(dat<span class="sc">$</span>age)</span>
<span id="cb192-3"><a href="BayesReg2.html#cb192-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb192-4"><a href="BayesReg2.html#cb192-4" aria-hidden="true" tabindex="-1"></a>fit3c <span class="ot">&lt;-</span> <span class="fu">brm</span>(r <span class="sc">|</span> <span class="fu">trials</span>(n) <span class="sc">~</span> age.c,</span>
<span id="cb192-5"><a href="BayesReg2.html#cb192-5" aria-hidden="true" tabindex="-1"></a>            <span class="at">data=</span>dat,</span>
<span id="cb192-6"><a href="BayesReg2.html#cb192-6" aria-hidden="true" tabindex="-1"></a>            <span class="at">prior =</span> <span class="fu">c</span>(<span class="fu">prior</span>(<span class="fu">normal</span>(<span class="dv">0</span>, <span class="dv">5</span>), <span class="at">class =</span> Intercept),</span>
<span id="cb192-7"><a href="BayesReg2.html#cb192-7" aria-hidden="true" tabindex="-1"></a>                      <span class="fu">prior</span>(<span class="fu">normal</span>(<span class="dv">0</span>, <span class="dv">5</span>), <span class="at">class =</span> b)),</span>
<span id="cb192-8"><a href="BayesReg2.html#cb192-8" aria-hidden="true" tabindex="-1"></a>            <span class="at">family =</span> binomial,</span>
<span id="cb192-9"><a href="BayesReg2.html#cb192-9" aria-hidden="true" tabindex="-1"></a>            <span class="at">iter =</span> <span class="dv">5000</span>,</span>
<span id="cb192-10"><a href="BayesReg2.html#cb192-10" aria-hidden="true" tabindex="-1"></a>            <span class="at">warmup =</span> <span class="dv">3000</span>,</span>
<span id="cb192-11"><a href="BayesReg2.html#cb192-11" aria-hidden="true" tabindex="-1"></a>            <span class="at">cores =</span> <span class="dv">4</span>,</span>
<span id="cb192-12"><a href="BayesReg2.html#cb192-12" aria-hidden="true" tabindex="-1"></a>            <span class="at">seed =</span> <span class="dv">123</span>)</span>
<span id="cb192-13"><a href="BayesReg2.html#cb192-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb192-14"><a href="BayesReg2.html#cb192-14" aria-hidden="true" tabindex="-1"></a><span class="co"># saveRDS(fit3c, &quot;data/chap8_binary_3c&quot;)</span></span></code></pre></div>
<ul>
<li>comparing posterior distribution between centred and uncentred models</li>
</ul>
<div class="sourceCode" id="cb193"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb193-1"><a href="BayesReg2.html#cb193-1" aria-hidden="true" tabindex="-1"></a>fit3c <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">&quot;data/chap8_binary_3c&quot;</span>)</span>
<span id="cb193-2"><a href="BayesReg2.html#cb193-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb193-3"><a href="BayesReg2.html#cb193-3" aria-hidden="true" tabindex="-1"></a><span class="co">#posterior draws of log-odds estimate - the intercept;</span></span>
<span id="cb193-4"><a href="BayesReg2.html#cb193-4" aria-hidden="true" tabindex="-1"></a>posteriorc <span class="ot">&lt;-</span> <span class="fu">posterior_samples</span>(fit3c)</span>
<span id="cb193-5"><a href="BayesReg2.html#cb193-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb193-6"><a href="BayesReg2.html#cb193-6" aria-hidden="true" tabindex="-1"></a><span class="co"># beta posterior summary</span></span>
<span id="cb193-7"><a href="BayesReg2.html#cb193-7" aria-hidden="true" tabindex="-1"></a><span class="fu">exp</span>(<span class="fu">mean</span>(posteriorc<span class="sc">$</span>b_age))</span></code></pre></div>
<pre><code>## [1] 1.045625</code></pre>
<div class="sourceCode" id="cb195"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb195-1"><a href="BayesReg2.html#cb195-1" aria-hidden="true" tabindex="-1"></a><span class="fu">exp</span>(<span class="fu">quantile</span>(posteriorc<span class="sc">$</span>b_age, <span class="fu">c</span>(<span class="fl">0.025</span>, <span class="fl">0.975</span>)))</span></code></pre></div>
<pre><code>##     2.5%    97.5% 
## 1.035379 1.055847</code></pre>
<ul>
<li><p>posterior predicted probability testing positive for each study comparing between the centred and uncentred models</p></li>
<li><p>we can see the results are almost <em>identical</em> and we achieved this with only 5000 iterations for the centred model.</p></li>
</ul>
<div id="htmlwidget-6cc1c1fdf7264a768bab" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-6cc1c1fdf7264a768bab">{"x":{"filter":"none","vertical":false,"data":[["Lin","Ma","Cai","Infantino","Zhong","Jin","Xie","Yangchun","Qian","Lou"],[0.82,0.97,0.57,0.72,0.98,0.48,0.94,0.7,0.86,0.86],[0.84,0.78,0.62,0.75,0.78,0.68,0.82,0.78,0.88,0.91],["(0.76,0.92)","(0.72,0.83)","(0.54,0.7)","(0.64,0.85)","(0.64,0.89)","(0.48,0.85)","(0.62,1)","(0.72,0.83)","(0.84,0.92)","(0.84,0.96)"],[0.84,0.78,0.62,0.75,0.78,0.68,0.82,0.78,0.88,0.91],["(0.76,0.92)","(0.71,0.83)","(0.54,0.7)","(0.64,0.85)","(0.64,0.89)","(0.48,0.85)","(0.62,1)","(0.71,0.84)","(0.84,0.91)","(0.84,0.96)"]],"container":"<table class=\"compact\">\n  <thead>\n    <tr>\n      <th>Study<\/th>\n      <th>Prob_obs<\/th>\n      <th>Prob_post<\/th>\n      <th>CI_post<\/th>\n      <th>c_Prob_post<\/th>\n      <th>c_CI_post<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"dom":"t","ordering":false,"paging":false,"searching":false,"columnDefs":[{"className":"dt-center","targets":[0,1,2,3,4,5]}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
<ul>
<li><p>we can investigate the correlation between two posterior regression parameters, <span class="math inline">\(\alpha\)</span> (intercept) and <span class="math inline">\(\beta\)</span> (log-OR for age).</p></li>
<li><p>The two parameters should be uncorrelated by model assumption! If you see visible correlation, you can consider thinning your MCMC or run more iterations.</p></li>
</ul>
<div class="sourceCode" id="cb197"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb197-1"><a href="BayesReg2.html#cb197-1" aria-hidden="true" tabindex="-1"></a>p1 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(posterior, </span>
<span id="cb197-2"><a href="BayesReg2.html#cb197-2" aria-hidden="true" tabindex="-1"></a>             <span class="fu">aes</span>(b_Intercept, b_age))<span class="sc">+</span></span>
<span id="cb197-3"><a href="BayesReg2.html#cb197-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">alpha=</span>.<span class="dv">1</span>)<span class="sc">+</span></span>
<span id="cb197-4"><a href="BayesReg2.html#cb197-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>()<span class="sc">+</span></span>
<span id="cb197-5"><a href="BayesReg2.html#cb197-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="st">&quot;Uncentred age&quot;</span>)</span>
<span id="cb197-6"><a href="BayesReg2.html#cb197-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb197-7"><a href="BayesReg2.html#cb197-7" aria-hidden="true" tabindex="-1"></a>p2 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(posteriorc, <span class="fu">aes</span>(b_Intercept, b_age.c))<span class="sc">+</span></span>
<span id="cb197-8"><a href="BayesReg2.html#cb197-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">alpha=</span><span class="fl">0.25</span>)<span class="sc">+</span></span>
<span id="cb197-9"><a href="BayesReg2.html#cb197-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>()<span class="sc">+</span></span>
<span id="cb197-10"><a href="BayesReg2.html#cb197-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="st">&quot;Centred age&quot;</span>)</span>
<span id="cb197-11"><a href="BayesReg2.html#cb197-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb197-12"><a href="BayesReg2.html#cb197-12" aria-hidden="true" tabindex="-1"></a><span class="fu">ggarrange</span>(p1,p2, <span class="at">nrow=</span><span class="dv">1</span>)</span></code></pre></div>
<p><img src="bayes_bookdown_files/figure-html/unnamed-chunk-158-1.png" width="672" style="display: block; margin: auto;" /></p>
<ul>
<li>Model diagnostics</li>
</ul>
<ol style="list-style-type: decimal">
<li>Posterior predictive graphic check for model fit</li>
</ol>
<div class="sourceCode" id="cb198"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb198-1"><a href="BayesReg2.html#cb198-1" aria-hidden="true" tabindex="-1"></a>p1<span class="ot">&lt;-</span><span class="fu">pp_check</span>(fit3c, <span class="at">ndraws =</span> <span class="dv">50</span>)</span>
<span id="cb198-2"><a href="BayesReg2.html#cb198-2" aria-hidden="true" tabindex="-1"></a>p2<span class="ot">&lt;-</span><span class="fu">pp_check</span>(fit3c, <span class="at">type =</span> <span class="st">&quot;stat_2d&quot;</span>, <span class="at">stat =</span> <span class="fu">c</span>(<span class="st">&quot;max&quot;</span>, <span class="st">&quot;min&quot;</span>))</span>
<span id="cb198-3"><a href="BayesReg2.html#cb198-3" aria-hidden="true" tabindex="-1"></a><span class="fu">ggarrange</span>(p1,p2, <span class="at">nrow =</span> <span class="dv">1</span>)</span></code></pre></div>
<p><img src="bayes_bookdown_files/figure-html/unnamed-chunk-159-1.png" width="672" style="display: block; margin: auto;" /></p>
<ol start="2" style="list-style-type: decimal">
<li>Checking for model fitted marginal effect of age on probability of testing positive versus crude observed probability of testing positive</li>
</ol>
<div class="sourceCode" id="cb199"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb199-1"><a href="BayesReg2.html#cb199-1" aria-hidden="true" tabindex="-1"></a>plot.dat <span class="ot">&lt;-</span> fit3c<span class="sc">$</span>data</span>
<span id="cb199-2"><a href="BayesReg2.html#cb199-2" aria-hidden="true" tabindex="-1"></a>post_mu <span class="ot">&lt;-</span> <span class="fu">fitted</span>(fit3c, <span class="at">scale =</span> <span class="st">&quot;response&quot;</span>)</span>
<span id="cb199-3"><a href="BayesReg2.html#cb199-3" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(post_mu) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;mu&quot;</span>, <span class="st">&quot;mu_se&quot;</span>, <span class="st">&quot;lwr_ci&quot;</span>, <span class="st">&quot;upr_ci&quot;</span>)</span>
<span id="cb199-4"><a href="BayesReg2.html#cb199-4" aria-hidden="true" tabindex="-1"></a>df_plot <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(plot.dat, post_mu)</span>
<span id="cb199-5"><a href="BayesReg2.html#cb199-5" aria-hidden="true" tabindex="-1"></a>df_plot <span class="ot">&lt;-</span> df_plot <span class="sc">%&gt;%</span></span>
<span id="cb199-6"><a href="BayesReg2.html#cb199-6" aria-hidden="true" tabindex="-1"></a>           <span class="fu">mutate</span>(<span class="at">prob_obs =</span> r<span class="sc">/</span>n,</span>
<span id="cb199-7"><a href="BayesReg2.html#cb199-7" aria-hidden="true" tabindex="-1"></a>                  <span class="at">prob_est =</span> mu<span class="sc">/</span>n,</span>
<span id="cb199-8"><a href="BayesReg2.html#cb199-8" aria-hidden="true" tabindex="-1"></a>                  <span class="at">prob_lwr_ci =</span> lwr_ci<span class="sc">/</span>n,</span>
<span id="cb199-9"><a href="BayesReg2.html#cb199-9" aria-hidden="true" tabindex="-1"></a>                  <span class="at">prob_upr_ci =</span> upr_ci<span class="sc">/</span>n)</span>
<span id="cb199-10"><a href="BayesReg2.html#cb199-10" aria-hidden="true" tabindex="-1"></a>x_sd <span class="ot">&lt;-</span> <span class="fu">sd</span>(df_plot<span class="sc">$</span>age.c)</span>
<span id="cb199-11"><a href="BayesReg2.html#cb199-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb199-12"><a href="BayesReg2.html#cb199-12" aria-hidden="true" tabindex="-1"></a>p <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(<span class="fu">aes_string</span>(<span class="at">x =</span> <span class="st">&quot;age.c&quot;</span>,  <span class="at">y =</span> <span class="st">&quot;prob_obs&quot;</span>), <span class="at">data =</span> df_plot) <span class="sc">+</span> </span>
<span id="cb199-13"><a href="BayesReg2.html#cb199-13" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Add a layer of predictive intervals</span></span>
<span id="cb199-14"><a href="BayesReg2.html#cb199-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_ribbon</span>(<span class="fu">aes</span>(<span class="at">ymin =</span> <span class="fu">predict</span>(<span class="fu">loess</span>(prob_lwr_ci<span class="sc">~</span>age.c, <span class="at">data =</span> df_plot)), </span>
<span id="cb199-15"><a href="BayesReg2.html#cb199-15" aria-hidden="true" tabindex="-1"></a>                    <span class="at">ymax =</span> <span class="fu">predict</span>(<span class="fu">loess</span>(prob_upr_ci <span class="sc">~</span>age.c, <span class="at">data =</span> df_plot))), <span class="at">fill =</span> <span class="st">&quot;skyblue&quot;</span>, <span class="at">alpha =</span> <span class="fl">0.3</span>) <span class="sc">+</span> </span>
<span id="cb199-16"><a href="BayesReg2.html#cb199-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_smooth</span>(<span class="fu">aes</span>(<span class="at">y =</span> prob_est, <span class="at">col =</span> <span class="st">&quot;Model&quot;</span>), <span class="at">se =</span> <span class="cn">FALSE</span>, </span>
<span id="cb199-17"><a href="BayesReg2.html#cb199-17" aria-hidden="true" tabindex="-1"></a>                <span class="at">method =</span> <span class="st">&quot;loess&quot;</span>) <span class="sc">+</span> </span>
<span id="cb199-18"><a href="BayesReg2.html#cb199-18" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_smooth</span>(<span class="fu">aes</span>(<span class="at">y =</span> prob_obs, <span class="at">col =</span> <span class="st">&quot;Data&quot;</span>), <span class="at">se =</span> <span class="cn">FALSE</span>, <span class="at">linetype =</span> <span class="st">&quot;dashed&quot;</span>, </span>
<span id="cb199-19"><a href="BayesReg2.html#cb199-19" aria-hidden="true" tabindex="-1"></a>                <span class="at">method =</span> <span class="st">&quot;loess&quot;</span>) <span class="sc">+</span> </span>
<span id="cb199-20"><a href="BayesReg2.html#cb199-20" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">&quot;bottom&quot;</span>) <span class="sc">+</span> </span>
<span id="cb199-21"><a href="BayesReg2.html#cb199-21" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_color_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">&quot;red&quot;</span>, <span class="st">&quot;blue&quot;</span>), <span class="at">name =</span> <span class="st">&quot;&quot;</span>)</span>
<span id="cb199-22"><a href="BayesReg2.html#cb199-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb199-23"><a href="BayesReg2.html#cb199-23" aria-hidden="true" tabindex="-1"></a>p <span class="sc">+</span> <span class="fu">theme_bw</span>()</span></code></pre></div>
<p><img src="bayes_bookdown_files/figure-html/unnamed-chunk-160-1.png" width="480" style="display: block; margin: auto;" /></p>
</div>
<div id="hierarchical-model-revisit" class="section level3 hasAnchor" number="7.1.3">
<h3><span class="header-section-number">7.1.3</span> hierarchical model revisit<a href="BayesReg2.html#hierarchical-model-revisit" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<ul>
<li><p>Suppose that we do not believe that the sensitivity values are all the same</p></li>
<li><p>But we also believe that they are related, in the sense that they share a common underlying proportion but with deviations</p></li>
<li><p>Suppose also that our labelling of the studies is arbitrary (we would not worry if we had mixed the labels up)</p></li>
<li><p>Then the outcomes on the studies are exchangeable</p></li>
<li><p>We can treat them the same in the model, even though they are different studies</p></li>
</ul>
<p><strong>Exchangeable proportions</strong></p>
<ul>
<li>We can assume the following model</li>
</ul>
<p><span class="math display">\[logit(p_i) = \alpha_i = \alpha_0 + \epsilon_i\]</span></p>
<ul>
<li><p>where <span class="math inline">\(\epsilon_i \sim N(0,\sigma^2)\)</span></p></li>
<li><p>this is equivalent as <span class="math inline">\(\alpha_i \sim N(\alpha_0,\sigma^2)\)</span></p></li>
<li><p>The logit for study <span class="math inline">\(i\)</span> is near the average, but differs from it by some random amount <span class="math inline">\(\epsilon_i\)</span>, where <span class="math inline">\(\epsilon_i\)</span> are restricted to be centred at zero with a normal distribution</p></li>
<li><p>The logit for study <span class="math inline">\(i\)</span> is near the average, but varies with variance <span class="math inline">\(\sigma^2\)</span></p></li>
<li><p><span class="math inline">\(\sigma^2\)</span> can be estimated from the data and the model</p></li>
<li><p>It answers the question: how much do the logit proportions vary around their average?</p></li>
</ul>
<p><strong>Prior choice</strong></p>
<ul>
<li>We will often use this sort of prior structure for <span class="math inline">\(\sigma\)</span>
<ol style="list-style-type: decimal">
<li>half-t, <span class="math inline">\(\sigma \sim T_3(0, scale)\)</span></li>
<li>half-normal, <span class="math inline">\(\sigma \sim N(0, scale)\)</span></li>
</ol></li>
<li>We pick scale to be some smallish number (1,2,3)
<ul>
<li>It favours small values, but allows values that are relatively large</li>
<li>small scale specification of the prior can gain precision</li>
</ul></li>
</ul>
<p><strong>Hierarchical model</strong></p>
<ul>
<li>This is hierarchical random intercept model!</li>
<li>Data level, <span class="math inline">\(r_i \mid p_i, n_i \sim Bin(p_i(\alpha_i), n_i)\)</span></li>
<li>Structure prior, Parameters directly governing the observed data are one level up, <span class="math inline">\(\alpha_i = \alpha_0 + \epsilon_i\)</span></li>
<li>hyperparameter, <span class="math inline">\(\alpha_0 \sim N(0, 10)\)</span> and <span class="math inline">\(\sigma ~ N(0, \sigma = 2)\)</span></li>
</ul>
<!-- -  By assuming that the $\alpha_i$ values come from a common distribution, we improve the precision of each estimate -->
<p><strong>Overall average and individual estimates</strong></p>
<ul>
<li><p>Imprecise sample estimates are “shrunk” towards the overall average</p>
<ul>
<li>This shrinkage reflects the assumption that the estimates share the same overall mean</li>
</ul></li>
<li><p>When there is less data for an estimate, it “borrows” more information from the overall mean</p></li>
<li><p>Posterior means of each of the <span class="math inline">\(\alpha_i\)</span> in a random effect model are “shrunk” towards their overall mean <span class="math inline">\(\alpha_0\)</span> at the rate of <span class="math inline">\(\sigma\)</span></p></li>
<li><p>The overall mean <span class="math inline">\(\alpha_0\)</span> contains information about the values of all the other <span class="math inline">\(\alpha_i\)</span>.</p>
<ul>
<li>The consequence: the posterior means of the <span class="math inline">\(\alpha_i\)</span> are influenced by all the other <span class="math inline">\(\alpha_i\)</span></li>
<li>Because of this correlation, Bayesian estimates are closer to the population mean than the observed sample</li>
</ul></li>
<li><p>In the COVID testing example, this means that the posterior mean for study 1 depends to some extent on the data from all the other studies.</p></li>
<li><p>The Bayesian estimate can be seen as a compromise between</p>
<ul>
<li>A fixed effects estimate where all studies estimate share exactly the same common logit proportion <span class="math inline">\(\alpha_0\)</span></li>
<li>A complete independence model, where the studies each estimate completely different logit proportion <span class="math inline">\(\alpha_i\)</span>, based entirely on the observed data in that study</li>
</ul></li>
<li><p>The posterior precision is higher than the sample precision (in other words, the posterior variance is smaller than the sample variance)</p>
<ul>
<li>The together ” the studies (smaller <span class="math inline">\(\sigma\)</span>), the more borrowing of strength</li>
<li>The apart” the studies (larger <span class="math inline">\(\sigma\)</span>), the less borrowing of strength</li>
</ul></li>
</ul>
<div class="guidedexercise">
<p><strong>Run a random intercept model using brms</strong></p>
<div class="sourceCode" id="cb200"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb200-1"><a href="BayesReg2.html#cb200-1" aria-hidden="true" tabindex="-1"></a>fit4 <span class="ot">&lt;-</span> <span class="fu">brm</span>(r <span class="sc">|</span> <span class="fu">trials</span>(n) <span class="sc">~</span> (<span class="dv">1</span><span class="sc">|</span> Study) ,</span>
<span id="cb200-2"><a href="BayesReg2.html#cb200-2" aria-hidden="true" tabindex="-1"></a>            <span class="at">data=</span>dat,</span>
<span id="cb200-3"><a href="BayesReg2.html#cb200-3" aria-hidden="true" tabindex="-1"></a>            <span class="at">prior =</span> <span class="fu">c</span>(<span class="fu">prior</span>(<span class="fu">normal</span>(<span class="dv">0</span>,<span class="dv">10</span>), <span class="at">class=</span>Intercept),</span>
<span id="cb200-4"><a href="BayesReg2.html#cb200-4" aria-hidden="true" tabindex="-1"></a>                      <span class="fu">prior</span>(<span class="fu">normal</span>(<span class="dv">0</span>,<span class="dv">2</span>), <span class="at">class=</span>sd)),</span>
<span id="cb200-5"><a href="BayesReg2.html#cb200-5" aria-hidden="true" tabindex="-1"></a>            <span class="at">iter=</span><span class="dv">10000</span>,</span>
<span id="cb200-6"><a href="BayesReg2.html#cb200-6" aria-hidden="true" tabindex="-1"></a>            <span class="at">warmup=</span><span class="dv">8000</span>,</span>
<span id="cb200-7"><a href="BayesReg2.html#cb200-7" aria-hidden="true" tabindex="-1"></a>            <span class="at">cores =</span> <span class="dv">4</span>,</span>
<span id="cb200-8"><a href="BayesReg2.html#cb200-8" aria-hidden="true" tabindex="-1"></a>            <span class="at">seed =</span> <span class="dv">123</span>,</span>
<span id="cb200-9"><a href="BayesReg2.html#cb200-9" aria-hidden="true" tabindex="-1"></a>            <span class="at">family=</span>binomial)</span>
<span id="cb200-10"><a href="BayesReg2.html#cb200-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb200-11"><a href="BayesReg2.html#cb200-11" aria-hidden="true" tabindex="-1"></a><span class="co"># saveRDS(fit4, &quot;data/chap8_binary_4&quot;)</span></span></code></pre></div>
<ul>
<li>comparing posterior distribution between centred and uncentred models</li>
</ul>
<div class="sourceCode" id="cb201"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb201-1"><a href="BayesReg2.html#cb201-1" aria-hidden="true" tabindex="-1"></a>fit4 <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">&quot;data/chap8_binary_4&quot;</span>)</span>
<span id="cb201-2"><a href="BayesReg2.html#cb201-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb201-3"><a href="BayesReg2.html#cb201-3" aria-hidden="true" tabindex="-1"></a><span class="co"># posterior predicted sensitivity using fixed effect;</span></span>
<span id="cb201-4"><a href="BayesReg2.html#cb201-4" aria-hidden="true" tabindex="-1"></a>s4 <span class="ot">&lt;-</span> <span class="fu">posterior_samples</span>(fit4)</span>
<span id="cb201-5"><a href="BayesReg2.html#cb201-5" aria-hidden="true" tabindex="-1"></a><span class="fu">predict</span>(fit4)[,<span class="sc">-</span><span class="dv">2</span>]<span class="sc">/</span>dat<span class="sc">$</span>n </span></code></pre></div>
<pre><code>##        Estimate      Q2.5     Q97.5
##  [1,] 0.8244446 0.6962025 0.9240506
##  [2,] 0.9620515 0.9212963 0.9907407
##  [3,] 0.5756599 0.4927536 0.6557971
##  [4,] 0.7287029 0.5737705 0.8688525
##  [5,] 0.9561330 0.8510638 1.0000000
##  [6,] 0.5220417 0.2592593 0.7777778
##  [7,] 0.9052969 0.6875000 1.0000000
##  [8,] 0.7047518 0.6146341 0.7902439
##  [9,] 0.8588027 0.8151093 0.9005964
## [10,] 0.8609141 0.7375000 0.9500000</code></pre>
<div class="sourceCode" id="cb203"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb203-1"><a href="BayesReg2.html#cb203-1" aria-hidden="true" tabindex="-1"></a><span class="co"># posterior predicted sensitivity including random effect</span></span>
<span id="cb203-2"><a href="BayesReg2.html#cb203-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb203-3"><a href="BayesReg2.html#cb203-3" aria-hidden="true" tabindex="-1"></a><span class="co"># How would I predict the sensitivity in a NEW study</span></span>
<span id="cb203-4"><a href="BayesReg2.html#cb203-4" aria-hidden="true" tabindex="-1"></a><span class="co"># logit(p_i) = b_Intercept + e_i</span></span>
<span id="cb203-5"><a href="BayesReg2.html#cb203-5" aria-hidden="true" tabindex="-1"></a><span class="co"># e_i ~ N(0, sd_Study__Intercept))</span></span>
<span id="cb203-6"><a href="BayesReg2.html#cb203-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb203-7"><a href="BayesReg2.html#cb203-7" aria-hidden="true" tabindex="-1"></a><span class="co"># logit(p_new) = b_Intercept + e_new</span></span>
<span id="cb203-8"><a href="BayesReg2.html#cb203-8" aria-hidden="true" tabindex="-1"></a><span class="co"># e_new ~ N(0, sd_Study__Intercept)</span></span>
<span id="cb203-9"><a href="BayesReg2.html#cb203-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb203-10"><a href="BayesReg2.html#cb203-10" aria-hidden="true" tabindex="-1"></a>newlogit <span class="ot">&lt;-</span> s4<span class="sc">$</span>b_Intercept <span class="sc">+</span> <span class="fu">rnorm</span>(<span class="fu">nrow</span>(s4), <span class="dv">0</span>, <span class="at">sd=</span>s4<span class="sc">$</span>sd_Study__Intercept)</span>
<span id="cb203-11"><a href="BayesReg2.html#cb203-11" aria-hidden="true" tabindex="-1"></a>averageLogit <span class="ot">&lt;-</span> s4<span class="sc">$</span>b_Intercept</span>
<span id="cb203-12"><a href="BayesReg2.html#cb203-12" aria-hidden="true" tabindex="-1"></a><span class="fu">hist</span>(<span class="fu">inv_logit_scaled</span>(newlogit), <span class="at">nclass=</span><span class="dv">50</span>)</span></code></pre></div>
<p><img src="bayes_bookdown_files/figure-html/unnamed-chunk-162-1.png" width="672" /></p>
<div class="sourceCode" id="cb204"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb204-1"><a href="BayesReg2.html#cb204-1" aria-hidden="true" tabindex="-1"></a><span class="fu">quantile</span>(<span class="fu">inv_logit_scaled</span>(newlogit), <span class="fu">c</span>(<span class="fl">0.5</span>, <span class="fl">0.025</span>, <span class="fl">0.975</span>))</span></code></pre></div>
<pre><code>##       50%      2.5%     97.5% 
## 0.8341145 0.2199669 0.9901854</code></pre>
<div class="sourceCode" id="cb206"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb206-1"><a href="BayesReg2.html#cb206-1" aria-hidden="true" tabindex="-1"></a><span class="fu">data.frame</span>(<span class="at">Sensitivity=</span><span class="fu">c</span>(<span class="fu">inv_logit_scaled</span>(newlogit), <span class="co">#mixed effect;</span></span>
<span id="cb206-2"><a href="BayesReg2.html#cb206-2" aria-hidden="true" tabindex="-1"></a>                         <span class="fu">inv_logit_scaled</span>(averageLogit)), <span class="co">#fixed effect;</span></span>
<span id="cb206-3"><a href="BayesReg2.html#cb206-3" aria-hidden="true" tabindex="-1"></a>           <span class="at">Type=</span><span class="fu">rep</span>(<span class="fu">c</span>(<span class="st">&quot;New Study&quot;</span>,<span class="st">&quot;Pooled Estimate&quot;</span>),<span class="at">each=</span><span class="fu">nrow</span>(s4))) <span class="sc">%&gt;%</span></span>
<span id="cb206-4"><a href="BayesReg2.html#cb206-4" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x=</span>Sensitivity, <span class="at">fill=</span>Type))<span class="sc">+</span><span class="fu">geom_density</span>(<span class="at">alpha=</span><span class="fl">0.25</span>)<span class="sc">+</span><span class="fu">theme_bw</span>()</span></code></pre></div>
<p><img src="bayes_bookdown_files/figure-html/unnamed-chunk-162-2.png" width="672" /></p>
<div class="sourceCode" id="cb207"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb207-1"><a href="BayesReg2.html#cb207-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Make plots of observed and fitted values</span></span>
<span id="cb207-2"><a href="BayesReg2.html#cb207-2" aria-hidden="true" tabindex="-1"></a>Prob <span class="ot">&lt;-</span> <span class="fu">mean</span>(<span class="fu">inv_logit_scaled</span>(s4[,<span class="st">&quot;b_Intercept&quot;</span>]))</span>
<span id="cb207-3"><a href="BayesReg2.html#cb207-3" aria-hidden="true" tabindex="-1"></a>CrI <span class="ot">&lt;-</span> <span class="fu">quantile</span>(<span class="fu">inv_logit_scaled</span>(s4[,<span class="st">&quot;b_Intercept&quot;</span>]), <span class="fu">c</span>(<span class="fl">0.025</span>, <span class="fl">0.975</span>))</span>
<span id="cb207-4"><a href="BayesReg2.html#cb207-4" aria-hidden="true" tabindex="-1"></a>Prob2 <span class="ot">&lt;-</span><span class="fu">inv_logit_scaled</span>(<span class="fu">mean</span>(s4[,<span class="st">&quot;b_Intercept&quot;</span>]))</span>
<span id="cb207-5"><a href="BayesReg2.html#cb207-5" aria-hidden="true" tabindex="-1"></a><span class="fu">data.frame</span>(<span class="at">Size=</span>dat<span class="sc">$</span>n, <span class="at">observed=</span>dat<span class="sc">$</span>r<span class="sc">/</span>dat<span class="sc">$</span>n, </span>
<span id="cb207-6"><a href="BayesReg2.html#cb207-6" aria-hidden="true" tabindex="-1"></a>           <span class="at">posteriorCount=</span><span class="fu">predict</span>(fit4)[,<span class="dv">1</span>])<span class="sc">%&gt;%</span></span>
<span id="cb207-7"><a href="BayesReg2.html#cb207-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">PosteriorMean=</span>posteriorCount<span class="sc">/</span>Size) <span class="sc">%&gt;%</span></span>
<span id="cb207-8"><a href="BayesReg2.html#cb207-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">SamplePrecision=</span>Size<span class="sc">/</span>(observed<span class="sc">*</span>(<span class="dv">1</span><span class="sc">-</span>observed))) <span class="sc">%&gt;%</span></span>
<span id="cb207-9"><a href="BayesReg2.html#cb207-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(observed, PosteriorMean,<span class="at">size=</span>SamplePrecision))<span class="sc">+</span></span>
<span id="cb207-10"><a href="BayesReg2.html#cb207-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">alpha=</span><span class="fl">0.5</span>)<span class="sc">+</span></span>
<span id="cb207-11"><a href="BayesReg2.html#cb207-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_abline</span>(<span class="at">slope=</span><span class="dv">1</span>, <span class="at">intercept=</span><span class="dv">0</span>,<span class="at">lty=</span><span class="dv">3</span>,<span class="at">col=</span><span class="st">&quot;blue&quot;</span>)<span class="sc">+</span></span>
<span id="cb207-12"><a href="BayesReg2.html#cb207-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylim</span>(<span class="fu">c</span>(<span class="fl">0.4</span>,<span class="dv">1</span>))<span class="sc">+</span></span>
<span id="cb207-13"><a href="BayesReg2.html#cb207-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlim</span>(<span class="fu">c</span>(<span class="fl">0.4</span>,<span class="dv">1</span>))<span class="sc">+</span></span>
<span id="cb207-14"><a href="BayesReg2.html#cb207-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">aspect.ratio =</span> <span class="dv">1</span>)<span class="sc">+</span></span>
<span id="cb207-15"><a href="BayesReg2.html#cb207-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept=</span>Prob,<span class="at">lty=</span><span class="dv">2</span>,<span class="at">col=</span><span class="st">&quot;red&quot;</span>,<span class="at">size=</span><span class="dv">1</span>)<span class="sc">+</span></span>
<span id="cb207-16"><a href="BayesReg2.html#cb207-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>()</span></code></pre></div>
<p><img src="bayes_bookdown_files/figure-html/unnamed-chunk-162-3.png" width="672" /></p>
</div>
<p><strong>Seeds example</strong></p>
<ul>
<li><p>Concerns the proportion of seeds that germinated on each of 21 plates</p></li>
<li><p>Plates are arranged according to a 2 by 2 factorial layout by seed and type of root extract.</p></li>
<li><p><span class="math inline">\(r_i\)</span> and <span class="math inline">\(n_i\)</span> are the number of those germinated and the total number of seeds on the <span class="math inline">\(i\)</span>th plate, <span class="math inline">\(i=1, \ldots,21\)</span>.</p></li>
</ul>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:unnamed-chunk-163"></span>
<img src="images/seed_data.PNG" alt="Seed example data summary" width="538" />
<p class="caption">
Figure 7.1: Seed example data summary
</p>
</div>
<ul>
<li><p>There are two factors: seed and root extract</p></li>
<li><p>A fixed effects model would simply be (<span class="math inline">\(i\)</span> index plate)</p></li>
</ul>
<p><span class="math display">\[logit(p_i) = \beta_0 + \beta_1 SEED_i + \beta_2 ROOT_i\]</span>
<span class="math display">\[r_i \sim Bin(n_i, p_i)\]</span></p>
<ul>
<li>The mean (probability) depends entirely on the `treatment’ received</li>
<li>Variation in the <span class="math inline">\(r_i\)</span> are only due to binomial distribution variability</li>
</ul>
<p><strong>The table of expected values for logits for each seed/root combination</strong></p>
<table>
<thead>
<tr class="header">
<th></th>
<th>ROOT = 0</th>
<th>ROOT=1</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>SEED=0</td>
<td><span class="math inline">\(\beta_0\)</span></td>
<td><span class="math inline">\(\beta_0 + \beta_2\)</span></td>
</tr>
<tr class="even">
<td>SEED=1</td>
<td><span class="math inline">\(\beta_0 + \beta_1\)</span></td>
<td><span class="math inline">\(\beta_0 + \beta_1 + \beta_2\)</span></td>
</tr>
</tbody>
</table>
<ul>
<li><p>Why might this not be sufficient?</p>
<ul>
<li>There could be additional unmeasured variables</li>
<li>e.g., the plates are not identical, growing condition could be different, seeds might be from different parents, etc</li>
</ul></li>
<li><p>One solution is to introduce a random intercept <span class="math inline">\(b_i\)</span></p></li>
<li><p>This is additional ‘noise’ that is added to each predicted logit(probability)</p></li>
</ul>
<p><span class="math display">\[logit(p_i) = \beta_0 + \beta_1 SEED_i + \beta_2 ROOT_i + b_i\]</span>
<span class="math display">\[r_i \sim Bin(n_i, p_i)\]</span>
<span class="math display">\[b_i \sim N(0, \sigma_b)\]</span></p>
<ul>
<li><p>The SEED and ROOT tell you what the expected value of the logit(p) is</p></li>
<li><p>The random effect accounts for deviations from this expected value</p></li>
<li><p>Some plates are higher than expected and some are lower</p></li>
<li><p>The table of expected values for logits for each seed/root combination (remain the same!)</p></li>
<li><p>We put a prior on the random effect <span class="math inline">\(b_i \sim N(0,\sigma_b)\)</span></p></li>
<li><p>We put a prior on <span class="math inline">\(\sigma_b\)</span> (hyperparameter), since we do not know what amount of between-plate variation exists</p></li>
<li><p>We estimate the between-plate variation by finding a posterior distribution for <span class="math inline">\(\sigma_b\)</span></p></li>
<li><p>We have two levels of variation</p>
<ul>
<li>Within-plate (binomial variation with parameter <span class="math inline">\(p_i\)</span>)</li>
<li>Between-plate (on <span class="math inline">\(logit(p_i)\)</span> scale)</li>
<li>Some of the latter is explained by the predictors</li>
<li>The remaining is modelled by the random effect (normal variation) - random intercept</li>
</ul></li>
<li><p>We have a hierarchical logistic regression model!</p></li>
</ul>
<p><strong>Verify fit of random effect model</strong></p>
<ul>
<li><p>Assess the degree of extra-binomial variation by looking at the standard deviation</p></li>
<li><p>Look at the posterior density plot for <span class="math inline">\(\sigma_b\)</span></p>
<ul>
<li><strong>Is the density of <span class="math inline">\(\sigma_b\)</span> away from zero?</strong></li>
<li><strong>What is the posterior mean of <span class="math inline">\(\sigma_b\)</span></strong></li>
</ul></li>
<li><p>More formally to determine if the random effect model fits better than standard fixed effect model: use WAIC and/or loo.</p></li>
</ul>
<div class="guidedexercise">
<p><strong>Fit Seed example using brms</strong></p>
<pre><code>##             Seed           Root     y           Plate    
##  aegyptiaco 73:436   Bean    :567   0:407   3      : 81  
##  aegyptiaco 75:395   Cucumber:264   1:424   10     : 79  
##                                             7      : 74  
##                                             8      : 72  
##                                             2      : 62  
##                                             4      : 51  
##                                             (Other):412</code></pre>
<pre><code>##            Seed Root y Plate
## 1 aegyptiaco 75 Bean 1     1
## 2 aegyptiaco 75 Bean 1     1
## 3 aegyptiaco 75 Bean 1     1
## 4 aegyptiaco 75 Bean 1     1
## 5 aegyptiaco 75 Bean 1     1
## 6 aegyptiaco 75 Bean 1     1</code></pre>
<div class="sourceCode" id="cb210"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb210-1"><a href="BayesReg2.html#cb210-1" aria-hidden="true" tabindex="-1"></a>fit5<span class="fl">.1</span> <span class="ot">&lt;-</span> <span class="fu">brm</span>(y <span class="sc">~</span> Root<span class="sc">+</span>Seed ,</span>
<span id="cb210-2"><a href="BayesReg2.html#cb210-2" aria-hidden="true" tabindex="-1"></a>            <span class="at">data=</span>d,</span>
<span id="cb210-3"><a href="BayesReg2.html#cb210-3" aria-hidden="true" tabindex="-1"></a>            <span class="at">prior =</span> <span class="fu">c</span>(<span class="fu">prior</span>(<span class="fu">normal</span>(<span class="dv">0</span>,<span class="dv">10</span>),<span class="at">class=</span>Intercept),</span>
<span id="cb210-4"><a href="BayesReg2.html#cb210-4" aria-hidden="true" tabindex="-1"></a>                      <span class="fu">prior</span>(<span class="fu">normal</span>(<span class="dv">0</span>,<span class="dv">2</span>), <span class="at">class=</span>b)),</span>
<span id="cb210-5"><a href="BayesReg2.html#cb210-5" aria-hidden="true" tabindex="-1"></a>            <span class="at">family=</span>bernoulli,</span>
<span id="cb210-6"><a href="BayesReg2.html#cb210-6" aria-hidden="true" tabindex="-1"></a>            <span class="at">iter =</span> <span class="dv">10000</span>,</span>
<span id="cb210-7"><a href="BayesReg2.html#cb210-7" aria-hidden="true" tabindex="-1"></a>            <span class="at">warmup =</span> <span class="dv">8000</span>,</span>
<span id="cb210-8"><a href="BayesReg2.html#cb210-8" aria-hidden="true" tabindex="-1"></a>            <span class="at">chains =</span> <span class="dv">4</span>,</span>
<span id="cb210-9"><a href="BayesReg2.html#cb210-9" aria-hidden="true" tabindex="-1"></a>            <span class="at">cores =</span> <span class="dv">5</span>, </span>
<span id="cb210-10"><a href="BayesReg2.html#cb210-10" aria-hidden="true" tabindex="-1"></a>            <span class="at">seed =</span> <span class="dv">123</span>)</span>
<span id="cb210-11"><a href="BayesReg2.html#cb210-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb210-12"><a href="BayesReg2.html#cb210-12" aria-hidden="true" tabindex="-1"></a>fit5<span class="fl">.2</span> <span class="ot">&lt;-</span> <span class="fu">brm</span>(y <span class="sc">~</span> Root<span class="sc">+</span>Seed<span class="sc">+</span>(<span class="dv">1</span><span class="sc">|</span>Plate),</span>
<span id="cb210-13"><a href="BayesReg2.html#cb210-13" aria-hidden="true" tabindex="-1"></a>            <span class="at">data=</span>d,</span>
<span id="cb210-14"><a href="BayesReg2.html#cb210-14" aria-hidden="true" tabindex="-1"></a>            <span class="at">prior =</span> <span class="fu">c</span>(<span class="fu">prior</span>(<span class="fu">normal</span>(<span class="dv">0</span>,<span class="dv">10</span>),<span class="at">class=</span>Intercept),</span>
<span id="cb210-15"><a href="BayesReg2.html#cb210-15" aria-hidden="true" tabindex="-1"></a>                      <span class="fu">prior</span>(<span class="fu">normal</span>(<span class="dv">0</span>,<span class="dv">2</span>), <span class="at">class=</span>b),</span>
<span id="cb210-16"><a href="BayesReg2.html#cb210-16" aria-hidden="true" tabindex="-1"></a>                      <span class="fu">prior</span>(<span class="fu">normal</span>(<span class="dv">0</span>,<span class="dv">2</span>), <span class="at">class =</span> sd)),</span>
<span id="cb210-17"><a href="BayesReg2.html#cb210-17" aria-hidden="true" tabindex="-1"></a>            <span class="at">family=</span>bernoulli,</span>
<span id="cb210-18"><a href="BayesReg2.html#cb210-18" aria-hidden="true" tabindex="-1"></a>            <span class="at">iter =</span> <span class="dv">20000</span>,</span>
<span id="cb210-19"><a href="BayesReg2.html#cb210-19" aria-hidden="true" tabindex="-1"></a>            <span class="at">warmup =</span> <span class="dv">18000</span>,</span>
<span id="cb210-20"><a href="BayesReg2.html#cb210-20" aria-hidden="true" tabindex="-1"></a>            <span class="at">chains =</span> <span class="dv">4</span>,</span>
<span id="cb210-21"><a href="BayesReg2.html#cb210-21" aria-hidden="true" tabindex="-1"></a>            <span class="at">cores =</span> <span class="dv">5</span>, </span>
<span id="cb210-22"><a href="BayesReg2.html#cb210-22" aria-hidden="true" tabindex="-1"></a>            <span class="at">seed =</span> <span class="dv">123</span>)</span>
<span id="cb210-23"><a href="BayesReg2.html#cb210-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb210-24"><a href="BayesReg2.html#cb210-24" aria-hidden="true" tabindex="-1"></a><span class="co"># saveRDS(fit5.1, file=&quot;data/chap8_binary_5.1&quot;)</span></span>
<span id="cb210-25"><a href="BayesReg2.html#cb210-25" aria-hidden="true" tabindex="-1"></a><span class="co"># saveRDS(fit5.2, file=&quot;data/chap8_binary_5.2&quot;)</span></span></code></pre></div>
<ol style="list-style-type: decimal">
<li>Quick posterior summary</li>
</ol>
<div class="sourceCode" id="cb211"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb211-1"><a href="BayesReg2.html#cb211-1" aria-hidden="true" tabindex="-1"></a>fit5<span class="fl">.1</span> <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">&quot;data/chap8_binary_5.1&quot;</span>)</span>
<span id="cb211-2"><a href="BayesReg2.html#cb211-2" aria-hidden="true" tabindex="-1"></a>fit5<span class="fl">.2</span> <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">&quot;data/chap8_binary_5.2&quot;</span>)</span>
<span id="cb211-3"><a href="BayesReg2.html#cb211-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-4"><a href="BayesReg2.html#cb211-4" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(fit5<span class="fl">.1</span>)</span></code></pre></div>
<pre><code>##  Family: bernoulli 
##   Links: mu = logit 
## Formula: y ~ Root + Seed 
##    Data: d (Number of observations: 831) 
##   Draws: 4 chains, each with iter = 10000; warmup = 8000; thin = 1;
##          total post-warmup draws = 8000
## 
## Population-Level Effects: 
##                  Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
## Intercept            0.64      0.11     0.43     0.85 1.00     8222     6308
## RootCucumber        -0.27      0.16    -0.57     0.03 1.00     8292     6485
## Seedaegyptiaco75    -1.06      0.14    -1.35    -0.79 1.00     8578     6418
## 
## Draws were sampled using sampling(NUTS). For each parameter, Bulk_ESS
## and Tail_ESS are effective sample size measures, and Rhat is the potential
## scale reduction factor on split chains (at convergence, Rhat = 1).</code></pre>
<div class="sourceCode" id="cb213"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb213-1"><a href="BayesReg2.html#cb213-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(fit5<span class="fl">.2</span>)</span></code></pre></div>
<pre><code>##  Family: bernoulli 
##   Links: mu = logit 
## Formula: y ~ Root + Seed + (1 | Plate) 
##    Data: d (Number of observations: 831) 
##   Draws: 4 chains, each with iter = 20000; warmup = 18000; thin = 1;
##          total post-warmup draws = 8000
## 
## Group-Level Effects: 
## ~Plate (Number of levels: 21) 
##               Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
## sd(Intercept)     0.40      0.15     0.14     0.72 1.00     2294     3677
## 
## Population-Level Effects: 
##                  Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
## Intercept            0.63      0.20     0.23     1.05 1.00     4046     3816
## RootCucumber        -0.37      0.26    -0.90     0.12 1.00     4519     4205
## Seedaegyptiaco75    -1.00      0.25    -1.48    -0.50 1.00     3910     3929
## 
## Draws were sampled using sampling(NUTS). For each parameter, Bulk_ESS
## and Tail_ESS are effective sample size measures, and Rhat is the potential
## scale reduction factor on split chains (at convergence, Rhat = 1).</code></pre>
<div class="sourceCode" id="cb215"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb215-1"><a href="BayesReg2.html#cb215-1" aria-hidden="true" tabindex="-1"></a><span class="fu">exp</span>(<span class="fu">fixef</span>(fit5<span class="fl">.1</span>)[,<span class="sc">-</span><span class="dv">2</span>])</span></code></pre></div>
<pre><code>##                   Estimate      Q2.5     Q97.5
## Intercept        1.8888445 1.5309888 2.3506962
## RootCucumber     0.7624076 0.5644264 1.0286836
## Seedaegyptiaco75 0.3450610 0.2599323 0.4548134</code></pre>
<div class="sourceCode" id="cb217"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb217-1"><a href="BayesReg2.html#cb217-1" aria-hidden="true" tabindex="-1"></a><span class="fu">exp</span>(<span class="fu">fixef</span>(fit5<span class="fl">.2</span>)[,<span class="sc">-</span><span class="dv">2</span>])</span></code></pre></div>
<pre><code>##                   Estimate      Q2.5     Q97.5
## Intercept        1.8858444 1.2646870 2.8443232
## RootCucumber     0.6904545 0.4065323 1.1245548
## Seedaegyptiaco75 0.3661719 0.2266688 0.6066912</code></pre>
<ol start="2" style="list-style-type: decimal">
<li>Visualize Parameter Effects</li>
</ol>
<div class="sourceCode" id="cb219"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb219-1"><a href="BayesReg2.html#cb219-1" aria-hidden="true" tabindex="-1"></a>p1<span class="ot">&lt;-</span>d <span class="sc">%&gt;%</span></span>
<span id="cb219-2"><a href="BayesReg2.html#cb219-2" aria-hidden="true" tabindex="-1"></a>  modelr<span class="sc">::</span><span class="fu">data_grid</span>(Seed, Root) <span class="sc">%&gt;%</span></span>
<span id="cb219-3"><a href="BayesReg2.html#cb219-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_fitted_draws</span>(fit5<span class="fl">.1</span>) <span class="sc">%&gt;%</span></span>
<span id="cb219-4"><a href="BayesReg2.html#cb219-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> .value, <span class="at">y =</span> <span class="fu">interaction</span>(Seed, Root))) <span class="sc">+</span></span>
<span id="cb219-5"><a href="BayesReg2.html#cb219-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stat_pointinterval</span>(<span class="at">.width =</span> <span class="fu">c</span>(.<span class="dv">68</span>, .<span class="dv">95</span>)) <span class="sc">+</span></span>
<span id="cb219-6"><a href="BayesReg2.html#cb219-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_flip</span>() <span class="sc">+</span></span>
<span id="cb219-7"><a href="BayesReg2.html#cb219-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">&quot;predicted probability&quot;</span>) <span class="sc">+</span></span>
<span id="cb219-8"><a href="BayesReg2.html#cb219-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">breaks =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="fl">0.1</span>),<span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>))<span class="sc">+</span></span>
<span id="cb219-9"><a href="BayesReg2.html#cb219-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>()</span>
<span id="cb219-10"><a href="BayesReg2.html#cb219-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb219-11"><a href="BayesReg2.html#cb219-11" aria-hidden="true" tabindex="-1"></a>p2<span class="ot">&lt;-</span> d <span class="sc">%&gt;%</span></span>
<span id="cb219-12"><a href="BayesReg2.html#cb219-12" aria-hidden="true" tabindex="-1"></a>  modelr<span class="sc">::</span><span class="fu">data_grid</span>(Seed, Root, Plate) <span class="sc">%&gt;%</span></span>
<span id="cb219-13"><a href="BayesReg2.html#cb219-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_fitted_draws</span>(fit5<span class="fl">.2</span>) <span class="sc">%&gt;%</span></span>
<span id="cb219-14"><a href="BayesReg2.html#cb219-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> .value, <span class="at">y =</span> <span class="fu">interaction</span>(Seed, Root))) <span class="sc">+</span></span>
<span id="cb219-15"><a href="BayesReg2.html#cb219-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stat_pointinterval</span>(<span class="at">.width =</span> <span class="fu">c</span>(.<span class="dv">68</span>, .<span class="dv">95</span>)) <span class="sc">+</span></span>
<span id="cb219-16"><a href="BayesReg2.html#cb219-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_flip</span>() <span class="sc">+</span></span>
<span id="cb219-17"><a href="BayesReg2.html#cb219-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">&quot;predicted probability&quot;</span>) <span class="sc">+</span></span>
<span id="cb219-18"><a href="BayesReg2.html#cb219-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">breaks =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="fl">0.1</span>),<span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>))<span class="sc">+</span></span>
<span id="cb219-19"><a href="BayesReg2.html#cb219-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>()</span>
<span id="cb219-20"><a href="BayesReg2.html#cb219-20" aria-hidden="true" tabindex="-1"></a><span class="fu">ggarrange</span>(p1,p2, <span class="at">nrow =</span> <span class="dv">2</span>)</span></code></pre></div>
<p><img src="bayes_bookdown_files/figure-html/unnamed-chunk-167-1.png" width="720" style="display: block; margin: auto;" /></p>
<ol start="3" style="list-style-type: decimal">
<li>Compare models</li>
</ol>
<div class="sourceCode" id="cb220"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb220-1"><a href="BayesReg2.html#cb220-1" aria-hidden="true" tabindex="-1"></a><span class="co">#checking sd posterior density;</span></span>
<span id="cb220-2"><a href="BayesReg2.html#cb220-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(fit5<span class="fl">.2</span>, <span class="at">variable =</span> <span class="st">&quot;sd_Plate__Intercept&quot;</span>)</span></code></pre></div>
<p><img src="bayes_bookdown_files/figure-html/unnamed-chunk-168-1.png" width="672" style="display: block; margin: auto;" /></p>
<div class="sourceCode" id="cb221"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb221-1"><a href="BayesReg2.html#cb221-1" aria-hidden="true" tabindex="-1"></a>waic1 <span class="ot">&lt;-</span> <span class="fu">waic</span>(fit5<span class="fl">.1</span>)</span>
<span id="cb221-2"><a href="BayesReg2.html#cb221-2" aria-hidden="true" tabindex="-1"></a>waic2 <span class="ot">&lt;-</span> <span class="fu">waic</span>(fit5<span class="fl">.2</span>) <span class="co">#smaller wAIC better model!</span></span>
<span id="cb221-3"><a href="BayesReg2.html#cb221-3" aria-hidden="true" tabindex="-1"></a><span class="fu">compare_ic</span>(waic1, waic2)</span></code></pre></div>
</div>
</div>
</div>
<div id="models-for-count-data" class="section level2 hasAnchor" number="7.2">
<h2><span class="header-section-number">7.2</span> Models for Count Data<a href="BayesReg2.html#models-for-count-data" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<ul>
<li>Example Count Data
<ul>
<li>Number of deaths in cohort followed up for 5 years</li>
<li>Number of deaths in subgroups of this cohort</li>
<li>Number of episodes of cold or flu experienced by an individual in a year</li>
<li>Number of hospitalizations a person experiences in a year</li>
</ul></li>
</ul>
<div class="important">
<p><strong>Poisson Distribution</strong></p>
<ul>
<li><p>If we count the number of events that occur over a fixed time period, this random variable Y can take on one of the whole numbers 0, 1, 2,…</p></li>
<li><p>Let <span class="math inline">\(\theta = E(Y)\)</span>, then the probability of observing <span class="math inline">\(y\)</span> events (probability mass function) is</p></li>
</ul>
<p><span class="math display">\[ P(Y = y \mid \theta) = \frac{\theta^y \exp(-\theta)}{y!}, y = 0,1,2, \ldots\]</span></p>
<ul>
<li><p>There is only one parameter, the mean (or expected number of events)</p></li>
<li><p>This same parameter is also the variance</p></li>
</ul>
<p><span class="math display">\[\theta = E(Y) = Var(Y)\]</span></p>
<ul>
<li>If we know the length of follow-up time is T, then we can write the expected
number <span class="math inline">\(\theta\)</span> as</li>
</ul>
<p><span class="math display">\[\theta = \lambda \times T\]</span></p>
<p>where <span class="math inline">\(\lambda\)</span> is the <strong>rate per unit of time</strong>.</p>
<ul>
<li>Then we can replace the mean by rate <span class="math inline">\(\times\)</span> time in the Poisson probability mass function:</li>
</ul>
<p><span class="math display">\[P(Y = y \mid \lambda, T) = \frac{(\lambda T)^y \exp(-\lambda T)}{y!}, y = 0,1,2, \ldots\]</span></p>
<ul>
<li><p>When to use Poisson Distribution</p>
<ol style="list-style-type: decimal">
<li>Time period of observation is known</li>
<li>The event can be counted in whole numbers</li>
<li>Occurrences are independent, so that one occurrence neither diminishes nor increases the chance of another</li>
<li>The rate of occurrence for the time period in question is constant</li>
</ol></li>
<li><p>For <strong>rare events</strong> (small <span class="math inline">\(p\)</span>, large <span class="math inline">\(n\)</span>), <span class="math inline">\(Y \sim Bin(p,n)\)</span> has approximately Poisson distribution.</p></li>
<li><p>Not <strong>necessary</strong> to count how many events have not occurred: e.g. we cannot
count how many episodes of flu did not occur</p></li>
</ul>
</div>
<div id="modelling-rates" class="section level3 hasAnchor" number="7.2.1">
<h3><span class="header-section-number">7.2.1</span> Modelling Rates<a href="BayesReg2.html#modelling-rates" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<ul>
<li>Usually, it is the rate that we are interested in e.g., consider a study looking at emergency room visits among CHF patients over three years
<ul>
<li>Subject 1: enrolled at 24 months. so T=36 - 12 months</li>
<li>Subject 2: enrolled at 12 months, so T=36 - 24 months</li>
<li>Subject 1 will have a mean <span class="math inline">\(= 12 \times \lambda_1\)</span></li>
<li>Subject 2 will have a mean <span class="math inline">\(= 24 \times \lambda_2\)</span></li>
</ul></li>
<li>We are interested in factors that affect their rates <span class="math inline">\(\lambda_1\)</span> and <span class="math inline">\(\lambda_2\)</span>, not their enrolment or follow-up times.</li>
</ul>
<p><strong>1. Simple Poisson Model (one-sample)</strong></p>
<ul>
<li>Suppose we have follow up time <span class="math inline">\(T_i\)</span> and number of events <span class="math inline">\(Y_i\)</span> for each subject</li>
<li>Lets assume that the underlying rate of events is the <strong>same</strong> for everyone</li>
<li>We are interested in this common underlying rate of events <span class="math inline">\(\lambda\)</span></li>
<li>We prefer to model <span class="math inline">\(\log(\lambda)\)</span>, where</li>
</ul>
<p><span class="math display">\[ \lambda &gt; 0 \leftrightarrow - \infty &lt; \log(\lambda) &lt; \infty\]</span></p>
<p>and</p>
<p><span class="math display">\[Y_i \sim Poisson(\theta_i)\]</span>
<span class="math display">\[\theta_i = \lambda \times T_i\]</span>
<span class="math display">\[\log(\lambda) = \alpha\]</span></p>
<ul>
<li><span class="math inline">\(\alpha\)</span> is the log rate; <span class="math inline">\(\exp(\alpha)\)</span> is the rate (on its original scale).</li>
</ul>
<p><strong>2. Two-sample Poisson Model (treatment vs control groups)</strong></p>
<ul>
<li>Now if we assume the underlying rate of events is <strong>not the same</strong> for everyone and that it’s associated with some covariates (e.g., treatment)
<ul>
<li>Interested in the effect of treatment (<span class="math inline">\(TRT_i=0 , 1\)</span>)</li>
</ul></li>
<li>Assume a rate <span class="math inline">\(\lambda_i\)</span> that depends on the treatment received by subject <span class="math inline">\(i\)</span>, our model updated to</li>
</ul>
<p><span class="math display">\[Y_i \sim Poisson(\theta_i)\]</span>
<span class="math display">\[\theta_i = \lambda_i \times T_i\]</span>
<span class="math display">\[\log(\lambda_i) = \alpha + \beta \times TRT_i\]</span></p>
<ul>
<li>Given the model above, we can compare rate between treated (t) and controls (c)
<ul>
<li>Observe <span class="math inline">\(Y_c\)</span> events in 110 person-years in the control group</li>
</ul></li>
</ul>
<p><span class="math display">\[Y_c \sim Poisson(\theta_c)\]</span>
<span class="math display">\[\theta_c = \lambda_c \times 110 \]</span>
<span class="math display">\[\log(\lambda_c) = \alpha\]</span>
- Observe <span class="math inline">\(Y_t\)</span> events in 100 person-years in the treated group</p>
<p><span class="math display">\[Y_t \sim Poisson(\theta_t)\]</span>
<span class="math display">\[\theta_t = \lambda_t \times 100 \]</span>
<span class="math display">\[\log(\lambda_t) = \alpha + \beta\]</span></p>
<ul>
<li>Comparing the two models we have</li>
</ul>
<p><span class="math display">\[\log(\lambda_t) - \log(\lambda_c) = \log(\frac{\lambda_t}{\lambda_c}) = \beta\]</span></p>
<ul>
<li>where <span class="math inline">\(\beta\)</span> is interpreted as log <em>rate ratio</em>.</li>
</ul>
<p><strong>The concept of “offset”</strong></p>
<ul>
<li>In this example, the Observe <span class="math inline">\(Y_c\)</span> events in 110 person-years in the control group</li>
</ul>
<p><span class="math display">\[\theta_c = \lambda_c \times 110 \]</span>
<span class="math display">\[\log(\theta_c) =  \log(\lambda_c) + \log(110) \]</span></p>
<ul>
<li>and more generally we have</li>
</ul>
<p><span class="math display">\[Y_i \sim Poisson(\theta_i)\]</span>
<span class="math display">\[\theta_i = \lambda \times T_i\]</span>
<span class="math display">\[\log(\theta_i) = \log(\lambda_i) + \log(T_i)\]</span>
<span class="math display">\[\log(\lambda_i) = \alpha + \beta \times TRT_i\]</span></p>
<ul>
<li><p>The natural log of time (<span class="math inline">\(\log (T_i)\)</span>) is is passed as the “offset” in brm (Bayesian model), glm and glmer models (frequentist model) for count data in R</p></li>
<li><p>We don’t estimate a parameter for the effect of log time - it is treated differently from other predictors (like age, for example)</p></li>
<li><p><strong>It is the log(rate), not the log(mean) that is modelled linearly by the predictors</strong></p></li>
<li><p>If the times are all equal to the same value TIME for participants, the offset can be omitted and the effects are for the rate per TIME</p></li>
</ul>
<div class="sourceCode" id="cb222"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb222-1"><a href="BayesReg2.html#cb222-1" aria-hidden="true" tabindex="-1"></a><span class="co">#example code for Poisson regression in brms;</span></span>
<span id="cb222-2"><a href="BayesReg2.html#cb222-2" aria-hidden="true" tabindex="-1"></a><span class="fu">brm</span>(y <span class="sc">~</span> <span class="dv">1</span> <span class="sc">+</span> <span class="fu">offset</span>(<span class="fu">log</span>(Time)),</span>
<span id="cb222-3"><a href="BayesReg2.html#cb222-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> dat,</span>
<span id="cb222-4"><a href="BayesReg2.html#cb222-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">family =</span> <span class="st">&quot;poisson&quot;</span>,</span>
<span id="cb222-5"><a href="BayesReg2.html#cb222-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">prior =</span> <span class="fu">c</span>(<span class="fu">prior</span>(<span class="fu">normal</span>(<span class="dv">0</span>, <span class="dv">100</span>), <span class="at">class =</span> <span class="st">&quot;Intercept&quot;</span>)),</span>
<span id="cb222-6"><a href="BayesReg2.html#cb222-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">chains =</span> <span class="dv">4</span>,</span>
<span id="cb222-7"><a href="BayesReg2.html#cb222-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">iter =</span> <span class="dv">10000</span>,</span>
<span id="cb222-8"><a href="BayesReg2.html#cb222-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">warmup =</span> <span class="dv">8000</span>,</span>
<span id="cb222-9"><a href="BayesReg2.html#cb222-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">cores =</span> <span class="dv">4</span>)</span></code></pre></div>
<div class="important">
<p><strong>Poisson regression model</strong></p>
<ul>
<li>Consider the poisson regression model on <span class="math inline">\(Y\)</span> with covariates <span class="math inline">\(X_1, \ldots, X_p\)</span> and offset <span class="math inline">\(T\)</span> (time), where</li>
</ul>
<p><span class="math display">\[ Y_i \mid \beta_0, \beta_1, \ldots, \beta_p \sim Pois(\lambda_i T_i)\]</span></p>
<p><span class="math display">\[ \log(\lambda_i) =  \beta_0 + \beta_1 X_{i1} + \ldots + \beta_p X_{ip}\]</span></p>
<ul>
<li><p>The regression coefficients can be interpreted as log relative risk.</p></li>
<li><p>Furthermore, we can recalculate expected number of event over a period of time <span class="math inline">\(T\)</span> using the exponential function,</p></li>
</ul>
<p><span class="math display">\[\lambda_i \times T = \exp(\beta_0 + \beta_1 X_{i1} + \ldots + \beta_p X_{ip}) \times T\]</span></p>
<ul>
<li>Assumptions of logistic regression models
<ol style="list-style-type: decimal">
<li><strong>Independent observations</strong>. This assumption can be modified if working with clustered data.</li>
<li><strong>Linear relationship between continuous covariates and log-rate</strong></li>
<li><strong>No over-dispersion</strong> For Poisson distributed variable, we have its mean equals to its variance. Thus, conditioning on predictors <span class="math inline">\(X\)</span>, the expected value of <span class="math inline">\(Y\)</span> should be roughly equivalent to the variability in <span class="math inline">\(Y\)</span>. If this assumption is violated, we can consider fitting a negative binomial regression model by allowing the variance to be different (larger) from the mean. We can use waic and loo to determine if the negative binomial model is of better fit than the Poisson model.</li>
<li><strong>No zero-inflation</strong> When we observe majority of our study subjects with zero number of events over time, we call this data with an excess number of zeroes (zero-inflation). When we have excess zeroes in our count data, we can consider fitting a zero-inflated Poisson or a zero-inflated negative binomial regression model. We can use loo to determine if the zero-inflated models are of better fit than the Poisson model.
<ul>
<li>e.g., the number of hospitalizations a health 20-25 years old person experiences in a year</li>
</ul></li>
<li><strong>Multicollinearity</strong> Multicollinearity is the phenomenon when a number of the explanatory variables are strongly correlated.</li>
<li><strong>Correctly specified regression model</strong> We can use posterior predictive distribution to check for regression fit between different models and can also use WAIC and LOO to compare them.</li>
</ol></li>
</ul>
</div>
<p><strong>Modelling Falls and Fall-Related Injuries in Older Dialysis Patients in brms</strong></p>
<ul>
<li><p>This example is taken from <span class="citation">(<a href="#ref-cook2006falls" role="doc-biblioref">Cook et al. 2006</a>)</span>. We included two covariates from the original data for demonstration purpose.</p></li>
<li><p>This is a dataset looking at the number of episodes of falling over a year
by dialysis patients</p></li>
<li><p>Not all subjects had a full year of follow-up; some dropped out</p></li>
<li><p>We can account for differing follow-up using a Poisson regression model with
follow-up time as an “offset.”</p></li>
<li><p>To illustrate, we will use only two predictors: female sex, coded as 0/1, and
history of previous falls, also coded as 0/1</p>
<ul>
<li>Displaying the first 10 observations:</li>
</ul></li>
</ul>
<div class="sourceCode" id="cb223"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb223-1"><a href="BayesReg2.html#cb223-1" aria-hidden="true" tabindex="-1"></a>dat <span class="ot">&lt;-</span> <span class="fu">read.table</span>(<span class="st">&quot;data/fallsData.txt&quot;</span>,<span class="at">header=</span>T, <span class="at">sep=</span><span class="st">&quot;&quot;</span>)</span>
<span id="cb223-2"><a href="BayesReg2.html#cb223-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb223-3"><a href="BayesReg2.html#cb223-3" aria-hidden="true" tabindex="-1"></a>dat[<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>,] <span class="sc">%&gt;%</span></span>
<span id="cb223-4"><a href="BayesReg2.html#cb223-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">datatable</span>(</span>
<span id="cb223-5"><a href="BayesReg2.html#cb223-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">rownames =</span> T,</span>
<span id="cb223-6"><a href="BayesReg2.html#cb223-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">class =</span> <span class="st">&quot;compact&quot;</span>,</span>
<span id="cb223-7"><a href="BayesReg2.html#cb223-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">options =</span> <span class="fu">list</span>(</span>
<span id="cb223-8"><a href="BayesReg2.html#cb223-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">dom =</span> <span class="st">&#39;t&#39;</span>,</span>
<span id="cb223-9"><a href="BayesReg2.html#cb223-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">ordering =</span> <span class="cn">FALSE</span>,</span>
<span id="cb223-10"><a href="BayesReg2.html#cb223-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">paging =</span> <span class="cn">FALSE</span>,</span>
<span id="cb223-11"><a href="BayesReg2.html#cb223-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">searching =</span> <span class="cn">FALSE</span>,</span>
<span id="cb223-12"><a href="BayesReg2.html#cb223-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">columnDefs =</span> <span class="fu">list</span>(<span class="fu">list</span>(<span class="at">className =</span> <span class="st">&#39;dt-center&#39;</span>, </span>
<span id="cb223-13"><a href="BayesReg2.html#cb223-13" aria-hidden="true" tabindex="-1"></a>                      <span class="at">targets =</span> <span class="dv">0</span><span class="sc">:</span><span class="dv">3</span>))))</span></code></pre></div>
<div id="htmlwidget-aedfea8bd96ecff69a08" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-aedfea8bd96ecff69a08">{"x":{"filter":"none","vertical":false,"data":[["1","2","3","4","5","6","7","8","9","10"],[8,2,1,1,1,0,2,0,2,1],[1,0.63561644,1,1,0.4109589,1,1,1,1,1],[1,0,0,0,0,1,1,0,0,0],[0,0,0,1,0,0,0,0,1,0]],"container":"<table class=\"compact\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>falls<\/th>\n      <th>fu<\/th>\n      <th>FemaleSex<\/th>\n      <th>PrevFall<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"dom":"t","ordering":false,"paging":false,"searching":false,"columnDefs":[{"className":"dt-center","targets":[0,1,2,3]},{"className":"dt-right","targets":4},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
<ul>
<li>First let’s examine the summary statistics</li>
</ul>
<div class="sourceCode" id="cb224"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb224-1"><a href="BayesReg2.html#cb224-1" aria-hidden="true" tabindex="-1"></a>dat <span class="sc">%&gt;%</span> <span class="fu">tbl_summary</span>(</span>
<span id="cb224-2"><a href="BayesReg2.html#cb224-2" aria-hidden="true" tabindex="-1"></a>    <span class="at">statistic =</span> <span class="fu">list</span>(<span class="fu">all_continuous</span>() <span class="sc">~</span> <span class="st">&quot;{mean} ({sd})&quot;</span>,</span>
<span id="cb224-3"><a href="BayesReg2.html#cb224-3" aria-hidden="true" tabindex="-1"></a>                     <span class="fu">all_categorical</span>() <span class="sc">~</span> <span class="st">&quot;{n} / {N} ({p}%)&quot;</span>),</span>
<span id="cb224-4"><a href="BayesReg2.html#cb224-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">digits =</span> <span class="fu">all_continuous</span>() <span class="sc">~</span> <span class="dv">2</span>)</span></code></pre></div>
<div id="mdrqlkottv" style="overflow-x:auto;overflow-y:auto;width:auto;height:auto;">
<style>html {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Helvetica Neue', 'Fira Sans', 'Droid Sans', Arial, sans-serif;
}

#mdrqlkottv .gt_table {
  display: table;
  border-collapse: collapse;
  margin-left: auto;
  margin-right: auto;
  color: #333333;
  font-size: 16px;
  font-weight: normal;
  font-style: normal;
  background-color: #FFFFFF;
  width: auto;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #A8A8A8;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #A8A8A8;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
}

#mdrqlkottv .gt_heading {
  background-color: #FFFFFF;
  text-align: center;
  border-bottom-color: #FFFFFF;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#mdrqlkottv .gt_title {
  color: #333333;
  font-size: 125%;
  font-weight: initial;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-color: #FFFFFF;
  border-bottom-width: 0;
}

#mdrqlkottv .gt_subtitle {
  color: #333333;
  font-size: 85%;
  font-weight: initial;
  padding-top: 0;
  padding-bottom: 6px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-color: #FFFFFF;
  border-top-width: 0;
}

#mdrqlkottv .gt_bottom_border {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#mdrqlkottv .gt_col_headings {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#mdrqlkottv .gt_col_heading {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 6px;
  padding-left: 5px;
  padding-right: 5px;
  overflow-x: hidden;
}

#mdrqlkottv .gt_column_spanner_outer {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  padding-top: 0;
  padding-bottom: 0;
  padding-left: 4px;
  padding-right: 4px;
}

#mdrqlkottv .gt_column_spanner_outer:first-child {
  padding-left: 0;
}

#mdrqlkottv .gt_column_spanner_outer:last-child {
  padding-right: 0;
}

#mdrqlkottv .gt_column_spanner {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 5px;
  overflow-x: hidden;
  display: inline-block;
  width: 100%;
}

#mdrqlkottv .gt_group_heading {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
}

#mdrqlkottv .gt_empty_group_heading {
  padding: 0.5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: middle;
}

#mdrqlkottv .gt_from_md > :first-child {
  margin-top: 0;
}

#mdrqlkottv .gt_from_md > :last-child {
  margin-bottom: 0;
}

#mdrqlkottv .gt_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  margin: 10px;
  border-top-style: solid;
  border-top-width: 1px;
  border-top-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  overflow-x: hidden;
}

#mdrqlkottv .gt_stub {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
}

#mdrqlkottv .gt_stub_row_group {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
  vertical-align: top;
}

#mdrqlkottv .gt_row_group_first td {
  border-top-width: 2px;
}

#mdrqlkottv .gt_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#mdrqlkottv .gt_first_summary_row {
  border-top-style: solid;
  border-top-color: #D3D3D3;
}

#mdrqlkottv .gt_first_summary_row.thick {
  border-top-width: 2px;
}

#mdrqlkottv .gt_last_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#mdrqlkottv .gt_grand_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#mdrqlkottv .gt_first_grand_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-style: double;
  border-top-width: 6px;
  border-top-color: #D3D3D3;
}

#mdrqlkottv .gt_striped {
  background-color: rgba(128, 128, 128, 0.05);
}

#mdrqlkottv .gt_table_body {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#mdrqlkottv .gt_footnotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#mdrqlkottv .gt_footnote {
  margin: 0px;
  font-size: 90%;
  padding-left: 4px;
  padding-right: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

#mdrqlkottv .gt_sourcenotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#mdrqlkottv .gt_sourcenote {
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

#mdrqlkottv .gt_left {
  text-align: left;
}

#mdrqlkottv .gt_center {
  text-align: center;
}

#mdrqlkottv .gt_right {
  text-align: right;
  font-variant-numeric: tabular-nums;
}

#mdrqlkottv .gt_font_normal {
  font-weight: normal;
}

#mdrqlkottv .gt_font_bold {
  font-weight: bold;
}

#mdrqlkottv .gt_font_italic {
  font-style: italic;
}

#mdrqlkottv .gt_super {
  font-size: 65%;
}

#mdrqlkottv .gt_footnote_marks {
  font-style: italic;
  font-weight: normal;
  font-size: 75%;
  vertical-align: 0.4em;
}

#mdrqlkottv .gt_asterisk {
  font-size: 100%;
  vertical-align: 0;
}

#mdrqlkottv .gt_slash_mark {
  font-size: 0.7em;
  line-height: 0.7em;
  vertical-align: 0.15em;
}

#mdrqlkottv .gt_fraction_numerator {
  font-size: 0.6em;
  line-height: 0.6em;
  vertical-align: 0.45em;
}

#mdrqlkottv .gt_fraction_denominator {
  font-size: 0.6em;
  line-height: 0.6em;
  vertical-align: -0.05em;
}
</style>
<table class="gt_table">
  
  <thead class="gt_col_headings">
    <tr>
      <th class="gt_col_heading gt_columns_bottom_border gt_left" rowspan="1" colspan="1"><strong>Characteristic</strong></th>
      <th class="gt_col_heading gt_columns_bottom_border gt_center" rowspan="1" colspan="1"><strong>N = 162</strong><sup class="gt_footnote_marks">1</sup></th>
    </tr>
  </thead>
  <tbody class="gt_table_body">
    <tr><td class="gt_row gt_left">falls</td>
<td class="gt_row gt_center">1.54 (4.06)</td></tr>
    <tr><td class="gt_row gt_left">fu</td>
<td class="gt_row gt_center">0.90 (0.21)</td></tr>
    <tr><td class="gt_row gt_left">FemaleSex</td>
<td class="gt_row gt_center">70 / 162 (43%)</td></tr>
    <tr><td class="gt_row gt_left">PrevFall</td>
<td class="gt_row gt_center">54 / 162 (33%)</td></tr>
  </tbody>
  
  <tfoot class="gt_footnotes">
    <tr>
      <td class="gt_footnote" colspan="2"><sup class="gt_footnote_marks">1</sup> Mean (SD); n / N (%)</td>
    </tr>
  </tfoot>
</table>
</div>
<div class="sourceCode" id="cb225"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb225-1"><a href="BayesReg2.html#cb225-1" aria-hidden="true" tabindex="-1"></a><span class="co"># creating a subject ID;</span></span>
<span id="cb225-2"><a href="BayesReg2.html#cb225-2" aria-hidden="true" tabindex="-1"></a>dat<span class="sc">$</span>Subject <span class="ot">&lt;-</span> <span class="fu">factor</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(dat))</span>
<span id="cb225-3"><a href="BayesReg2.html#cb225-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb225-4"><a href="BayesReg2.html#cb225-4" aria-hidden="true" tabindex="-1"></a>p1<span class="ot">&lt;-</span><span class="fu">ggplot</span>(dat, <span class="fu">aes</span>(<span class="at">x =</span> falls)) <span class="sc">+</span> </span>
<span id="cb225-5"><a href="BayesReg2.html#cb225-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(<span class="at">color =</span> <span class="st">&quot;white&quot;</span>, <span class="at">breaks =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">40</span>, <span class="at">by =</span> <span class="dv">1</span>)) <span class="sc">+</span></span>
<span id="cb225-6"><a href="BayesReg2.html#cb225-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="st">&quot;Histogram of the number of falls over a year&quot;</span>)<span class="sc">+</span></span>
<span id="cb225-7"><a href="BayesReg2.html#cb225-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">&quot;frequency&quot;</span>)<span class="sc">+</span></span>
<span id="cb225-8"><a href="BayesReg2.html#cb225-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>()</span>
<span id="cb225-9"><a href="BayesReg2.html#cb225-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb225-10"><a href="BayesReg2.html#cb225-10" aria-hidden="true" tabindex="-1"></a>p2<span class="ot">&lt;-</span><span class="fu">ggplot</span>(dat, <span class="fu">aes</span>(<span class="at">x =</span> fu)) <span class="sc">+</span> </span>
<span id="cb225-11"><a href="BayesReg2.html#cb225-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(<span class="at">color =</span> <span class="st">&quot;white&quot;</span>, <span class="at">bins =</span> <span class="dv">20</span>) <span class="sc">+</span></span>
<span id="cb225-12"><a href="BayesReg2.html#cb225-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="st">&quot;Histogram of follow-up times&quot;</span>)<span class="sc">+</span></span>
<span id="cb225-13"><a href="BayesReg2.html#cb225-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">&quot;frequency&quot;</span>)<span class="sc">+</span></span>
<span id="cb225-14"><a href="BayesReg2.html#cb225-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">&quot;follow-up times&quot;</span>)<span class="sc">+</span></span>
<span id="cb225-15"><a href="BayesReg2.html#cb225-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>()</span>
<span id="cb225-16"><a href="BayesReg2.html#cb225-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb225-17"><a href="BayesReg2.html#cb225-17" aria-hidden="true" tabindex="-1"></a><span class="fu">ggarrange</span>(p1,p2, <span class="at">nrow=</span><span class="dv">1</span>, <span class="at">ncol =</span> <span class="dv">2</span>)</span></code></pre></div>
<p><img src="bayes_bookdown_files/figure-html/unnamed-chunk-172-1.png" width="864" style="display: block; margin: auto;" /></p>
<ul>
<li>Now let choose priors using normal distribution. In this example, let’s consider informative priors!
<ol style="list-style-type: decimal">
<li>It is unlikely that females have a fall rate less than 1/3 times or more than 3 times the rate in males</li>
</ol></li>
</ul>
<p><span class="math display">\[P(\frac{1}{3} &lt; RR_{female} &lt; 3) = 95\%\]</span>
<span class="math display">\[P(\log(\frac{1}{3}) &lt; log(RR_{female}) &lt; log(3)) = 95\%\]</span>
<span class="math display">\[\text{Prior Mean}(\log RR_{female}) = \frac{\log(\frac{1}{3})+log(3)}{2} = 0 \text{ (midpoint)}\]</span>
<span class="math display">\[\text{Prior SD}(\log RR_{female}) = \frac{log(3) - \log(\frac{1}{3})}{1.96 \times 2} = 0.56 \]</span>
2. Previous falls are a known risk factor for current falls, so we use a prior that puts most weight on <span class="math inline">\(RR_{prevfall}&gt;1\)</span></p>
<p><span class="math display">\[P(0.75 &lt; RR_{prevfall} &lt; 4) = 95\%\]</span>
<span class="math display">\[P(\log(0.75) &lt; log(RR_{prevfall}) &lt; log(4)) = 95\%\]</span>
<span class="math display">\[\text{Prior Mean}(\log RR_{prevfall}) = \frac{\log(0.75)+log(3)}{2} = 0.55 \text{ (midpoint)}\]</span>
<span class="math display">\[\text{Prior SD}(\log RR_{prevfall}) = \frac{log(4) - \log(0.75)}{1.96 \times 2} = 0.43 \]</span></p>
<div class="sourceCode" id="cb226"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb226-1"><a href="BayesReg2.html#cb226-1" aria-hidden="true" tabindex="-1"></a><span class="co">#sex;</span></span>
<span id="cb226-2"><a href="BayesReg2.html#cb226-2" aria-hidden="true" tabindex="-1"></a>s<span class="ot">&lt;-</span>(<span class="fu">log</span>(<span class="dv">3</span>) <span class="sc">-</span> <span class="fu">log</span>(<span class="dv">1</span><span class="sc">/</span><span class="dv">3</span>))<span class="sc">/</span>(<span class="fl">1.96</span><span class="sc">*</span><span class="dv">2</span>)</span>
<span id="cb226-3"><a href="BayesReg2.html#cb226-3" aria-hidden="true" tabindex="-1"></a>m <span class="ot">&lt;-</span> (<span class="fu">log</span>(<span class="dv">3</span>) <span class="sc">+</span> <span class="fu">log</span>(<span class="dv">1</span><span class="sc">/</span><span class="dv">3</span>))<span class="sc">/</span><span class="dv">2</span></span>
<span id="cb226-4"><a href="BayesReg2.html#cb226-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb226-5"><a href="BayesReg2.html#cb226-5" aria-hidden="true" tabindex="-1"></a>p1<span class="ot">&lt;-</span><span class="fu">data.frame</span>(<span class="at">RR =</span> <span class="fu">seq</span>(<span class="dv">0</span>,<span class="dv">7</span>,<span class="at">length=</span><span class="dv">501</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb226-6"><a href="BayesReg2.html#cb226-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">p =</span> <span class="fu">dlnorm</span>(RR, <span class="at">meanlog =</span> m, <span class="at">sdlog =</span> s)) <span class="sc">%&gt;%</span></span>
<span id="cb226-7"><a href="BayesReg2.html#cb226-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Region =</span> <span class="fu">ifelse</span>(RR<span class="sc">&lt;=</span><span class="dv">1</span>, <span class="st">&quot;RR&lt;1&quot;</span>,<span class="st">&quot;RR&gt;1&quot;</span>))<span class="sc">%&gt;%</span></span>
<span id="cb226-8"><a href="BayesReg2.html#cb226-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(RR, p))<span class="sc">+</span></span>
<span id="cb226-9"><a href="BayesReg2.html#cb226-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>()<span class="sc">+</span></span>
<span id="cb226-10"><a href="BayesReg2.html#cb226-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_area</span>(<span class="fu">aes</span>(<span class="at">fill=</span>Region),<span class="at">alpha=</span><span class="fl">0.7</span>)<span class="sc">+</span></span>
<span id="cb226-11"><a href="BayesReg2.html#cb226-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>()<span class="sc">+</span></span>
<span id="cb226-12"><a href="BayesReg2.html#cb226-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values=</span> <span class="fu">c</span>(<span class="st">&quot;goldenrod&quot;</span>,<span class="st">&quot;steelblue&quot;</span>))<span class="sc">+</span></span>
<span id="cb226-13"><a href="BayesReg2.html#cb226-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="fu">paste0</span>(<span class="st">&quot;Prior RR for sex; P(RR&lt;1)=&quot;</span>,</span>
<span id="cb226-14"><a href="BayesReg2.html#cb226-14" aria-hidden="true" tabindex="-1"></a>                 <span class="fu">round</span>(<span class="dv">100</span><span class="sc">*</span><span class="fu">plnorm</span>(<span class="dv">1</span>,m,s)),<span class="st">&quot;%&quot;</span>))<span class="sc">+</span></span>
<span id="cb226-15"><a href="BayesReg2.html#cb226-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">&quot;p(RR)&quot;</span>)<span class="sc">+</span></span>
<span id="cb226-16"><a href="BayesReg2.html#cb226-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">breaks=</span><span class="dv">0</span><span class="sc">:</span><span class="dv">7</span>)<span class="sc">+</span></span>
<span id="cb226-17"><a href="BayesReg2.html#cb226-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>()</span>
<span id="cb226-18"><a href="BayesReg2.html#cb226-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb226-19"><a href="BayesReg2.html#cb226-19" aria-hidden="true" tabindex="-1"></a><span class="co">#previous falls</span></span>
<span id="cb226-20"><a href="BayesReg2.html#cb226-20" aria-hidden="true" tabindex="-1"></a>s<span class="ot">&lt;-</span>(<span class="fu">log</span>(<span class="dv">4</span>) <span class="sc">-</span> <span class="fu">log</span>(<span class="fl">0.75</span>))<span class="sc">/</span><span class="fl">3.92</span></span>
<span id="cb226-21"><a href="BayesReg2.html#cb226-21" aria-hidden="true" tabindex="-1"></a>m <span class="ot">&lt;-</span> (<span class="fu">log</span>(<span class="dv">4</span>) <span class="sc">+</span> <span class="fu">log</span>(<span class="fl">0.75</span>))<span class="sc">/</span><span class="dv">2</span></span>
<span id="cb226-22"><a href="BayesReg2.html#cb226-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb226-23"><a href="BayesReg2.html#cb226-23" aria-hidden="true" tabindex="-1"></a>p2<span class="ot">&lt;-</span><span class="fu">data.frame</span>(<span class="at">RR =</span> <span class="fu">seq</span>(<span class="dv">0</span>,<span class="dv">7</span>,<span class="at">length=</span><span class="dv">501</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb226-24"><a href="BayesReg2.html#cb226-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">p =</span> <span class="fu">dlnorm</span>(RR, <span class="at">meanlog =</span> m, <span class="at">sdlog =</span> s)) <span class="sc">%&gt;%</span></span>
<span id="cb226-25"><a href="BayesReg2.html#cb226-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Region =</span> <span class="fu">ifelse</span>(RR<span class="sc">&lt;=</span><span class="dv">1</span>, <span class="st">&quot;RR&lt;1&quot;</span>,<span class="st">&quot;RR&gt;1&quot;</span>))<span class="sc">%&gt;%</span></span>
<span id="cb226-26"><a href="BayesReg2.html#cb226-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(RR, p))<span class="sc">+</span></span>
<span id="cb226-27"><a href="BayesReg2.html#cb226-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>()<span class="sc">+</span></span>
<span id="cb226-28"><a href="BayesReg2.html#cb226-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_area</span>(<span class="fu">aes</span>(<span class="at">fill=</span>Region),<span class="at">alpha=</span><span class="fl">0.7</span>)<span class="sc">+</span></span>
<span id="cb226-29"><a href="BayesReg2.html#cb226-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>()<span class="sc">+</span></span>
<span id="cb226-30"><a href="BayesReg2.html#cb226-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values=</span> <span class="fu">c</span>(<span class="st">&quot;goldenrod&quot;</span>,<span class="st">&quot;steelblue&quot;</span>))<span class="sc">+</span></span>
<span id="cb226-31"><a href="BayesReg2.html#cb226-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="fu">paste0</span>(<span class="st">&quot;Prior RR for prevfall; P(RR&lt;1)=&quot;</span>,</span>
<span id="cb226-32"><a href="BayesReg2.html#cb226-32" aria-hidden="true" tabindex="-1"></a>                 <span class="fu">round</span>(<span class="dv">100</span><span class="sc">*</span><span class="fu">plnorm</span>(<span class="dv">1</span>,m,s)),<span class="st">&quot;%&quot;</span>))<span class="sc">+</span></span>
<span id="cb226-33"><a href="BayesReg2.html#cb226-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">&quot;p(RR)&quot;</span>)<span class="sc">+</span></span>
<span id="cb226-34"><a href="BayesReg2.html#cb226-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">breaks=</span><span class="dv">0</span><span class="sc">:</span><span class="dv">7</span>)<span class="sc">+</span></span>
<span id="cb226-35"><a href="BayesReg2.html#cb226-35" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>()</span>
<span id="cb226-36"><a href="BayesReg2.html#cb226-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb226-37"><a href="BayesReg2.html#cb226-37" aria-hidden="true" tabindex="-1"></a><span class="fu">ggarrange</span>(p1,p2,<span class="at">nrow =</span> <span class="dv">1</span>, <span class="at">ncol=</span><span class="dv">2</span>)</span></code></pre></div>
<p><img src="bayes_bookdown_files/figure-html/unnamed-chunk-173-1.png" width="864" style="display: block; margin: auto;" /></p>
<ul>
<li><strong>Model 1. Simple Poisson Model</strong></li>
</ul>
<div class="sourceCode" id="cb227"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb227-1"><a href="BayesReg2.html#cb227-1" aria-hidden="true" tabindex="-1"></a>model1 <span class="ot">&lt;-</span> <span class="fu">brm</span>(falls <span class="sc">~</span> FemaleSex <span class="sc">+</span> PrevFall <span class="sc">+</span> <span class="fu">offset</span>(<span class="fu">log</span>(fu)),</span>
<span id="cb227-2"><a href="BayesReg2.html#cb227-2" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> dat, </span>
<span id="cb227-3"><a href="BayesReg2.html#cb227-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">family =</span> <span class="st">&quot;poisson&quot;</span>,</span>
<span id="cb227-4"><a href="BayesReg2.html#cb227-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">sample_prior=</span>T,</span>
<span id="cb227-5"><a href="BayesReg2.html#cb227-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">prior =</span> <span class="fu">c</span>(<span class="fu">prior</span>(<span class="fu">normal</span>(<span class="dv">0</span>, <span class="dv">100</span>), <span class="at">class =</span> <span class="st">&quot;Intercept&quot;</span>),</span>
<span id="cb227-6"><a href="BayesReg2.html#cb227-6" aria-hidden="true" tabindex="-1"></a>              <span class="fu">prior</span>(<span class="fu">normal</span>(<span class="dv">0</span>, <span class="fl">0.56</span>), <span class="at">class =</span> <span class="st">&quot;b&quot;</span>, <span class="at">coef=</span>FemaleSex),</span>
<span id="cb227-7"><a href="BayesReg2.html#cb227-7" aria-hidden="true" tabindex="-1"></a>              <span class="fu">prior</span>(<span class="fu">normal</span>(<span class="fl">0.55</span>, <span class="fl">0.43</span>), <span class="at">class =</span> <span class="st">&quot;b&quot;</span>, <span class="at">coef=</span>PrevFall)),</span>
<span id="cb227-8"><a href="BayesReg2.html#cb227-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">chains =</span> <span class="dv">4</span>, </span>
<span id="cb227-9"><a href="BayesReg2.html#cb227-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">iter =</span> <span class="dv">7500</span>, </span>
<span id="cb227-10"><a href="BayesReg2.html#cb227-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">warmup =</span> <span class="dv">5000</span>, </span>
<span id="cb227-11"><a href="BayesReg2.html#cb227-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">cores =</span> <span class="dv">4</span>,</span>
<span id="cb227-12"><a href="BayesReg2.html#cb227-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">seed =</span> <span class="dv">123</span>, </span>
<span id="cb227-13"><a href="BayesReg2.html#cb227-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">silent =</span> <span class="dv">2</span>,</span>
<span id="cb227-14"><a href="BayesReg2.html#cb227-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">refresh =</span> <span class="dv">0</span>)</span>
<span id="cb227-15"><a href="BayesReg2.html#cb227-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb227-16"><a href="BayesReg2.html#cb227-16" aria-hidden="true" tabindex="-1"></a><span class="co"># saveRDS(model1, &quot;data/chap8_poisson_1&quot;)</span></span></code></pre></div>
<ul>
<li>Posterior summary</li>
</ul>
<div class="sourceCode" id="cb228"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb228-1"><a href="BayesReg2.html#cb228-1" aria-hidden="true" tabindex="-1"></a>model1 <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">&quot;data/chap8_poisson_1&quot;</span>)</span>
<span id="cb228-2"><a href="BayesReg2.html#cb228-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(model1)</span></code></pre></div>
<p><img src="bayes_bookdown_files/figure-html/unnamed-chunk-175-1.png" width="672" style="display: block; margin: auto;" /></p>
<div class="sourceCode" id="cb229"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb229-1"><a href="BayesReg2.html#cb229-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(model1)</span></code></pre></div>
<pre><code>##  Family: poisson 
##   Links: mu = log 
## Formula: falls ~ FemaleSex + PrevFall + offset(log(fu)) 
##    Data: dat (Number of observations: 162) 
##   Draws: 4 chains, each with iter = 7500; warmup = 5000; thin = 1;
##          total post-warmup draws = 10000
## 
## Population-Level Effects: 
##           Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
## Intercept     0.21      0.11    -0.01     0.41 1.00     6546     6507
## FemaleSex    -0.54      0.13    -0.81    -0.28 1.00     7598     7313
## PrevFall      1.10      0.13     0.86     1.35 1.00     6788     6892
## 
## Draws were sampled using sampling(NUTS). For each parameter, Bulk_ESS
## and Tail_ESS are effective sample size measures, and Rhat is the potential
## scale reduction factor on split chains (at convergence, Rhat = 1).</code></pre>
<ul>
<li>Comparing prior and posterior</li>
</ul>
<div class="sourceCode" id="cb231"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb231-1"><a href="BayesReg2.html#cb231-1" aria-hidden="true" tabindex="-1"></a>s1 <span class="ot">&lt;-</span> <span class="fu">posterior_samples</span>(model1)</span>
<span id="cb231-2"><a href="BayesReg2.html#cb231-2" aria-hidden="true" tabindex="-1"></a>p1 <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">RR_female =</span> <span class="fu">c</span>(<span class="fu">exp</span>(s1[,<span class="st">&quot;b_FemaleSex&quot;</span>]),</span>
<span id="cb231-3"><a href="BayesReg2.html#cb231-3" aria-hidden="true" tabindex="-1"></a>                         <span class="fu">exp</span>(s1[,<span class="st">&quot;prior_b_FemaleSex&quot;</span>])),</span>
<span id="cb231-4"><a href="BayesReg2.html#cb231-4" aria-hidden="true" tabindex="-1"></a>           <span class="at">Type=</span><span class="fu">rep</span>(<span class="fu">c</span>(<span class="st">&quot;Posterior&quot;</span>,<span class="st">&quot;Prior&quot;</span>),</span>
<span id="cb231-5"><a href="BayesReg2.html#cb231-5" aria-hidden="true" tabindex="-1"></a>                    <span class="at">each=</span><span class="fu">nrow</span>(s1))) <span class="sc">%&gt;%</span></span>
<span id="cb231-6"><a href="BayesReg2.html#cb231-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x=</span>RR_female,<span class="at">fill=</span>Type))<span class="sc">+</span></span>
<span id="cb231-7"><a href="BayesReg2.html#cb231-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_density</span>(<span class="at">size=</span><span class="dv">1</span>,<span class="at">alpha=</span><span class="fl">0.5</span>)<span class="sc">+</span></span>
<span id="cb231-8"><a href="BayesReg2.html#cb231-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlim</span>(<span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">3</span>))<span class="sc">+</span></span>
<span id="cb231-9"><a href="BayesReg2.html#cb231-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylim</span>(<span class="fu">c</span>(<span class="dv">0</span>,<span class="fl">5.5</span>))<span class="sc">+</span></span>
<span id="cb231-10"><a href="BayesReg2.html#cb231-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title=</span><span class="st">&quot;Prior: log(RR) ~ N(0,0.56)&quot;</span>)<span class="sc">+</span></span>
<span id="cb231-11"><a href="BayesReg2.html#cb231-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>()<span class="sc">+</span></span>
<span id="cb231-12"><a href="BayesReg2.html#cb231-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values=</span><span class="fu">c</span>(<span class="st">&quot;goldenrod&quot;</span>,<span class="st">&quot;steelblue&quot;</span>))</span>
<span id="cb231-13"><a href="BayesReg2.html#cb231-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb231-14"><a href="BayesReg2.html#cb231-14" aria-hidden="true" tabindex="-1"></a>p2 <span class="ot">&lt;-</span><span class="fu">data.frame</span>(<span class="at">RR_PrevFall =</span> <span class="fu">c</span>(<span class="fu">exp</span>(s1[,<span class="st">&quot;b_PrevFall&quot;</span>]),</span>
<span id="cb231-15"><a href="BayesReg2.html#cb231-15" aria-hidden="true" tabindex="-1"></a>                         <span class="fu">exp</span>(s1[,<span class="st">&quot;prior_b_PrevFall&quot;</span>])),</span>
<span id="cb231-16"><a href="BayesReg2.html#cb231-16" aria-hidden="true" tabindex="-1"></a>           <span class="at">Type=</span><span class="fu">rep</span>(<span class="fu">c</span>(<span class="st">&quot;Posterior&quot;</span>,<span class="st">&quot;Prior&quot;</span>),<span class="at">each=</span><span class="fu">nrow</span>(s1))) <span class="sc">%&gt;%</span></span>
<span id="cb231-17"><a href="BayesReg2.html#cb231-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x=</span>RR_PrevFall,<span class="at">fill=</span>Type))<span class="sc">+</span></span>
<span id="cb231-18"><a href="BayesReg2.html#cb231-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_density</span>(<span class="at">size=</span><span class="dv">1</span>,<span class="at">alpha=</span><span class="fl">0.5</span>)<span class="sc">+</span></span>
<span id="cb231-19"><a href="BayesReg2.html#cb231-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlim</span>(<span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">5</span>))<span class="sc">+</span></span>
<span id="cb231-20"><a href="BayesReg2.html#cb231-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylim</span>(<span class="fu">c</span>(<span class="dv">0</span>,<span class="fl">1.5</span>))<span class="sc">+</span></span>
<span id="cb231-21"><a href="BayesReg2.html#cb231-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title=</span><span class="st">&quot;Prior: log(RR) ~ N(0.55,0.43)&quot;</span>)<span class="sc">+</span></span>
<span id="cb231-22"><a href="BayesReg2.html#cb231-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>()<span class="sc">+</span></span>
<span id="cb231-23"><a href="BayesReg2.html#cb231-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values=</span><span class="fu">c</span>(<span class="st">&quot;goldenrod&quot;</span>,<span class="st">&quot;steelblue&quot;</span>))</span>
<span id="cb231-24"><a href="BayesReg2.html#cb231-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb231-25"><a href="BayesReg2.html#cb231-25" aria-hidden="true" tabindex="-1"></a><span class="fu">ggarrange</span>(p1,p2,<span class="at">nrow=</span><span class="dv">1</span>, <span class="at">ncol=</span><span class="dv">2</span>)</span></code></pre></div>
<p><img src="bayes_bookdown_files/figure-html/unnamed-chunk-176-1.png" width="864" style="display: block; margin: auto;" /></p>
<ul>
<li>We are interested in computing the posterior distributions for the rate ratios</li>
</ul>
<div class="sourceCode" id="cb232"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb232-1"><a href="BayesReg2.html#cb232-1" aria-hidden="true" tabindex="-1"></a>beta <span class="ot">&lt;-</span> <span class="fu">data.matrix</span>(s1[,<span class="fu">c</span>(<span class="st">&quot;b_Intercept&quot;</span>,<span class="st">&quot;b_FemaleSex&quot;</span>,<span class="st">&quot;b_PrevFall&quot;</span>)])</span>
<span id="cb232-2"><a href="BayesReg2.html#cb232-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb232-3"><a href="BayesReg2.html#cb232-3" aria-hidden="true" tabindex="-1"></a>my.summary <span class="ot">&lt;-</span> <span class="cf">function</span>(x){</span>
<span id="cb232-4"><a href="BayesReg2.html#cb232-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">round</span>(<span class="fu">c</span>(<span class="at">Mean=</span><span class="fu">mean</span>(x), <span class="at">Median=</span><span class="fu">median</span>(x), <span class="at">low=</span><span class="fu">quantile</span>(x,<span class="fl">0.025</span>), <span class="at">high=</span><span class="fu">quantile</span>(x, <span class="fl">0.975</span>)),<span class="dv">2</span>)</span>
<span id="cb232-5"><a href="BayesReg2.html#cb232-5" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb232-6"><a href="BayesReg2.html#cb232-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb232-7"><a href="BayesReg2.html#cb232-7" aria-hidden="true" tabindex="-1"></a><span class="fu">t</span>(<span class="fu">apply</span>(<span class="fu">exp</span>(beta),<span class="dv">2</span>,my.summary))</span></code></pre></div>
<pre><code>##             Mean Median low.2.5% high.97.5%
## b_Intercept 1.23   1.23     0.99       1.51
## b_FemaleSex 0.59   0.59     0.45       0.76
## b_PrevFall  3.04   3.01     2.37       3.86</code></pre>
<ul>
<li>suppose we are interested in predicting fall rates per year for the four types of subjects defined by sex and previous fall</li>
</ul>
<div class="sourceCode" id="cb234"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb234-1"><a href="BayesReg2.html#cb234-1" aria-hidden="true" tabindex="-1"></a><span class="co"># design matrix!</span></span>
<span id="cb234-2"><a href="BayesReg2.html#cb234-2" aria-hidden="true" tabindex="-1"></a>X<span class="ot">&lt;-</span><span class="fu">cbind</span>(<span class="at">MaleNoFall=</span><span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">0</span>,<span class="dv">0</span>),</span>
<span id="cb234-3"><a href="BayesReg2.html#cb234-3" aria-hidden="true" tabindex="-1"></a>         <span class="at">FemaleNoFall=</span><span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">0</span>),</span>
<span id="cb234-4"><a href="BayesReg2.html#cb234-4" aria-hidden="true" tabindex="-1"></a>         <span class="at">MalePrevFall=</span><span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">0</span>,<span class="dv">1</span>),</span>
<span id="cb234-5"><a href="BayesReg2.html#cb234-5" aria-hidden="true" tabindex="-1"></a>         <span class="at">FemalePrevFall=</span><span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">1</span>))</span>
<span id="cb234-6"><a href="BayesReg2.html#cb234-6" aria-hidden="true" tabindex="-1"></a><span class="fu">row.names</span>(X) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;Intercept&quot;</span>,<span class="st">&quot;Female&quot;</span>,<span class="st">&quot;PrevFall&quot;</span>)</span>
<span id="cb234-7"><a href="BayesReg2.html#cb234-7" aria-hidden="true" tabindex="-1"></a>X</span></code></pre></div>
<pre><code>##           MaleNoFall FemaleNoFall MalePrevFall FemalePrevFall
## Intercept          1            1            1              1
## Female             0            1            0              1
## PrevFall           0            0            1              1</code></pre>
<div class="sourceCode" id="cb236"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb236-1"><a href="BayesReg2.html#cb236-1" aria-hidden="true" tabindex="-1"></a>Predictions <span class="ot">&lt;-</span> <span class="fu">exp</span>(beta <span class="sc">%*%</span> X)</span>
<span id="cb236-2"><a href="BayesReg2.html#cb236-2" aria-hidden="true" tabindex="-1"></a><span class="fu">t</span>(<span class="fu">apply</span>(Predictions,<span class="dv">2</span>,my.summary))</span></code></pre></div>
<pre><code>##                Mean Median low.2.5% high.97.5%
## MaleNoFall     1.23   1.23     0.99       1.51
## FemaleNoFall   0.72   0.72     0.55       0.93
## MalePrevFall   3.72   3.71     3.10       4.40
## FemalePrevFall 2.18   2.17     1.69       2.74</code></pre>
</div>
<div id="expanding-the-poisson-model" class="section level3 hasAnchor" number="7.2.2">
<h3><span class="header-section-number">7.2.2</span> Expanding the Poisson Model<a href="BayesReg2.html#expanding-the-poisson-model" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<ul>
<li>The standard Poisson model says that the only random variation is due to the Poisson sampling
<ul>
<li>i.e. all subjects with the same values of the predictors have the same rate</li>
</ul></li>
<li>The variance is equal to the mean and with more predictors, the same issue holds</li>
</ul>
<p><span class="math display">\[\log(\lambda_i) = \beta_0 + \sum \beta_j x_{ij}\]</span>
<span class="math display">\[ Y_i \sim Pois(\lambda_i T_i)\]</span></p>
<ul>
<li><p>All variability in the number of falls is either explained by the <span class="math inline">\(x_{ij}\)</span> or Poisson variability (there is no separate variance parameter)</p></li>
<li><p>This may be insufficient:</p>
<ul>
<li>“Extra-Poisson” variability is common - variability in excess of what the Poisson allows.</li>
<li>This could result from omission of important and unmeasured predictors of the rate</li>
<li>Clustering, by doctor, hospital, practice could induce additional variation</li>
<li>There may be real unexplainable random variation: <span class="math inline">\(\lambda_i\)</span> is only the average rate for subjects with characteristics defined by the <span class="math inline">\(x_{ij}\)</span></li>
</ul></li>
</ul>
<p><strong>Model 2. Expanding with Random Effect</strong></p>
<ul>
<li><p>As with the hospital mortality, seeds and RP models, we can include a random intercept for each individual</p></li>
<li><p>This allows that, on average, subjects with the same characteristics have the same rate</p></li>
<li><p>It also allows that some individuals have rates higher or lower than this</p></li>
<li><p>This mean that variation in the actual counts can be larger than their mean</p></li>
<li><p>The true log-rate for subject <span class="math inline">\(i\)</span> is somewhere near</p></li>
</ul>
<p><span class="math display">\[\log(\lambda_i) \approx \beta_0 + \sum \beta_j x_{ij}\]</span></p>
<ul>
<li>Add normal random effects to the regression</li>
</ul>
<p><span class="math display">\[\log(\lambda_i) \approx \beta_0 + \sum \beta_j x_{ij} + b_i\]</span>
<span class="math display">\[ b_i \sim N(0, \sigma_b)\]</span>
<span class="math display">\[ Y_i \sim Pois(\lambda_i T_i)\]</span></p>
<ul>
<li><p>we can again examine the posterior distribution of <span class="math inline">\(\sigma_b\)</span> to see if the random intercept added to the model is reasonable.</p></li>
<li><p>If <span class="math inline">\(\sigma_b\)</span> is small, the Poisson distribution explains the between subject variability well enough</p></li>
</ul>
<div class="sourceCode" id="cb238"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb238-1"><a href="BayesReg2.html#cb238-1" aria-hidden="true" tabindex="-1"></a>model2 <span class="ot">&lt;-</span> <span class="fu">brm</span>(falls <span class="sc">~</span> FemaleSex <span class="sc">+</span> PrevFall <span class="sc">+</span> <span class="fu">offset</span>(<span class="fu">log</span>(fu)) <span class="sc">+</span> (<span class="dv">1</span><span class="sc">|</span> Subject),</span>
<span id="cb238-2"><a href="BayesReg2.html#cb238-2" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> dat, </span>
<span id="cb238-3"><a href="BayesReg2.html#cb238-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">family =</span> <span class="st">&quot;poisson&quot;</span>,</span>
<span id="cb238-4"><a href="BayesReg2.html#cb238-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">sample_prior=</span>T,</span>
<span id="cb238-5"><a href="BayesReg2.html#cb238-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">prior =</span> <span class="fu">c</span>(<span class="fu">prior</span>(<span class="fu">normal</span>(<span class="dv">0</span>, <span class="dv">100</span>), <span class="at">class =</span> <span class="st">&quot;Intercept&quot;</span>),</span>
<span id="cb238-6"><a href="BayesReg2.html#cb238-6" aria-hidden="true" tabindex="-1"></a>              <span class="fu">prior</span>(<span class="fu">normal</span>(<span class="dv">0</span>, <span class="fl">0.56</span>), <span class="at">class =</span> <span class="st">&quot;b&quot;</span>, <span class="at">coef=</span>FemaleSex),</span>
<span id="cb238-7"><a href="BayesReg2.html#cb238-7" aria-hidden="true" tabindex="-1"></a>              <span class="fu">prior</span>(<span class="fu">normal</span>(<span class="fl">0.55</span>, <span class="fl">0.43</span>), <span class="at">class =</span> <span class="st">&quot;b&quot;</span>, <span class="at">coef=</span>PrevFall)),</span>
<span id="cb238-8"><a href="BayesReg2.html#cb238-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">chains =</span> <span class="dv">4</span>, </span>
<span id="cb238-9"><a href="BayesReg2.html#cb238-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">iter =</span> <span class="dv">7500</span>, </span>
<span id="cb238-10"><a href="BayesReg2.html#cb238-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">warmup =</span> <span class="dv">5000</span>, </span>
<span id="cb238-11"><a href="BayesReg2.html#cb238-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">cores =</span> <span class="dv">4</span>,</span>
<span id="cb238-12"><a href="BayesReg2.html#cb238-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">seed =</span> <span class="dv">123</span>, </span>
<span id="cb238-13"><a href="BayesReg2.html#cb238-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">silent =</span> <span class="dv">2</span>,</span>
<span id="cb238-14"><a href="BayesReg2.html#cb238-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">refresh =</span> <span class="dv">0</span>)</span>
<span id="cb238-15"><a href="BayesReg2.html#cb238-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb238-16"><a href="BayesReg2.html#cb238-16" aria-hidden="true" tabindex="-1"></a><span class="co"># saveRDS(model2, &quot;data/chap8_poisson_2&quot;)</span></span></code></pre></div>
<ul>
<li>Posterior summary</li>
</ul>
<div class="sourceCode" id="cb239"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb239-1"><a href="BayesReg2.html#cb239-1" aria-hidden="true" tabindex="-1"></a>model2 <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">&quot;data/chap8_poisson_2&quot;</span>)</span>
<span id="cb239-2"><a href="BayesReg2.html#cb239-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(model2)</span></code></pre></div>
<p><img src="bayes_bookdown_files/figure-html/unnamed-chunk-181-1.png" width="672" style="display: block; margin: auto;" /></p>
<div class="sourceCode" id="cb240"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb240-1"><a href="BayesReg2.html#cb240-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(model2)</span></code></pre></div>
<pre><code>##  Family: poisson 
##   Links: mu = log 
## Formula: falls ~ FemaleSex + PrevFall + offset(log(fu)) + (1 | Subject) 
##    Data: dat (Number of observations: 162) 
##   Draws: 4 chains, each with iter = 7500; warmup = 5000; thin = 1;
##          total post-warmup draws = 10000
## 
## Group-Level Effects: 
## ~Subject (Number of levels: 162) 
##               Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
## sd(Intercept)     1.47      0.17     1.18     1.83 1.00     3162     5040
## 
## Population-Level Effects: 
##           Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
## Intercept    -0.78      0.25    -1.31    -0.32 1.00     6717     7198
## FemaleSex    -0.46      0.28    -1.02     0.08 1.00     6607     7669
## PrevFall      0.93      0.26     0.42     1.43 1.00     6671     7458
## 
## Draws were sampled using sampling(NUTS). For each parameter, Bulk_ESS
## and Tail_ESS are effective sample size measures, and Rhat is the potential
## scale reduction factor on split chains (at convergence, Rhat = 1).</code></pre>
<ul>
<li>Comparing prior and posterior</li>
</ul>
<p><img src="bayes_bookdown_files/figure-html/unnamed-chunk-182-1.png" width="864" style="display: block; margin: auto;" /></p>
<ul>
<li>We are interested in computing the posterior distributions for the rate ratios</li>
</ul>
<div class="sourceCode" id="cb242"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb242-1"><a href="BayesReg2.html#cb242-1" aria-hidden="true" tabindex="-1"></a>beta <span class="ot">&lt;-</span> <span class="fu">data.matrix</span>(s2[,<span class="fu">c</span>(<span class="st">&quot;b_Intercept&quot;</span>,<span class="st">&quot;b_FemaleSex&quot;</span>,<span class="st">&quot;b_PrevFall&quot;</span>)])</span>
<span id="cb242-2"><a href="BayesReg2.html#cb242-2" aria-hidden="true" tabindex="-1"></a><span class="fu">t</span>(<span class="fu">apply</span>(<span class="fu">exp</span>(beta),<span class="dv">2</span>,my.summary))</span></code></pre></div>
<pre><code>##             Mean Median low.2.5% high.97.5%
## b_Intercept 0.47   0.46     0.27       0.73
## b_FemaleSex 0.66   0.63     0.36       1.09
## b_PrevFall  2.61   2.53     1.52       4.20</code></pre>
<ul>
<li>predicting the expected fall rates per year for the four types of subjects defined by sex and previous fall</li>
</ul>
<div class="sourceCode" id="cb244"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb244-1"><a href="BayesReg2.html#cb244-1" aria-hidden="true" tabindex="-1"></a><span class="co"># design matrix!</span></span>
<span id="cb244-2"><a href="BayesReg2.html#cb244-2" aria-hidden="true" tabindex="-1"></a>X<span class="ot">&lt;-</span><span class="fu">cbind</span>(<span class="at">MaleNoFall=</span><span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">0</span>,<span class="dv">0</span>),</span>
<span id="cb244-3"><a href="BayesReg2.html#cb244-3" aria-hidden="true" tabindex="-1"></a>         <span class="at">FemaleNoFall=</span><span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">0</span>),</span>
<span id="cb244-4"><a href="BayesReg2.html#cb244-4" aria-hidden="true" tabindex="-1"></a>         <span class="at">MalePrevFall=</span><span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">0</span>,<span class="dv">1</span>),</span>
<span id="cb244-5"><a href="BayesReg2.html#cb244-5" aria-hidden="true" tabindex="-1"></a>         <span class="at">FemalePrevFall=</span><span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">1</span>))</span>
<span id="cb244-6"><a href="BayesReg2.html#cb244-6" aria-hidden="true" tabindex="-1"></a><span class="fu">row.names</span>(X) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;Intercept&quot;</span>,<span class="st">&quot;Female&quot;</span>,<span class="st">&quot;PrevFall&quot;</span>)</span>
<span id="cb244-7"><a href="BayesReg2.html#cb244-7" aria-hidden="true" tabindex="-1"></a>Predictions <span class="ot">&lt;-</span> <span class="fu">exp</span>(beta <span class="sc">%*%</span> X)</span>
<span id="cb244-8"><a href="BayesReg2.html#cb244-8" aria-hidden="true" tabindex="-1"></a><span class="fu">t</span>(<span class="fu">apply</span>(Predictions,<span class="dv">2</span>,my.summary))</span></code></pre></div>
<pre><code>##                Mean Median low.2.5% high.97.5%
## MaleNoFall     0.47   0.46     0.27       0.73
## FemaleNoFall   0.30   0.29     0.16       0.49
## MalePrevFall   1.20   1.16     0.66       1.94
## FemalePrevFall 0.76   0.74     0.39       1.29</code></pre>
<p><strong>Model 3. Negative Binomial Model</strong></p>
<ul>
<li><p>A random variable Y is overdispersed if the observed variability in Y exceeds the variability expected by the assumed probability model of Y</p></li>
<li><p>Consider a negative regression model on <span class="math inline">\(Y\)</span> with covariates <span class="math inline">\(X_1, \ldots, X_p\)</span> and offset <span class="math inline">\(T\)</span> (time), we have</p></li>
</ul>
<p><span class="math display">\[ Y_i \mid \beta_0, \beta_1, \ldots, \beta_p, \mu_i, \gamma \sim NegBin(\mu_i, r)\]</span></p>
<p><span class="math display">\[ \log(\mu_i) =  \beta_0 + \beta_1 X_{i1} + \ldots + \beta_p X_{ip}\]</span></p>
<ul>
<li><p>The mean and variance are not equal!
<span class="math display">\[E(Y_i \mid \mu_i, \gamma) = \mu_i \text{ and } Var(Y_i \mid \mu_i, \gamma) = \mu_i + \frac{\mu_i^2}{\gamma}\]</span></p></li>
<li><p>Comparisons to the Poisson model</p>
<ul>
<li>For a large dispersion parameter <span class="math inline">\(\gamma\)</span>, <span class="math inline">\(E(Y)\approx Var(Y)\)</span> and this model will approximate a Poisson model.</li>
<li>For a small dispersion parameter <span class="math inline">\(\gamma\)</span>, <span class="math inline">\(E(Y) &lt; Var(Y)\)</span> and <span class="math inline">\(Y\)</span> is <strong>overdispersed</strong>.</li>
</ul></li>
</ul>
<div class="sourceCode" id="cb246"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb246-1"><a href="BayesReg2.html#cb246-1" aria-hidden="true" tabindex="-1"></a>model3 <span class="ot">&lt;-</span> <span class="fu">brm</span>(falls <span class="sc">~</span> FemaleSex <span class="sc">+</span> PrevFall <span class="sc">+</span> <span class="fu">offset</span>(<span class="fu">log</span>(fu)),</span>
<span id="cb246-2"><a href="BayesReg2.html#cb246-2" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> dat, </span>
<span id="cb246-3"><a href="BayesReg2.html#cb246-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">family =</span> <span class="st">&quot;negbinomial&quot;</span>,</span>
<span id="cb246-4"><a href="BayesReg2.html#cb246-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">sample_prior=</span>T,</span>
<span id="cb246-5"><a href="BayesReg2.html#cb246-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">prior =</span> <span class="fu">c</span>(<span class="fu">prior</span>(<span class="fu">normal</span>(<span class="dv">0</span>, <span class="dv">100</span>), <span class="at">class =</span> <span class="st">&quot;Intercept&quot;</span>),</span>
<span id="cb246-6"><a href="BayesReg2.html#cb246-6" aria-hidden="true" tabindex="-1"></a>              <span class="fu">prior</span>(<span class="fu">normal</span>(<span class="dv">0</span>, <span class="fl">0.56</span>), <span class="at">class =</span> <span class="st">&quot;b&quot;</span>, <span class="at">coef=</span>FemaleSex),</span>
<span id="cb246-7"><a href="BayesReg2.html#cb246-7" aria-hidden="true" tabindex="-1"></a>              <span class="fu">prior</span>(<span class="fu">normal</span>(<span class="fl">0.55</span>, <span class="fl">0.43</span>), <span class="at">class =</span> <span class="st">&quot;b&quot;</span>, <span class="at">coef=</span>PrevFall)),</span>
<span id="cb246-8"><a href="BayesReg2.html#cb246-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">chains =</span> <span class="dv">4</span>, </span>
<span id="cb246-9"><a href="BayesReg2.html#cb246-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">iter =</span> <span class="dv">7500</span>, </span>
<span id="cb246-10"><a href="BayesReg2.html#cb246-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">warmup =</span> <span class="dv">5000</span>, </span>
<span id="cb246-11"><a href="BayesReg2.html#cb246-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">cores =</span> <span class="dv">4</span>,</span>
<span id="cb246-12"><a href="BayesReg2.html#cb246-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">seed =</span> <span class="dv">123</span>, </span>
<span id="cb246-13"><a href="BayesReg2.html#cb246-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">silent =</span> <span class="dv">2</span>,</span>
<span id="cb246-14"><a href="BayesReg2.html#cb246-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">refresh =</span> <span class="dv">0</span>)</span>
<span id="cb246-15"><a href="BayesReg2.html#cb246-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb246-16"><a href="BayesReg2.html#cb246-16" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(model3, <span class="st">&quot;data/chap8_poisson_3&quot;</span>)</span></code></pre></div>
<ul>
<li>Posterior summary</li>
</ul>
<div class="sourceCode" id="cb247"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb247-1"><a href="BayesReg2.html#cb247-1" aria-hidden="true" tabindex="-1"></a>model3 <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">&quot;data/chap8_poisson_3&quot;</span>)</span>
<span id="cb247-2"><a href="BayesReg2.html#cb247-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(model3)</span></code></pre></div>
<p><img src="bayes_bookdown_files/figure-html/unnamed-chunk-186-1.png" width="672" style="display: block; margin: auto;" /></p>
<div class="sourceCode" id="cb248"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb248-1"><a href="BayesReg2.html#cb248-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(model3)</span></code></pre></div>
<pre><code>##  Family: negbinomial 
##   Links: mu = log; shape = identity 
## Formula: falls ~ FemaleSex + PrevFall + offset(log(fu)) 
##    Data: dat (Number of observations: 162) 
##   Draws: 4 chains, each with iter = 7500; warmup = 5000; thin = 1;
##          total post-warmup draws = 10000
## 
## Population-Level Effects: 
##           Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
## Intercept     0.23      0.21    -0.19     0.65 1.00    10442     7628
## FemaleSex    -0.37      0.27    -0.91     0.18 1.00    10039     7907
## PrevFall      0.91      0.25     0.42     1.39 1.00    11198     8023
## 
## Family Specific Parameters: 
##       Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
## shape     0.39      0.07     0.27     0.56 1.00    10233     7856
## 
## Draws were sampled using sampling(NUTS). For each parameter, Bulk_ESS
## and Tail_ESS are effective sample size measures, and Rhat is the potential
## scale reduction factor on split chains (at convergence, Rhat = 1).</code></pre>
<ul>
<li>Comparing prior and posterior</li>
</ul>
<p><img src="bayes_bookdown_files/figure-html/unnamed-chunk-187-1.png" width="864" style="display: block; margin: auto;" /></p>
<ul>
<li>We are interested in computing the posterior distributions for the rate ratios</li>
</ul>
<div class="sourceCode" id="cb250"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb250-1"><a href="BayesReg2.html#cb250-1" aria-hidden="true" tabindex="-1"></a>beta <span class="ot">&lt;-</span> <span class="fu">data.matrix</span>(s3[,<span class="fu">c</span>(<span class="st">&quot;b_Intercept&quot;</span>,<span class="st">&quot;b_FemaleSex&quot;</span>,<span class="st">&quot;b_PrevFall&quot;</span>)])</span>
<span id="cb250-2"><a href="BayesReg2.html#cb250-2" aria-hidden="true" tabindex="-1"></a><span class="fu">t</span>(<span class="fu">apply</span>(<span class="fu">exp</span>(beta),<span class="dv">2</span>,my.summary))</span></code></pre></div>
<pre><code>##             Mean Median low.2.5% high.97.5%
## b_Intercept 1.29   1.26     0.83       1.91
## b_FemaleSex 0.72   0.69     0.40       1.19
## b_PrevFall  2.56   2.49     1.53       4.02</code></pre>
<ul>
<li>suppose we are interested in predicting fall rates per year for the four types of subjects defined by sex and previous fall</li>
</ul>
<div class="sourceCode" id="cb252"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb252-1"><a href="BayesReg2.html#cb252-1" aria-hidden="true" tabindex="-1"></a>Predictions <span class="ot">&lt;-</span> <span class="fu">exp</span>(beta <span class="sc">%*%</span> X)</span>
<span id="cb252-2"><a href="BayesReg2.html#cb252-2" aria-hidden="true" tabindex="-1"></a><span class="fu">t</span>(<span class="fu">apply</span>(Predictions,<span class="dv">2</span>,my.summary))</span></code></pre></div>
<pre><code>##                Mean Median low.2.5% high.97.5%
## MaleNoFall     1.29   1.26     0.83       1.91
## FemaleNoFall   0.90   0.87     0.55       1.42
## MalePrevFall   3.21   3.11     2.03       4.91
## FemalePrevFall 2.25   2.15     1.27       3.81</code></pre>
<p><strong>Model 4. Expanding with zero-inflation</strong></p>
<ul>
<li>Often, excessive numbers of zero counts are a problem (e.g., healthy individuals have no events and less healthy individuals can have many events)</li>
<li>The Poisson distribution with mean <span class="math inline">\(\theta\)</span> has this probability of zero events:</li>
</ul>
<p><span class="math display">\[P(Y=0 \mid \theta) = \frac{\theta^0 \exp(-\theta)}{0!} = \exp(-\theta)\]</span></p>
<ul>
<li><p>e.g., if the mean is 5, <span class="math inline">\(P(Y=0) = 0.67\%\)</span></p></li>
<li><p>In a sample where a lot of people have high counts, so the mean is high, zeroes are unlikely</p></li>
<li><p>One solution is to fit a zero-inflated Poisson</p></li>
<li><p>It has two parts (“mixture model”)</p>
<ul>
<li>One regression fits a probability that <span class="math inline">\(\lambda_i = 0\)</span> (explains some of the zeroes)</li>
<li>A simultaneous regression fits the observed count (explains some of the zeroes)</li>
</ul></li>
<li><p>The model says that some subjects have a true zero rate - one set of predictors is used for this</p></li>
<li><p>Among subjects with a non-zero rate, the observations are Poisson</p></li>
<li><p>To model this we need a new Bernoulli variable <span class="math inline">\(z\)</span>, <span class="math inline">\(z\)</span> tells us which group (reg 1 for <span class="math inline">\(\lambda_i = 0\)</span> or reg 2 for the observed counts) the observation is in: 0 or 1</p>
<ol style="list-style-type: decimal">
<li><span class="math inline">\(z=0 \rightarrow \theta = z \times \lambda \times T = 0\)</span> (never have a fall, <em>structural zeros</em>)</li>
<li><span class="math inline">\(z=1 \rightarrow \theta = z \times \lambda \times T\)</span> (fall with rate <span class="math inline">\(\lambda\)</span>)</li>
</ol></li>
<li><p>The probability that <span class="math inline">\(z\)</span> is 0 is governed by a separate logistic model for <span class="math inline">\(z\)</span>, which does not have to include all the same predictors for example previous fall in the fall example</p></li>
</ul>
<p><span class="math display">\[Zero_i \sim dbern(p_i)\]</span>
<span class="math display">\[logit(p_i) = \alpha_0 + \alpha_1 \times PrevFall_i\]</span></p>
<div class="sourceCode" id="cb254"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb254-1"><a href="BayesReg2.html#cb254-1" aria-hidden="true" tabindex="-1"></a>model4 <span class="ot">&lt;-</span> <span class="fu">brm</span>(<span class="fu">bf</span>(falls <span class="sc">~</span> FemaleSex <span class="sc">+</span> PrevFall <span class="sc">+</span> <span class="fu">offset</span>(<span class="fu">log</span>(fu)),</span>
<span id="cb254-2"><a href="BayesReg2.html#cb254-2" aria-hidden="true" tabindex="-1"></a>                 zi <span class="sc">~</span> PrevFall), <span class="co">#being a non-faller</span></span>
<span id="cb254-3"><a href="BayesReg2.html#cb254-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> dat, </span>
<span id="cb254-4"><a href="BayesReg2.html#cb254-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">family =</span> <span class="fu">zero_inflated_poisson</span>(<span class="at">link_zi=</span><span class="st">&quot;logit&quot;</span>),,</span>
<span id="cb254-5"><a href="BayesReg2.html#cb254-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">sample_prior=</span>T,</span>
<span id="cb254-6"><a href="BayesReg2.html#cb254-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">prior =</span> <span class="fu">c</span>(<span class="fu">prior</span>(<span class="fu">normal</span>(<span class="dv">0</span>, <span class="dv">100</span>), <span class="at">class =</span> <span class="st">&quot;Intercept&quot;</span>),</span>
<span id="cb254-7"><a href="BayesReg2.html#cb254-7" aria-hidden="true" tabindex="-1"></a>              <span class="fu">prior</span>(<span class="fu">normal</span>(<span class="dv">0</span>, <span class="fl">0.56</span>), <span class="at">class =</span> <span class="st">&quot;b&quot;</span>, <span class="at">coef=</span>FemaleSex),</span>
<span id="cb254-8"><a href="BayesReg2.html#cb254-8" aria-hidden="true" tabindex="-1"></a>              <span class="fu">prior</span>(<span class="fu">normal</span>(<span class="fl">0.55</span>, <span class="fl">0.43</span>), <span class="at">class =</span> <span class="st">&quot;b&quot;</span>, <span class="at">coef=</span>PrevFall)),</span>
<span id="cb254-9"><a href="BayesReg2.html#cb254-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">chains =</span> <span class="dv">4</span>, </span>
<span id="cb254-10"><a href="BayesReg2.html#cb254-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">iter =</span> <span class="dv">7500</span>, </span>
<span id="cb254-11"><a href="BayesReg2.html#cb254-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">warmup =</span> <span class="dv">5000</span>, </span>
<span id="cb254-12"><a href="BayesReg2.html#cb254-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">cores =</span> <span class="dv">4</span>,</span>
<span id="cb254-13"><a href="BayesReg2.html#cb254-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">seed =</span> <span class="dv">123</span>, </span>
<span id="cb254-14"><a href="BayesReg2.html#cb254-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">silent =</span> <span class="dv">2</span>,</span>
<span id="cb254-15"><a href="BayesReg2.html#cb254-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">refresh =</span> <span class="dv">0</span>)</span>
<span id="cb254-16"><a href="BayesReg2.html#cb254-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb254-17"><a href="BayesReg2.html#cb254-17" aria-hidden="true" tabindex="-1"></a><span class="co"># saveRDS(model4, &quot;data/chap8_poisson_4&quot;)</span></span></code></pre></div>
<ul>
<li>Posterior summary</li>
</ul>
<div class="sourceCode" id="cb255"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb255-1"><a href="BayesReg2.html#cb255-1" aria-hidden="true" tabindex="-1"></a>model4 <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">&quot;data/chap8_poisson_4&quot;</span>)</span>
<span id="cb255-2"><a href="BayesReg2.html#cb255-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(model4)</span></code></pre></div>
<p><img src="bayes_bookdown_files/figure-html/unnamed-chunk-191-1.png" width="672" style="display: block; margin: auto;" /></p>
<div class="sourceCode" id="cb256"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb256-1"><a href="BayesReg2.html#cb256-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(model4)</span></code></pre></div>
<pre><code>##  Family: zero_inflated_poisson 
##   Links: mu = log; zi = logit 
## Formula: falls ~ FemaleSex + PrevFall + offset(log(fu)) 
##          zi ~ PrevFall
##    Data: dat (Number of observations: 162) 
##   Draws: 4 chains, each with iter = 7500; warmup = 5000; thin = 1;
##          total post-warmup draws = 10000
## 
## Population-Level Effects: 
##              Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
## Intercept        1.00      0.12     0.75     1.22 1.00     9383     7367
## zi_Intercept     0.33      0.23    -0.13     0.78 1.00    10781     7337
## FemaleSex       -0.36      0.15    -0.66    -0.07 1.00    10093     7028
## PrevFall         0.68      0.14     0.41     0.96 1.00     9006     7111
## zi_PrevFall     -0.95      0.39    -1.72    -0.19 1.00    11633     6932
## 
## Draws were sampled using sampling(NUTS). For each parameter, Bulk_ESS
## and Tail_ESS are effective sample size measures, and Rhat is the potential
## scale reduction factor on split chains (at convergence, Rhat = 1).</code></pre>
<ul>
<li>Comparing prior and posterior</li>
</ul>
<p><img src="bayes_bookdown_files/figure-html/unnamed-chunk-192-1.png" width="864" style="display: block; margin: auto;" /></p>
<ul>
<li>Computing the posterior distributions for the rate ratios</li>
</ul>
<div class="sourceCode" id="cb258"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb258-1"><a href="BayesReg2.html#cb258-1" aria-hidden="true" tabindex="-1"></a>beta4 <span class="ot">&lt;-</span> <span class="fu">data.matrix</span>(s4[,<span class="fu">c</span>(<span class="st">&quot;b_Intercept&quot;</span>,<span class="st">&quot;b_FemaleSex&quot;</span>,<span class="st">&quot;b_PrevFall&quot;</span>,<span class="st">&quot;b_zi_PrevFall&quot;</span>)])</span>
<span id="cb258-2"><a href="BayesReg2.html#cb258-2" aria-hidden="true" tabindex="-1"></a><span class="fu">t</span>(<span class="fu">apply</span>(<span class="fu">exp</span>(beta4),<span class="dv">2</span>,my.summary))</span></code></pre></div>
<pre><code>##               Mean Median low.2.5% high.97.5%
## b_Intercept   2.73   2.72     2.13       3.40
## b_FemaleSex   0.71   0.70     0.52       0.93
## b_PrevFall    2.00   1.98     1.51       2.61
## b_zi_PrevFall 0.42   0.39     0.18       0.83</code></pre>
<ul>
<li>Predicting fall rates per year for the four types of subjects defined by sex and previous fall</li>
</ul>
<div class="sourceCode" id="cb260"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb260-1"><a href="BayesReg2.html#cb260-1" aria-hidden="true" tabindex="-1"></a>Z <span class="ot">&lt;-</span> s4[,<span class="fu">c</span>(<span class="st">&quot;b_zi_Intercept&quot;</span>,<span class="st">&quot;b_zi_PrevFall&quot;</span> )]</span>
<span id="cb260-2"><a href="BayesReg2.html#cb260-2" aria-hidden="true" tabindex="-1"></a>C <span class="ot">&lt;-</span> s4[,<span class="fu">c</span>(<span class="st">&quot;b_Intercept&quot;</span>,<span class="st">&quot;b_FemaleSex&quot;</span>,<span class="st">&quot;b_PrevFall&quot;</span>)]</span>
<span id="cb260-3"><a href="BayesReg2.html#cb260-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb260-4"><a href="BayesReg2.html#cb260-4" aria-hidden="true" tabindex="-1"></a><span class="co"># create a dataset with the 4 categories of patient and one year of follow-up</span></span>
<span id="cb260-5"><a href="BayesReg2.html#cb260-5" aria-hidden="true" tabindex="-1"></a>nd <span class="ot">&lt;-</span> <span class="fu">cbind</span>(<span class="fu">expand.grid</span>(<span class="at">PrevFall=</span><span class="dv">0</span><span class="sc">:</span><span class="dv">1</span>,</span>
<span id="cb260-6"><a href="BayesReg2.html#cb260-6" aria-hidden="true" tabindex="-1"></a>                        <span class="at">FemaleSex=</span><span class="dv">0</span><span class="sc">:</span><span class="dv">1</span>),</span>
<span id="cb260-7"><a href="BayesReg2.html#cb260-7" aria-hidden="true" tabindex="-1"></a>            <span class="at">fu=</span><span class="dv">1</span>,</span>
<span id="cb260-8"><a href="BayesReg2.html#cb260-8" aria-hidden="true" tabindex="-1"></a>            <span class="at">Subject=</span><span class="dv">999</span>)</span>
<span id="cb260-9"><a href="BayesReg2.html#cb260-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb260-10"><a href="BayesReg2.html#cb260-10" aria-hidden="true" tabindex="-1"></a><span class="co"># probabilities of zero counts for the falls and no-falls groups </span></span>
<span id="cb260-11"><a href="BayesReg2.html#cb260-11" aria-hidden="true" tabindex="-1"></a><span class="co"># irrespective of sex</span></span>
<span id="cb260-12"><a href="BayesReg2.html#cb260-12" aria-hidden="true" tabindex="-1"></a>Pr0. <span class="ot">&lt;-</span> <span class="fu">plogis</span>(Z[,<span class="st">&quot;b_zi_Intercept&quot;</span>])</span>
<span id="cb260-13"><a href="BayesReg2.html#cb260-13" aria-hidden="true" tabindex="-1"></a>Pr1. <span class="ot">&lt;-</span> <span class="fu">plogis</span>(Z[,<span class="st">&quot;b_zi_Intercept&quot;</span>] <span class="sc">+</span> Z[,<span class="st">&quot;b_zi_PrevFall&quot;</span>])</span>
<span id="cb260-14"><a href="BayesReg2.html#cb260-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb260-15"><a href="BayesReg2.html#cb260-15" aria-hidden="true" tabindex="-1"></a><span class="co"># (ij) = (prevfall, sex)</span></span>
<span id="cb260-16"><a href="BayesReg2.html#cb260-16" aria-hidden="true" tabindex="-1"></a>C00 <span class="ot">&lt;-</span> <span class="fu">exp</span>(C[,<span class="st">&quot;b_Intercept&quot;</span>])</span>
<span id="cb260-17"><a href="BayesReg2.html#cb260-17" aria-hidden="true" tabindex="-1"></a>C10 <span class="ot">&lt;-</span> <span class="fu">exp</span>(C[,<span class="st">&quot;b_Intercept&quot;</span>] <span class="sc">+</span> C[,<span class="st">&quot;b_PrevFall&quot;</span>])</span>
<span id="cb260-18"><a href="BayesReg2.html#cb260-18" aria-hidden="true" tabindex="-1"></a>C01 <span class="ot">&lt;-</span> <span class="fu">exp</span>(C[,<span class="st">&quot;b_Intercept&quot;</span>] <span class="sc">+</span> C[,<span class="st">&quot;b_FemaleSex&quot;</span>])</span>
<span id="cb260-19"><a href="BayesReg2.html#cb260-19" aria-hidden="true" tabindex="-1"></a>C11 <span class="ot">&lt;-</span> <span class="fu">exp</span>(C[,<span class="st">&quot;b_Intercept&quot;</span>] <span class="sc">+</span> C[,<span class="st">&quot;b_FemaleSex&quot;</span>] <span class="sc">+</span> C[,<span class="st">&quot;b_PrevFall&quot;</span>])</span>
<span id="cb260-20"><a href="BayesReg2.html#cb260-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb260-21"><a href="BayesReg2.html#cb260-21" aria-hidden="true" tabindex="-1"></a><span class="co"># probability of a fall * mean, if male and a previous non-faller</span></span>
<span id="cb260-22"><a href="BayesReg2.html#cb260-22" aria-hidden="true" tabindex="-1"></a>M00 <span class="ot">&lt;-</span> (<span class="dv">1</span><span class="sc">-</span>Pr0.) <span class="sc">*</span> C00  </span>
<span id="cb260-23"><a href="BayesReg2.html#cb260-23" aria-hidden="true" tabindex="-1"></a><span class="co"># probability of a fall * mean, if male and a previous faller</span></span>
<span id="cb260-24"><a href="BayesReg2.html#cb260-24" aria-hidden="true" tabindex="-1"></a>M10 <span class="ot">&lt;-</span> (<span class="dv">1</span><span class="sc">-</span>Pr1.) <span class="sc">*</span> C10  </span>
<span id="cb260-25"><a href="BayesReg2.html#cb260-25" aria-hidden="true" tabindex="-1"></a><span class="co"># probability of a fall * mean, if female and a previous non-faller</span></span>
<span id="cb260-26"><a href="BayesReg2.html#cb260-26" aria-hidden="true" tabindex="-1"></a>M01 <span class="ot">&lt;-</span> (<span class="dv">1</span><span class="sc">-</span>Pr0.)<span class="sc">*</span>C01 </span>
<span id="cb260-27"><a href="BayesReg2.html#cb260-27" aria-hidden="true" tabindex="-1"></a><span class="co"># probability of a fall * mean, if female and a previous faller</span></span>
<span id="cb260-28"><a href="BayesReg2.html#cb260-28" aria-hidden="true" tabindex="-1"></a>M11 <span class="ot">&lt;-</span> (<span class="dv">1</span><span class="sc">-</span>Pr1.)<span class="sc">*</span>C11</span>
<span id="cb260-29"><a href="BayesReg2.html#cb260-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb260-30"><a href="BayesReg2.html#cb260-30" aria-hidden="true" tabindex="-1"></a><span class="co"># mean (expected) numbers of falls</span></span>
<span id="cb260-31"><a href="BayesReg2.html#cb260-31" aria-hidden="true" tabindex="-1"></a><span class="fu">round</span>(<span class="fu">rbind</span>(<span class="st">&quot;No fall/male&quot;</span><span class="ot">=</span><span class="fu">my.summary</span>(M00),</span>
<span id="cb260-32"><a href="BayesReg2.html#cb260-32" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;Fall/male&quot;</span><span class="ot">=</span><span class="fu">my.summary</span>(M10),</span>
<span id="cb260-33"><a href="BayesReg2.html#cb260-33" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;No fall female&quot;</span><span class="ot">=</span><span class="fu">my.summary</span>(M01),</span>
<span id="cb260-34"><a href="BayesReg2.html#cb260-34" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;Fall/female&quot;</span><span class="ot">=</span><span class="fu">my.summary</span>(M11)),<span class="dv">2</span>)</span></code></pre></div>
<pre><code>##                Mean Median low.2.5% high.97.5%
## No fall/male   1.14   1.13     0.82       1.52
## Fall/male      3.49   3.47     2.59       4.46
## No fall female 0.80   0.79     0.54       1.11
## Fall/female    2.45   2.42     1.72       3.29</code></pre>
<ul>
<li>Summarizing the observed rates by previous fall and sex from the data</li>
</ul>
<div class="sourceCode" id="cb262"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb262-1"><a href="BayesReg2.html#cb262-1" aria-hidden="true" tabindex="-1"></a>group.by <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">PrevFall=</span>dat<span class="sc">$</span>PrevFall,</span>
<span id="cb262-2"><a href="BayesReg2.html#cb262-2" aria-hidden="true" tabindex="-1"></a>                 <span class="at">FemaleSex=</span>dat<span class="sc">$</span>FemaleSex)</span>
<span id="cb262-3"><a href="BayesReg2.html#cb262-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb262-4"><a href="BayesReg2.html#cb262-4" aria-hidden="true" tabindex="-1"></a>FU <span class="ot">&lt;-</span> <span class="fu">aggregate</span>(<span class="at">x =</span> dat<span class="sc">$</span>fu, group.by,  sum)</span>
<span id="cb262-5"><a href="BayesReg2.html#cb262-5" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(FU)[<span class="fu">names</span>(FU)<span class="sc">==</span><span class="st">&quot;x&quot;</span>] <span class="ot">&lt;-</span> <span class="st">&quot;FU&quot;</span></span>
<span id="cb262-6"><a href="BayesReg2.html#cb262-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb262-7"><a href="BayesReg2.html#cb262-7" aria-hidden="true" tabindex="-1"></a>FALLS <span class="ot">&lt;-</span> <span class="fu">aggregate</span>(dat<span class="sc">$</span>falls,group.by,sum)</span>
<span id="cb262-8"><a href="BayesReg2.html#cb262-8" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(FALLS)[<span class="fu">names</span>(FALLS)<span class="sc">==</span><span class="st">&quot;x&quot;</span>] <span class="ot">&lt;-</span> <span class="st">&quot;Falls&quot;</span></span>
<span id="cb262-9"><a href="BayesReg2.html#cb262-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb262-10"><a href="BayesReg2.html#cb262-10" aria-hidden="true" tabindex="-1"></a>N <span class="ot">&lt;-</span> <span class="fu">aggregate</span>(dat<span class="sc">$</span>falls,group.by,length)</span>
<span id="cb262-11"><a href="BayesReg2.html#cb262-11" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(N)[<span class="fu">names</span>(N)<span class="sc">==</span><span class="st">&quot;x&quot;</span>] <span class="ot">&lt;-</span> <span class="st">&quot;N&quot;</span></span>
<span id="cb262-12"><a href="BayesReg2.html#cb262-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb262-13"><a href="BayesReg2.html#cb262-13" aria-hidden="true" tabindex="-1"></a>temp <span class="ot">&lt;-</span>   <span class="fu">merge</span>(FU,FALLS, </span>
<span id="cb262-14"><a href="BayesReg2.html#cb262-14" aria-hidden="true" tabindex="-1"></a>                <span class="at">by=</span><span class="fu">c</span>(<span class="st">&quot;PrevFall&quot;</span>,<span class="st">&quot;FemaleSex&quot;</span>))</span>
<span id="cb262-15"><a href="BayesReg2.html#cb262-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb262-16"><a href="BayesReg2.html#cb262-16" aria-hidden="true" tabindex="-1"></a>falls.aggregate <span class="ot">&lt;-</span> <span class="fu">merge</span>(temp,</span>
<span id="cb262-17"><a href="BayesReg2.html#cb262-17" aria-hidden="true" tabindex="-1"></a>                    N,</span>
<span id="cb262-18"><a href="BayesReg2.html#cb262-18" aria-hidden="true" tabindex="-1"></a>                  <span class="at">by=</span><span class="fu">c</span>(<span class="st">&quot;PrevFall&quot;</span>,<span class="st">&quot;FemaleSex&quot;</span>))</span>
<span id="cb262-19"><a href="BayesReg2.html#cb262-19" aria-hidden="true" tabindex="-1"></a>falls.aggregate<span class="sc">$</span>Obs <span class="ot">&lt;-</span> <span class="fu">round</span>(falls.aggregate<span class="sc">$</span>Falls<span class="sc">/</span>falls.aggregate<span class="sc">$</span>FU,<span class="dv">2</span>)</span>
<span id="cb262-20"><a href="BayesReg2.html#cb262-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb262-21"><a href="BayesReg2.html#cb262-21" aria-hidden="true" tabindex="-1"></a>falls.aggregate <span class="sc">%&gt;%</span></span>
<span id="cb262-22"><a href="BayesReg2.html#cb262-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">datatable</span>(</span>
<span id="cb262-23"><a href="BayesReg2.html#cb262-23" aria-hidden="true" tabindex="-1"></a>  <span class="at">rownames =</span> F,</span>
<span id="cb262-24"><a href="BayesReg2.html#cb262-24" aria-hidden="true" tabindex="-1"></a>  <span class="at">class =</span> <span class="st">&quot;compact&quot;</span>,</span>
<span id="cb262-25"><a href="BayesReg2.html#cb262-25" aria-hidden="true" tabindex="-1"></a>  <span class="at">options =</span> <span class="fu">list</span>(</span>
<span id="cb262-26"><a href="BayesReg2.html#cb262-26" aria-hidden="true" tabindex="-1"></a>    <span class="at">dom =</span> <span class="st">&#39;t&#39;</span>,</span>
<span id="cb262-27"><a href="BayesReg2.html#cb262-27" aria-hidden="true" tabindex="-1"></a>    <span class="at">ordering =</span> <span class="cn">FALSE</span>,</span>
<span id="cb262-28"><a href="BayesReg2.html#cb262-28" aria-hidden="true" tabindex="-1"></a>    <span class="at">paging =</span> <span class="cn">FALSE</span>,</span>
<span id="cb262-29"><a href="BayesReg2.html#cb262-29" aria-hidden="true" tabindex="-1"></a>    <span class="at">searching =</span> <span class="cn">FALSE</span>,</span>
<span id="cb262-30"><a href="BayesReg2.html#cb262-30" aria-hidden="true" tabindex="-1"></a>    <span class="at">columnDefs =</span> <span class="fu">list</span>(<span class="fu">list</span>(<span class="at">className =</span> <span class="st">&#39;dt-center&#39;</span>, </span>
<span id="cb262-31"><a href="BayesReg2.html#cb262-31" aria-hidden="true" tabindex="-1"></a>                      <span class="at">targets =</span> <span class="dv">0</span><span class="sc">:</span><span class="dv">5</span>))))</span></code></pre></div>
<div id="htmlwidget-a9939b1c45ceef5f407e" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-a9939b1c45ceef5f407e">{"x":{"filter":"none","vertical":false,"data":[[0,0,1,1],[0,1,0,1],[53.86027398,43.44383563,28.94520547,20.26027397],[57,38,119,36],[61,47,31,23],[1.06,0.87,4.11,1.78]],"container":"<table class=\"compact\">\n  <thead>\n    <tr>\n      <th>PrevFall<\/th>\n      <th>FemaleSex<\/th>\n      <th>FU<\/th>\n      <th>Falls<\/th>\n      <th>N<\/th>\n      <th>Obs<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"dom":"t","ordering":false,"paging":false,"searching":false,"columnDefs":[{"className":"dt-center","targets":[0,1,2,3,4,5]}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
<ul>
<li>Combining results from all four models</li>
</ul>
<ol style="list-style-type: decimal">
<li>Posterior summary</li>
</ol>
<table>
<thead>
<tr class="header">
<th>model</th>
<th>RR</th>
<th align="center">mean</th>
<th align="center">2.5%</th>
<th align="center">97.5%</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Poisson</td>
<td>female sex</td>
<td align="center">0.59</td>
<td align="center">0.45</td>
<td align="center">0.76</td>
</tr>
<tr class="even">
<td></td>
<td>prev fall</td>
<td align="center">3.01</td>
<td align="center">2.37</td>
<td align="center">3.86</td>
</tr>
<tr class="odd">
<td>Poisson/RE</td>
<td>female sex</td>
<td align="center">0.63</td>
<td align="center">0.36</td>
<td align="center">1.09</td>
</tr>
<tr class="even">
<td></td>
<td>prev fall</td>
<td align="center">2.53</td>
<td align="center">1.52</td>
<td align="center">4.20</td>
</tr>
<tr class="odd">
<td>NB</td>
<td>female sex</td>
<td align="center">0.72</td>
<td align="center">0.40</td>
<td align="center">1.19</td>
</tr>
<tr class="even">
<td></td>
<td>prevfall</td>
<td align="center">2.56</td>
<td align="center">1.53</td>
<td align="center">4.02</td>
</tr>
<tr class="odd">
<td>ZIP</td>
<td>RR:female sex</td>
<td align="center">0.71</td>
<td align="center">0.52</td>
<td align="center">0.93</td>
</tr>
<tr class="even">
<td></td>
<td>RR:prev fall</td>
<td align="center">2.00</td>
<td align="center">1.51</td>
<td align="center">2.61</td>
</tr>
<tr class="odd">
<td></td>
<td>OR(zero):prev fall</td>
<td align="center">0.42</td>
<td align="center">0.18</td>
<td align="center">0.83</td>
</tr>
</tbody>
</table>
<ol start="2" style="list-style-type: decimal">
<li>Posterior predictive summary</li>
</ol>
<div class="sourceCode" id="cb263"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb263-1"><a href="BayesReg2.html#cb263-1" aria-hidden="true" tabindex="-1"></a>PredictedRates <span class="ot">&lt;-</span> <span class="fu">cbind</span>(</span>
<span id="cb263-2"><a href="BayesReg2.html#cb263-2" aria-hidden="true" tabindex="-1"></a>      <span class="at">Pois=</span><span class="fu">predict</span>(model1, <span class="at">newdata=</span>nd)[,<span class="dv">1</span>],</span>
<span id="cb263-3"><a href="BayesReg2.html#cb263-3" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;P/RE&quot;</span><span class="ot">=</span><span class="fu">predict</span>(model2, <span class="at">newdata=</span>nd, </span>
<span id="cb263-4"><a href="BayesReg2.html#cb263-4" aria-hidden="true" tabindex="-1"></a>                        <span class="at">re_formula =</span> <span class="sc">~</span><span class="dv">1</span> <span class="sc">|</span> Subject, <span class="at">allow_new_levels=</span>T)[,<span class="dv">1</span>],</span>
<span id="cb263-5"><a href="BayesReg2.html#cb263-5" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;NB&quot;</span><span class="ot">=</span><span class="fu">predict</span>(model3, <span class="at">newdata=</span>nd)[,<span class="dv">1</span>],</span>
<span id="cb263-6"><a href="BayesReg2.html#cb263-6" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;ZIP&quot;</span><span class="ot">=</span><span class="fu">predict</span>(model4, <span class="at">newdata=</span>nd)[,<span class="dv">1</span>])</span>
<span id="cb263-7"><a href="BayesReg2.html#cb263-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb263-8"><a href="BayesReg2.html#cb263-8" aria-hidden="true" tabindex="-1"></a>PredictedRates <span class="ot">&lt;-</span> <span class="fu">cbind</span>(nd[,<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>],<span class="fu">round</span>(PredictedRates,<span class="dv">2</span>))</span>
<span id="cb263-9"><a href="BayesReg2.html#cb263-9" aria-hidden="true" tabindex="-1"></a>PredictedRates <span class="ot">&lt;-</span><span class="fu">merge</span>(falls.aggregate[,<span class="fu">c</span>(<span class="st">&quot;N&quot;</span>,<span class="st">&quot;Obs&quot;</span>,<span class="st">&quot;PrevFall&quot;</span>,<span class="st">&quot;FemaleSex&quot;</span>)], </span>
<span id="cb263-10"><a href="BayesReg2.html#cb263-10" aria-hidden="true" tabindex="-1"></a>      PredictedRates, <span class="at">by=</span><span class="fu">c</span>(<span class="st">&quot;PrevFall&quot;</span>,<span class="st">&quot;FemaleSex&quot;</span>))</span>
<span id="cb263-11"><a href="BayesReg2.html#cb263-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb263-12"><a href="BayesReg2.html#cb263-12" aria-hidden="true" tabindex="-1"></a>PredictedRates <span class="sc">%&gt;%</span></span>
<span id="cb263-13"><a href="BayesReg2.html#cb263-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">datatable</span>(</span>
<span id="cb263-14"><a href="BayesReg2.html#cb263-14" aria-hidden="true" tabindex="-1"></a>  <span class="at">rownames =</span> F,</span>
<span id="cb263-15"><a href="BayesReg2.html#cb263-15" aria-hidden="true" tabindex="-1"></a>  <span class="at">class =</span> <span class="st">&quot;compact&quot;</span>,</span>
<span id="cb263-16"><a href="BayesReg2.html#cb263-16" aria-hidden="true" tabindex="-1"></a>  <span class="at">options =</span> <span class="fu">list</span>(</span>
<span id="cb263-17"><a href="BayesReg2.html#cb263-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">dom =</span> <span class="st">&#39;t&#39;</span>,</span>
<span id="cb263-18"><a href="BayesReg2.html#cb263-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">ordering =</span> <span class="cn">FALSE</span>,</span>
<span id="cb263-19"><a href="BayesReg2.html#cb263-19" aria-hidden="true" tabindex="-1"></a>    <span class="at">paging =</span> <span class="cn">FALSE</span>,</span>
<span id="cb263-20"><a href="BayesReg2.html#cb263-20" aria-hidden="true" tabindex="-1"></a>    <span class="at">searching =</span> <span class="cn">FALSE</span>,</span>
<span id="cb263-21"><a href="BayesReg2.html#cb263-21" aria-hidden="true" tabindex="-1"></a>    <span class="at">columnDefs =</span> <span class="fu">list</span>(<span class="fu">list</span>(<span class="at">className =</span> <span class="st">&#39;dt-center&#39;</span>, </span>
<span id="cb263-22"><a href="BayesReg2.html#cb263-22" aria-hidden="true" tabindex="-1"></a>                      <span class="at">targets =</span> <span class="dv">0</span><span class="sc">:</span><span class="dv">7</span>))))</span></code></pre></div>
<div id="htmlwidget-6a1b2d3e3cffc605b5dc" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-6a1b2d3e3cffc605b5dc">{"x":{"filter":"none","vertical":false,"data":[[0,0,1,1],[0,1,0,1],[61,47,31,23],[1.06,0.87,4.11,1.78],[1.22,0.73,3.73,2.17],[1.28,0.8,3.28,2.09],[1.26,0.94,3.1,2.25],[1.13,0.81,3.5,2.47]],"container":"<table class=\"compact\">\n  <thead>\n    <tr>\n      <th>PrevFall<\/th>\n      <th>FemaleSex<\/th>\n      <th>N<\/th>\n      <th>Obs<\/th>\n      <th>Pois<\/th>\n      <th>P/RE<\/th>\n      <th>NB<\/th>\n      <th>ZIP<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"dom":"t","ordering":false,"paging":false,"searching":false,"columnDefs":[{"className":"dt-center","targets":[0,1,2,3,4,5,6,7]}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
<p><strong>Summary</strong></p>
<ul>
<li><p>RR are of similar size for each of the models</p></li>
<li><p>CrI are wider for all models that allow for extra-Poisson variation</p></li>
<li><p>In the ZIP model, being previous fall decreases the odds of being a non-faller (having a zero count)(OR=0.42)</p>
<ul>
<li>among the fallers, the effect of a previous fall (RR=2.0) is smaller than for the other models</li>
</ul></li>
</ul>
</div>
<div id="checking-and-comparing-models" class="section level3 hasAnchor" number="7.2.3">
<h3><span class="header-section-number">7.2.3</span> Checking and comparing models<a href="BayesReg2.html#checking-and-comparing-models" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<ul>
<li><p>Dose simple Poisson fit the count outcome?</p></li>
<li><p>Tukey Hanging Rootogram</p>
<ul>
<li>In this visualization the comparison is made easier by ‘hanging’ the observed results from the theoretical curve</li>
<li>As in the rootogram, the vertical axis is scaled to the square-root of the frequencies so as to draw attention to discrepancies in the tails of the distribution</li>
<li>installing the <code>vcd</code> package in R and using the following command to generate the Tukey Hanging Rootogram</li>
<li><strong>checking the excesses</strong> if it fits well there should be no bar hanging above or below line 0.</li>
<li>In this example, we have a few bars (for small number of falls: 1-5) hanging above and a few bars (number of falls 11+) hanging below. <strong>A single Poisson (intercept only) does not fit well</strong></li>
<li>This also indicates over-dispersion. However, we do not see major issue with excessive zeros (the first bar is not hanging above or below).</li>
</ul></li>
</ul>
<div class="sourceCode" id="cb264"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb264-1"><a href="BayesReg2.html#cb264-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(vcd)</span>
<span id="cb264-2"><a href="BayesReg2.html#cb264-2" aria-hidden="true" tabindex="-1"></a>fit1 <span class="ot">&lt;-</span> <span class="fu">goodfit</span>(dat<span class="sc">$</span>falls,<span class="st">&quot;poisson&quot;</span>)</span>
<span id="cb264-3"><a href="BayesReg2.html#cb264-3" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(fit1,<span class="at">xlab=</span><span class="st">&quot;Number of Falls&quot;</span>)</span></code></pre></div>
<p><img src="bayes_bookdown_files/figure-html/unnamed-chunk-197-1.png" width="864" /></p>
<ul>
<li>Comparing between the four models using loo</li>
</ul>
<div class="sourceCode" id="cb265"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb265-1"><a href="BayesReg2.html#cb265-1" aria-hidden="true" tabindex="-1"></a>loo1 <span class="ot">&lt;-</span> <span class="fu">loo</span>(model1)</span>
<span id="cb265-2"><a href="BayesReg2.html#cb265-2" aria-hidden="true" tabindex="-1"></a>loo2 <span class="ot">&lt;-</span> <span class="fu">loo</span>(model2) <span class="co">#best model</span></span>
<span id="cb265-3"><a href="BayesReg2.html#cb265-3" aria-hidden="true" tabindex="-1"></a>loo3 <span class="ot">&lt;-</span> <span class="fu">loo</span>(model3)</span>
<span id="cb265-4"><a href="BayesReg2.html#cb265-4" aria-hidden="true" tabindex="-1"></a>loo4 <span class="ot">&lt;-</span> <span class="fu">loo</span>(model4)</span>
<span id="cb265-5"><a href="BayesReg2.html#cb265-5" aria-hidden="true" tabindex="-1"></a><span class="fu">loo_compare</span>(loo1, loo2, loo3, loo4)</span></code></pre></div>
<pre><code>##        elpd_diff se_diff
## model2    0.0       0.0 
## model3  -28.3       7.3 
## model4 -127.5      53.6 
## model1 -189.2      71.1</code></pre>
<ul>
<li>visually checking posterior predictive fits</li>
</ul>
<div class="sourceCode" id="cb267"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb267-1"><a href="BayesReg2.html#cb267-1" aria-hidden="true" tabindex="-1"></a>p1<span class="ot">&lt;-</span><span class="fu">pp_check</span>(model1, <span class="at">ndraws =</span> <span class="dv">50</span>)</span>
<span id="cb267-2"><a href="BayesReg2.html#cb267-2" aria-hidden="true" tabindex="-1"></a>p2<span class="ot">&lt;-</span><span class="fu">pp_check</span>(model2, <span class="at">ndraws =</span> <span class="dv">50</span>)</span>
<span id="cb267-3"><a href="BayesReg2.html#cb267-3" aria-hidden="true" tabindex="-1"></a>p3<span class="ot">&lt;-</span><span class="fu">pp_check</span>(model3, <span class="at">ndraws =</span> <span class="dv">50</span>)</span>
<span id="cb267-4"><a href="BayesReg2.html#cb267-4" aria-hidden="true" tabindex="-1"></a>p4<span class="ot">&lt;-</span><span class="fu">pp_check</span>(model4, <span class="at">ndraws =</span> <span class="dv">50</span>)</span>
<span id="cb267-5"><a href="BayesReg2.html#cb267-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb267-6"><a href="BayesReg2.html#cb267-6" aria-hidden="true" tabindex="-1"></a><span class="fu">ggarrange</span>(p1,p2,p3,p4, <span class="at">nrow =</span> <span class="dv">2</span>, <span class="at">ncol=</span><span class="dv">2</span>)</span></code></pre></div>
<p><img src="bayes_bookdown_files/figure-html/unnamed-chunk-199-1.png" width="672" /></p>
<ul>
<li>Poisson model fits worst and ZIP is the second worst</li>
<li>Poisson/RE fits the best, by a substantial margin</li>
</ul>
<p><strong>Examine dispersion</strong>
- The Poisson random effects and negative binomial models have a parameter that
measures extra-Poisson variability
- In the Poisson/RE model, it is the standard deviation around the log-means
- In the NB model, it is the standard deviation between the rates, based on the
gamma distribution</p>
<ul>
<li>Both model tell us over-dispersion exists in this data</li>
</ul>
<div class="sourceCode" id="cb268"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb268-1"><a href="BayesReg2.html#cb268-1" aria-hidden="true" tabindex="-1"></a><span class="co">#Poisson random effect model</span></span>
<span id="cb268-2"><a href="BayesReg2.html#cb268-2" aria-hidden="true" tabindex="-1"></a>model2</span></code></pre></div>
<pre><code>##  Family: poisson 
##   Links: mu = log 
## Formula: falls ~ FemaleSex + PrevFall + offset(log(fu)) + (1 | Subject) 
##    Data: dat (Number of observations: 162) 
##   Draws: 4 chains, each with iter = 7500; warmup = 5000; thin = 1;
##          total post-warmup draws = 10000
## 
## Group-Level Effects: 
## ~Subject (Number of levels: 162) 
##               Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
## sd(Intercept)     1.47      0.17     1.18     1.83 1.00     3162     5040
## 
## Population-Level Effects: 
##           Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
## Intercept    -0.78      0.25    -1.31    -0.32 1.00     6717     7198
## FemaleSex    -0.46      0.28    -1.02     0.08 1.00     6607     7669
## PrevFall      0.93      0.26     0.42     1.43 1.00     6671     7458
## 
## Draws were sampled using sampling(NUTS). For each parameter, Bulk_ESS
## and Tail_ESS are effective sample size measures, and Rhat is the potential
## scale reduction factor on split chains (at convergence, Rhat = 1).</code></pre>
<div class="sourceCode" id="cb270"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb270-1"><a href="BayesReg2.html#cb270-1" aria-hidden="true" tabindex="-1"></a>model3</span></code></pre></div>
<pre><code>##  Family: negbinomial 
##   Links: mu = log; shape = identity 
## Formula: falls ~ FemaleSex + PrevFall + offset(log(fu)) 
##    Data: dat (Number of observations: 162) 
##   Draws: 4 chains, each with iter = 7500; warmup = 5000; thin = 1;
##          total post-warmup draws = 10000
## 
## Population-Level Effects: 
##           Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
## Intercept     0.23      0.21    -0.19     0.65 1.00    10442     7628
## FemaleSex    -0.37      0.27    -0.91     0.18 1.00    10039     7907
## PrevFall      0.91      0.25     0.42     1.39 1.00    11198     8023
## 
## Family Specific Parameters: 
##       Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
## shape     0.39      0.07     0.27     0.56 1.00    10233     7856
## 
## Draws were sampled using sampling(NUTS). For each parameter, Bulk_ESS
## and Tail_ESS are effective sample size measures, and Rhat is the potential
## scale reduction factor on split chains (at convergence, Rhat = 1).</code></pre>
<p><strong>Conclusions</strong></p>
<ul>
<li>The likelihood and starting point for modelling count data is usually the Poisson</li>
<li>It is often the case that the Poisson is too simple - can’t account for all the variability in counts</li>
<li>Negative binomial and normal random effects models allow additional variation in rates</li>
<li>ZIP models allow an excess of zeroes, possibly dependent on predictors</li>
<li>ZI NB models are also possible</li>
<li>Check model fits (wait, loo - can be technical problems with these)</li>
</ul>
</div>
<div id="r-session-information-6" class="section level3 unnumbered hasAnchor">
<h3>R Session information<a href="BayesReg2.html#r-session-information-6" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<pre><code>## R version 4.1.3 (2022-03-10)
## Platform: x86_64-w64-mingw32/x64 (64-bit)
## Running under: Windows 10 x64 (build 19044)
## 
## Matrix products: 
## 
## locale:
## [1] LC_COLLATE=English_Canada.1252  LC_CTYPE=English_Canada.1252   
## [3] LC_MONETARY=English_Canada.1252 LC_NUMERIC=C                   
## [5] LC_TIME=English_Canada.1252    
## 
## attached base packages:
## [1] grid      stats     graphics  grDevices utils     datasets  methods  
## [8] base     
## 
## other attached packages:
##  [1] vcd_1.4-9           tidybayes_3.0.2     DT_0.22            
##  [4] gtsummary_1.5.2     invgamma_1.1        extraDistr_1.9.1   
##  [7] MCMCpack_1.6-1      MASS_7.3-55         coda_0.19-4        
## [10] SHELF_1.8.0         bayesplot_1.9.0     ggmcmc_1.5.1.1     
## [13] tidyr_1.2.0         ggpubr_0.4.0        tweenr_1.0.2       
## [16] gganimate_1.0.7     VennDiagram_1.7.1   futile.logger_1.4.3
## [19] truncnorm_1.0-8     brms_2.16.3         Rcpp_1.0.8.3       
## [22] dplyr_1.0.8         ggplot2_3.3.5</code></pre>

</div>
</div>
</div>
<h3>References<a href="references.html#references" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<div id="refs" class="references csl-bib-body hanging-indent">
<div id="ref-bastos2020diagnostic" class="csl-entry">
Bastos, Mayara Lisboa, Gamuchirai Tavaziva, Syed Kunal Abidi, Jonathon R Campbell, Louis-Patrick Haraoui, James C Johnston, Zhiyi Lan, et al. 2020. <span>“Diagnostic Accuracy of Serological Tests for Covid-19: Systematic Review and Meta-Analysis.”</span> <em>Bmj</em> 370.
</div>
<div id="ref-cook2006falls" class="csl-entry">
Cook, Wendy L, George Tomlinson, Meghan Donaldson, Samuel N Markowitz, Gary Naglie, Boris Sobolev, and Sarbjit V Jassal. 2006. <span>“Falls and Fall-Related Injuries in Older Dialysis Patients.”</span> <em>Clinical Journal of the American Society of Nephrology</em> 1 (6): 1197–1204.
</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="BayesReg1.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="BayesMeta.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": false,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"whatsapp": false,
"all": "twitter"
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": null,
"text": null
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": null,
"search": {
"engine": "fuse",
"options": null
},
"toc": {
"collapse": "subsection",
"scroll_highlight": true
},
"toolbar": {
"position": "fixed"
},
"info": true
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
